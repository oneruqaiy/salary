<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>راتــب</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --main-blue:#3b6bff;
  --light-gray:#f5f5f5;
  --card-shadow:0 6px 18px rgba(0,0,128,0.08);
  --accent-text:#2c003e;
}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--light-gray);
  color: var(--accent-text);
}
#authContainer{
  max-width:400px;
  margin:100px auto;
  padding:20px;
  background:#fff;
  border-radius:16px;
  box-shadow:var(--card-shadow);
}
.btn-main{
  background: var(--main-blue);
  color:#fff;
  border:none;
}
.btn-main:hover{
  background:#5a82ff;
}
.card-royal{
  background:#fff;
  border:none;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:var(--card-shadow);
}
input:focus, .form-control:focus, select:focus{
  box-shadow:none;
  border-color: var(--main-blue);
}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.tabContent{display:none; padding-top:10px;}
.cards-grid{display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap;}
.card-grid-item{
  flex:1 1 45%;
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin:5px;
  text-align:center;
  cursor:pointer;
  box-shadow:var(--card-shadow);
  transition:0.2s;
}
.card-grid-item:hover{transform:translateY(-3px); box-shadow:0 10px 20px rgba(0,0,128,0.12);}
.category-name{font-weight:bold; line-height:38px;}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  border-top:1px solid #ddd;
  padding:8px 0;
  box-shadow:0 -2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.bottom-nav div{
  flex:1;
  text-align:center;
  cursor:pointer;
  font-size:14px;
  color:#333;
}
.bottom-nav .active{color:var(--main-blue); font-weight:bold;}
@media(min-width:768px){
  .cards-grid{flex-wrap:nowrap;}
  .card-grid-item{flex:1; margin:10px;}
}

/* حساباتي — بطاقات بنكية */
.accounts-grid{display:flex; gap:16px; flex-wrap:wrap;}
.bank-card{
  width:280px;
  height:160px;
  border-radius:14px;
  color:white;
  padding:14px;
  position:relative;
  box-shadow:0 6px 20px rgba(0,0,0,0.12);
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.bank-card .card-top{display:flex; justify-content:space-between; align-items:start;}
.bank-card .card-balance{font-size:20px; font-weight:700;}
.bank-card .card-name{font-size:14px;}
.bank-card .card-logo{width:52px; height:32px; opacity:0.95;}
.bank-actions{display:flex; gap:8px; margin-top:8px;}
.small-btn{padding:6px 8px; border-radius:8px; font-size:13px; border:none; cursor:pointer;}
.small-btn.primary{background:rgba(255,255,255,0.12); color:#fff;}
.small-btn.danger{background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.08);}

/* gradients */
.grad-blue{background:linear-gradient(135deg,#2b6df6,#4369ff);}
.grad-purple{background:linear-gradient(135deg,#7b61ff,#d66bff);}
.grad-gold{background:linear-gradient(135deg,#f59e0b,#f97316);}

/* responsive */
@media(max-width:540px){
  .bank-card{width:92%; height:150px;}
}
.expense-entry{
  display:flex;
  gap:5px;
  margin-bottom:5px;
}
.expense-entry input{
  flex:1;
}
.expense-actions{
  display:flex;
  gap:5px;
  margin-top:5px;
}
.expense-actions button{flex:1;}
.salary-card{
  display:flex;
  align-items:center;
  gap:10px;
  padding:10px;
  margin-bottom:10px;
  border-radius:12px;
  background:linear-gradient(135deg,#2b6df6,#4369ff);
  color:white;
}
.salary-card img{
  width:40px;
  height:40px;
}
</style>
</head>
<body>

<div id="authContainer"></div>

<div id="app" style="display:none; max-width:1000px; margin:0 auto; padding-bottom:120px;">
  <div id="welcomeUser" class="h5 mb-3 text-center"></div>

  <div id="dailyTab" class="tabContent"></div>
  <div id="weeklyTab" class="tabContent"></div>
  <div id="accountsTab" class="tabContent"></div>
  <div id="accountTab" class="tabContent"></div>

  <div class="bottom-nav">
    <div data-tab="daily" class="active">🏷️ المصاريف اليومية</div>
    <div data-tab="weekly">📊 التحليلات الأسبوعية</div>
    <div data-tab="accounts">💳 حساباتي</div>
    <div data-tab="account">⚙️ حسابك</div>
    <div onclick="logout()">🚪 خروج</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const authContainer=document.getElementById('authContainer');
const app=document.getElementById('app');
const welcomeUser=document.getElementById('welcomeUser');

// ACCOUNTS stored in localStorage
let accounts = JSON.parse(localStorage.getItem('cvm_accounts')) || [];

// ===== Login / Signup =====
function showLogin(){
  authContainer.innerHTML=`
    <input type="email" id="email" class="form-control mb-2" placeholder="البريد الإلكتروني">
    <input type="password" id="password" class="form-control mb-2" placeholder="كلمة المرور">
    <button class="btn btn-main w-100 mb-2" onclick="login()">تسجيل الدخول</button>
    <button class="btn btn-outline-primary w-100 mb-2" onclick="signupStep1()">إنشاء حساب</button>
    <button class="btn btn-outline-secondary w-100" onclick="googleLogin()">تسجيل بـ Google</button>
  `;
}
function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert(err.message));
}
function signupStep1(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,password).then(cred=>{
    db.collection('users').doc(cred.user.uid).set({
      categories:{}, dailyExpenses:[], salary:0, incomeSources:0, loans:0, lastSalaryDate:null, categoryAccounts:{}
    });
  }).catch(err=>alert(err.message));
}
function googleLogin(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}
function logout(){ auth.signOut(); }

// ===== Bottom Navigation =====
document.querySelectorAll('.bottom-nav div[data-tab]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
    document.getElementById(btn.dataset.tab+'Tab').style.display='block';
    document.querySelectorAll('.bottom-nav div').forEach(d=>d.classList.remove('active'));
    btn.classList.add('active');
    if(btn.dataset.tab==='accounts') renderAccounts();
  });
});

// ===== Load User Data =====
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display='none';
    app.style.display='block';
    welcomeUser.textContent=`أهلاً، ${user.email} 👋`;
    loadUserData(user.uid);
  } else{
    authContainer.style.display='block';
    app.style.display='none';
    showLogin();
  }
});

async function loadUserData(uid){
  const docSnap = await db.collection('users').doc(uid).get();
  if(!docSnap.exists){ alert("خطأ: البيانات غير موجودة"); return; }
  const data=docSnap.data();

  renderDailyTab(data, uid);
  renderWeeklyTab(data, uid);
  renderAccountTab(data, uid);
  renderAccounts();
  document.querySelector('.bottom-nav div[data-tab="daily"]').click();
}

// ===== Daily Tab =====
function renderDailyTab(data, uid){
  const container=document.getElementById('dailyTab');
  container.style.display='block';

  // زر اضافة راتب
  const salaryCard = `
    <div class="salary-card">
      <img src="https://upload.wikimedia.org/wikipedia/commons/5/52/Visa_2014_logo_detail.svg" alt="الحساب الرئيسي">
      <div>💰 إضافة راتب</div>
      <button class="btn btn-outline-light btn-sm ms-auto" onclick="addSalary(${uid})">➕ إضافة</button>
    </div>
  `;

  container.innerHTML=salaryCard+`
    <div class="card card-royal" style="max-width:720px; margin:auto;">
      <h5 class="mb-3 text-center">🏷️ تسجيل المصاريف اليومية</h5>
      <label>اختر التاريخ:</label>
      <input type="date" id="expenseDate" class="form-control mb-3" value="${new Date().toISOString().split('T')[0]}">
      <label>اختر القسم:</label>
      <select id="expenseCategory" class="form-select mb-2">
        ${Object.keys(data.categories).map(cat=>`<option value="${cat}">${cat}</option>`).join('')}
      </select>
      <input type="number" id="expenseAmount" class="form-control mb-2" placeholder="المبلغ">
      <input type="text" id="expenseDesc" class="form-control mb-2" placeholder="لِماذا تم الصرف؟">
      <button id="addExpenseBtn" class="btn btn-main w-100">حفظ المصروف</button>
      <h6 class="mt-3">المصاريف المسجلة:</h6>
      <div id="dailyExpensesList"></div>
    </div>
  `;

  const listDiv=document.getElementById('dailyExpensesList');

  function refreshList(){
    listDiv.innerHTML='';
    data.dailyExpenses.forEach((exp)=>{
      const row=document.createElement('div');
      row.className='card card-royal mb-2';
      row.innerHTML=`<strong>${exp.date}</strong> - ${exp.cat}: ${exp.amount} ريال (سبب: ${exp.desc}) — حساب: ${exp.acc||'غير محدد'}`;
      listDiv.appendChild(row);
    });
  }

  document.getElementById('addExpenseBtn').onclick=async ()=>{
    const date=document.getElementById('expenseDate').value;
    const cat=document.getElementById('expenseCategory').value;
    const amount=parseFloat(document.getElementById('expenseAmount').value)||0;
    const desc=document.getElementById('expenseDesc').value.trim();
    if(amount<=0 || !desc){ alert("الرجاء إدخال المبلغ والسبب"); return; }

    // خصم تلقائي من الحساب المرتبط بالقسم
    const catAccName = data.categoryAccounts[cat];
    if(catAccName){
      const idx = accounts.findIndex(a=>a.name===catAccName);
      if(idx!==-1){
        accounts[idx].balance = parseFloat((accounts[idx].balance - amount).toFixed(2));
        localStorage.setItem('cvm_accounts', JSON.stringify(accounts));
      }
    }

    data.dailyExpenses.push({date,cat,amount,desc,acc:catAccName||'—'});
    await db.collection('users').doc(uid).update({dailyExpenses:data.dailyExpenses});
    document.getElementById('expenseAmount').value='';
    document.getElementById('expenseDesc').value='';
    refreshList();
    renderAccounts();
  };

  refreshList();
}

// ===== Add Salary =====
async function addSalary(uid){
  const amt = prompt("أدخل مبلغ الراتب:");
  const value = parseFloat(amt);
  if(isNaN(value)||value<=0) return alert("أدخل مبلغ صالح");
  // نضيف للرصيد الأول (الحساب الرئيسي)
  if(accounts.length===0) return alert("لا يوجد حساب بنكي لإضافة الراتب");
  accounts[0].balance = parseFloat((accounts[0].balance+value).toFixed(2));
  localStorage.setItem('cvm_accounts', JSON.stringify(accounts));
  alert("تم إضافة الراتب للحساب الرئيسي");
  renderAccounts();
}

// ===== Weekly Tab =====
function renderWeeklyTab(data){
  const container=document.getElementById('weeklyTab');
  container.style.display='block';
  container.innerHTML=`<h5 class="mb-3">التحليلات الأسبوعية</h5><div id="weeklyContainer"></div>`;
  const weeklyContainer=document.getElementById('weeklyContainer');
  const today=new Date();
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date();
    d.setDate(today.getDate()-i);
    days.push(d.toISOString().split('T')[0]);
  }
  for(const day of days){
    const dayDiv=document.createElement('div');
    dayDiv.className="card card-royal mb-2";
    dayDiv.innerHTML=`<h6>${day}</h6>`;
    const dayExpenses=data.dailyExpenses.filter(e=>e.date===day);
    dayExpenses.forEach(e=>{
      dayDiv.innerHTML+=`<div>${e.cat}: ${e.amount} ريال — ${e.acc||'—'} (${e.desc})</div>`;
    });
    weeklyContainer.appendChild(dayDiv);
  }
}

// ===== Account Tab (ربط الأقسام بالحسابات) =====
function renderAccountTab(data, uid){
  const container=document.getElementById('accountTab');
  container.style.display='block';
  container.innerHTML='<h5 class="mb-3 text-center">⚙️ ربط الأقسام بالحسابات</h5>';

  Object.keys(data.categories).forEach(cat=>{
    const div=document.createElement('div');
    div.className='mb-2 card card-royal';
    div.innerHTML=`
      <div><strong>${cat}</strong></div>
      <select id="sel-${cat}" class="form-select mt-1 mb-1">
        <option value="">— اختر حساب —</option>
        ${accounts.map(acc=>`<option value="${acc.name}" ${data.categoryAccounts[cat]===acc.name?'selected':''}>${acc.name}</option>`).join('')}
      </select>
      <button class="btn btn-main btn-sm w-100" onclick="saveCatAccount('${cat}', '${uid}')">حفظ</button>
    `;
    container.appendChild(div);
  });
}
async function saveCatAccount(cat, uid){
  const sel=document.getElementById('sel-'+cat);
  const val=sel.value;
  const docRef=db.collection('users').doc(uid);
  const docSnap = await docRef.get();
  const data=docSnap.data();
  data.categoryAccounts[cat]=val;
  await docRef.update({categoryAccounts:data.categoryAccounts});
  alert(`تم ربط القسم "${cat}" بالحساب "${val}"`);
}

// ===== Accounts Tab (عرض كل الحسابات البنكية) =====
function renderAccounts(){
  const container=document.getElementById('accountsTab');
  container.style.display='block';
  container.innerHTML='<h5 class="mb-3 text-center">💳 حساباتي</h5>';
  const grid=document.createElement('div');
  grid.className='accounts-grid';
  accounts.forEach(acc=>{
    const div=document.createElement('div');
    div.className='bank-card grad-blue';
    div.innerHTML=`
      <div class="card-top">
        <div class="card-name">${acc.name}</div>
        <div class="card-balance">${acc.balance} ريال</div>
      </div>
    `;
    grid.appendChild(div);
  });
  container.appendChild(grid);
}

// ===== Dummy Accounts if empty =====
if(accounts.length===0){
  accounts=[
    {name:'الحساب الرئيسي', balance:0},
    {name:'حساب الاستثمار', balance:0},
    {name:'حساب التجميع', balance:0}
  ];
  localStorage.setItem('cvm_accounts', JSON.stringify(accounts));
}
</script>
</body>
</html>
