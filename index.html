<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>راتبي الذكي — Advanced Budget Planner</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --royal-blue:#1a237e;
      --royal-gold:#d6b86a;
      --light-blue:#536dfe;
      --card-shadow:0 6px 18px rgba(26,35,126,0.2);
      --accent-text:#0d0d3a;
    }
    body{
      background: linear-gradient(180deg,#e8eaf6 0%,#ffffff 100%);
      color: var(--accent-text);
      font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding-bottom:40px;
    }
    .card-royal{
      background: linear-gradient(180deg, rgba(26,35,126,0.05), rgba(83,109,254,0.05));
      border:none;
      box-shadow: var(--card-shadow);
      border-radius:16px;
    }
    .category-name{ font-weight:700; font-size:0.95rem; }
    .btn-gold{ background: var(--royal-gold); color:#3b2d1d; border:none; }
    .btn-royal{ background: var(--royal-blue); color: var(--royal-gold); border:none; }
    .btn-royal:hover{ background: var(--light-blue); }
    .form-control:focus{ box-shadow:none; border-color: var(--royal-blue); }
    .expense-input.over-limit{ border-color:red; background-color:#ffe6e6; }
    footer{ margin-top:30px;color:#7a5a67;font-size:0.9rem; }
    .note{ font-size:0.86rem; color:#8a5a6d; }
    canvas{ max-width:100%; height:200px; }
  </style>
</head>
<body>
<div class="container py-4">

  <!-- Header / Login -->
  <header class="mb-3">
    <h3 class="text-center mb-3">👑 راتبي الذكي</h3>
    <div id="authContainer" class="text-center"></div>
  </header>

  <!-- App -->
  <div id="app" style="display:none;">
    <!-- Budget Container -->
    <div id="budgetContainer"></div>
  </div>

  <footer class="text-center mt-4">
    مصمم لكِ — راتبي الذكي • بياناتك محفوظة سحابيًا لكل مستخدم
  </footer>

</div>

<script>
  // ===== Firebase config =====
  const firebaseConfig = {
    apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
    authDomain:"budget-salary.firebaseapp.com",
    projectId:"budget-salary",
    storageBucket:"budget-salary.firebasestorage.app",
    messagingSenderId:"833349662009",
    appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
    measurementId:"G-0LS4TCBJYZ"
  };
  firebase.initializeApp(firebaseConfig);
  const auth=firebase.auth();
  const db=firebase.firestore();

  // ===== DOM =====
  const authContainer=document.getElementById('authContainer');
  const app=document.getElementById('app');
  const budgetContainer=document.getElementById('budgetContainer');

  let tempEmail="", tempPassword="";

  // ===== Login / Signup =====
  function showLogin(){
    authContainer.innerHTML=`
      <div class="card card-royal p-3 mx-auto" style="max-width:400px;">
        <h5>تسجيل الدخول</h5>
        <input id="emailInput" type="email" class="form-control mb-2" placeholder="البريد الإلكتروني">
        <input id="passwordInput" type="password" class="form-control mb-2" placeholder="كلمة المرور">
        <button class="btn btn-royal w-100 mb-2" onclick="login()">تسجيل الدخول</button>
        <button class="btn btn-outline-primary w-100" onclick="signupStep1()">إنشاء حساب جديد</button>
      </div>`;
  }

  function login(){
    const email=document.getElementById('emailInput').value;
    const password=document.getElementById('passwordInput').value;
    auth.signInWithEmailAndPassword(email,password).catch(e=>alert(e.message));
  }

  function signupStep1(){
    const email=document.getElementById('emailInput').value;
    const password=document.getElementById('passwordInput').value;
    auth.createUserWithEmailAndPassword(email,password)
      .then(res=>db.collection('users').doc(res.user.uid).set({
        categories:{}, dailyExpenses:[]
      }))
      .catch(e=>alert(e.message));
  }

  auth.onAuthStateChanged(user=>{
    if(user){
      authContainer.style.display='none';
      app.style.display='block';
      loadUserData(user.uid);
    } else{
      authContainer.style.display='block';
      app.style.display='none';
      showLogin();
    }
  });

  // ===== Load Data =====
  async function loadUserData(uid){
    const docSnap=await db.collection('users').doc(uid).get();
    if(!docSnap.exists){
      budgetContainer.innerHTML="<div class='text-center'>خطأ: البيانات غير موجودة</div>";
      return;
    }
    renderBudget(docSnap.data(),uid);
  }

  // ===== Render Budget =====
  function renderBudget(data,uid){
    budgetContainer.innerHTML=`
      <div class="card p-3 card-royal">
        <h5 class="mb-3">لوحة الميزانية</h5>
        <div id="expenseInputs"></div>
        <button id="addExpenseBtn" class="btn btn-outline-primary mb-2">اضافة المصروفات</button>
        <button id="endMonthBtn" class="btn btn-gold mb-2">نهاية الشهر → تحويل الباقي للادخار</button>
        <div id="predictionsContainer" class="mb-2"></div>
        <div id="savingTipsContainer" class="mb-2 note"></div>
        <canvas id="pieChart"></canvas>
        <canvas id="lineChart"></canvas>
      </div>
    `;

    // ==== Categories from system / user-defined ====
    const expenseInputs=document.getElementById('expenseInputs');
    const categories=Object.keys(data.categories);
    categories.forEach(cat=>{
      const div=document.createElement('div');
      div.className="d-flex gap-2 mb-2";
      div.innerHTML=`<span class="category-name w-50">${cat}</span>
        <input type="number" class="form-control w-50 expense-input" placeholder="المصروف اليومي" data-cat="${cat}" data-limit="${data.categories[cat]}">`;
      expenseInputs.appendChild(div);
    });

    // ==== Add Expenses ====
    document.getElementById('addExpenseBtn').onclick=async ()=>{
      const newExpenses={};
      let overLimitCats=[];
      Array.from(document.getElementsByClassName('expense-input')).forEach(inp=>{
        const cat=inp.dataset.cat;
        const limit=parseFloat(inp.dataset.limit);
        const val=parseFloat(inp.value)||0;
        newExpenses[cat]=val;
        inp.classList.remove('over-limit');
        if(val>limit) inp.classList.add('over-limit'), overLimitCats.push(cat);
      });
      if(overLimitCats.length>0) alert("⚠️ تجاوز الحد في الأقسام: "+overLimitCats.join(", "));
      data.dailyExpenses.push({date:new Date().toISOString().split('T')[0],expenses:newExpenses});
      await db.collection('users').doc(uid).update({dailyExpenses:data.dailyExpenses});
      renderChart(data);
      renderPredictions(data);
      renderSavingTips(data);
      renderLineChart(data);
    };

    // ==== End Month ====
    document.getElementById('endMonthBtn').onclick=async ()=>{
      let totalSpent=0;
      for(const day of data.dailyExpenses) for(const cat in day.expenses) totalSpent+=day.expenses[cat];
      const totalBudget=Object.values(data.categories).reduce((a,b)=>a+b,0);
      const remaining=totalBudget-totalSpent;
      alert(`تم تحويل ${remaining.toFixed(2)} ريال للادخار`);
      data.categories["ادخار"]=(data.categories["ادخار"]||0)+remaining;
      await db.collection('users').doc(uid).update({categories:data.categories});
      renderChart(data);
      renderPredictions(data);
      renderSavingTips(data);
      renderLineChart(data);
    };

    renderChart(data);
    renderPredictions(data);
    renderSavingTips(data);
    renderLineChart(data);
  }

  // ===== Pie Chart =====
  function renderChart(data){
    const ctx=document.getElementById('pieChart').getContext('2d');
    const colors=Object.keys(data.categories).map(cat=>{
      const spent=data.dailyExpenses.reduce((sum,d)=>sum+(d.expenses[cat]||0),0);
      const limit=data.categories[cat];
      const ratio=spent/limit;
      if(ratio<0.8) return "#4caf50";
      else if(ratio<=1) return "#ffeb3b";
      else return "#f44336";
    });
    const chartData={
      labels:Object.keys(data.categories),
      datasets:[{ data:Object.values(data.categories), backgroundColor:colors }]
    };
    if(window.myChart) window.myChart.destroy();
    window.myChart=new Chart(ctx,{type:'pie',data:chartData});
  }

  // ===== Predictions =====
  function renderPredictions(data){
    const container=document.getElementById('predictionsContainer');
    container.innerHTML="<b>توقعات الإنفاق لبقية الشهر:</b><br>";
    const today=new Date().getDate();
    const daysInMonth=new Date(new Date().getFullYear(),new Date().getMonth()+1,0).getDate();
    for(const cat in data.categories){
      const spent=data.dailyExpenses.reduce((sum,d)=>sum+(d.expenses[cat]||0),0);
      const remaining=data.categories[cat]-spent;
      const dailyPrediction=remaining/(daysInMonth-today);
      container.innerHTML+=`${cat}: ${dailyPrediction.toFixed(2)} ريال يومياً متوقع<br>`;
    }
  }

  // ===== Saving Tips =====
  function renderSavingTips(data){
    const container=document.getElementById('savingTipsContainer');
    let tips=[];
    for(const cat in data.categories){
      const spent=data.dailyExpenses.reduce((sum,d)=>sum+(d.expenses[cat]||0),0);
      const limit=data.categories[cat];
      if(spent>limit) tips.push(`قللي الإنفاق في ${cat} لتوفير أكثر`);
      else if(spent<limit*0.5) tips.push(`يمكنك استثمار الفائض من ${cat} في الادخار`);
    }
    container.innerHTML=tips.length?tips.join("<br>"):"لا توجد نصائح حالياً، استمري على هذا الأداء 👍";
  }

  // ===== Line Chart =====
  function renderLineChart(data){
    const ctx=document.getElementById('lineChart').getContext('2d');
    const labels=data.dailyExpenses.map(d=>d.date);
    const datasets=Object.keys(data.categories).map(cat=>{
      const values=data.dailyExpenses.map(d=>d.expenses[cat]||0);
      return { label:cat, data:values, borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), tension:0.2, fill:false };
    });
    if(window.myLineChart) window.myLineChart.destroy();
    window.myLineChart=new Chart(ctx,{type:'line',data:{labels,datasets}});
  }

</script>
</body>
</html>
