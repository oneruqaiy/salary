<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€” ØªØ·Ø¨ÙŠÙ‚</title>

<!-- Bootstrap RTL CSS for nicer inputs (no JS dependency) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

<!-- Chart.js (Ù…ÙˆØ¬ÙˆØ¯ Ù„ÙƒÙ† Ù„Ù… Ø£ØªØ±Ùƒ Ø±Ø³Ù…Ø§Ù‹ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ØŒ ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØªÙ‡ Ù„Ø§Ø­Ù‚Ø§Ù‹) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --main-blue:#3b6bff;
  --light-bg:#f5f7fb;
  --card-shadow:0 8px 24px rgba(59,107,255,0.08);
  --muted:#64748b;
  --danger:#ef4444;
  --success:#16a34a;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background:var(--light-bg);
  color:#0f1724;
  -webkit-font-smoothing:antialiased;
}
.container-app{
  max-width:980px;
  margin:0 auto;
  padding:14px;
  padding-bottom:120px; /* space for bottom nav */
}

/* Auth card */
#authContainer{
  max-width:420px;
  margin:70px auto;
  padding:18px;
  background:#fff;
  border-radius:14px;
  box-shadow:var(--card-shadow);
}

/* Cards */
.card-royal{
  background:#fff;
  border-radius:12px;
  padding:14px;
  box-shadow:var(--card-shadow);
  margin-bottom:12px;
}

/* Inputs/buttons */
.form-control, .form-select { border-radius:10px; }
.btn-main{ background:var(--main-blue); color:#fff; border:none; border-radius:10px; }
.btn-main:hover{ background:#597fff; }

/* bottom nav */
.bottom-nav{
  position:fixed; left:0; right:0; bottom:12px; z-index:220;
  display:flex; gap:8px; justify-content:space-around;
  padding:8px; margin:0 12px;
}
.bottom-nav button{
  flex:1;
  border-radius:12px;
  border:1px solid rgba(15,23,36,0.06);
  background:#fff;
  padding:10px 6px;
  font-weight:600;
  color:#334155;
  box-shadow:0 6px 18px rgba(2,6,23,0.04);
}
.bottom-nav button.active{ color:var(--main-blue); box-shadow:0 10px 30px rgba(59,107,255,0.08); }

/* Daily list */
.expense-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.expense-item{ display:flex; justify-content:space-between; gap:10px; padding:10px; border-radius:10px; background:#fbfdff; box-shadow:0 6px 14px rgba(2,6,23,0.03); align-items:center; }
.expense-left{ display:flex; flex-direction:column; gap:6px; }
.expense-meta{ color:var(--muted); font-size:13px; }
.expense-amount{ color:var(--main-blue); font-weight:800; font-size:15px; }

/* small actions */
.actions { display:flex; gap:8px; align-items:center; }

/* weekly layout */
.weekly-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); margin-top:10px; }
.weekly-card{ background:#fff; border-radius:12px; padding:12px; box-shadow:var(--card-shadow); }
.cat-entry{ display:flex; justify-content:space-between; gap:10px; padding:8px; border-radius:8px; background:#fbfdff; margin-top:8px; align-items:center; }

/* totals */
.totals{ margin-top:12px; padding:12px; border-radius:12px; background:linear-gradient(90deg,#eef5ff,#fff); box-shadow:var(--card-shadow); display:flex; justify-content:space-between; align-items:center; }

/* responsive */
@media(max-width:520px){
  .container-app{ padding:10px; }
  .bottom-nav{ bottom:8px; gap:6px; margin:0 8px; }
}
</style>
</head>
<body>

<!-- Auth container (login/signup) -->
<div id="authContainer" style="display:none"></div>

<!-- App -->
<div id="app" class="container-app" style="display:none;">
  <div id="welcome" class="mb-2" style="text-align:center; font-weight:700;"></div>

  <!-- Tabs content placeholders -->
  <div id="tab-daily" style="display:none;"></div>
  <div id="tab-weekly" style="display:none;"></div>
  <div id="tab-account" style="display:none;"></div>

  <!-- Bottom navigation -->
  <div class="bottom-nav">
    <button id="nav-daily" class="active">ğŸ·ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
    <button id="nav-weekly">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</button>
    <button id="nav-account">âš™ï¸ Ø­Ø³Ø§Ø¨Ùƒ</button>
    <button id="nav-logout">ğŸšª Ø®Ø±ÙˆØ¬</button>
  </div>
</div>

<!-- Edit modal (custom light modal) -->
<div id="editModal" style="display:none; position:fixed; inset:0; z-index:999; background:rgba(2,6,23,0.45); align-items:center; justify-content:center;">
  <div style="width:94%; max-width:520px; background:#fff; border-radius:12px; padding:14px;">
    <h6>ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…ØµØ±ÙˆÙ</h6>
    <div style="margin-top:8px;">
      <label class="form-label">Ø§Ù„Ù‚Ø³Ù…</label>
      <select id="editCategory" class="form-select"></select>
      <label class="form-label mt-2">Ø§Ù„Ù…Ø¨Ù„Øº</label>
      <input id="editAmount" type="number" class="form-control" />
      <label class="form-label mt-2">Ø§Ù„ÙˆØµÙ</label>
      <input id="editNote" class="form-control" />
      <label class="form-label mt-2">Ø§Ù„ØªØ§Ø±ÙŠØ®</label>
      <input id="editDate" type="date" class="form-control" />
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
      <button id="editCancel" class="btn btn-outline-secondary">Ø¥Ù„ØºØ§Ø¡</button>
      <button id="editSave" class="btn btn-main">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
    </div>
  </div>
</div>

<script>
/* ========== Ø¥Ø¹Ø¯Ø§Ø¯ Firebase ========== */
/* Ø¶Ø¹ÙŠ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ Ù‡Ù†Ø§ â€” Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ù…Ø£Ø®ÙˆØ°Ø© Ù…Ù† ÙƒÙˆØ¯Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚ */
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== Ø¹Ù†Ø§ØµØ± DOM ===== */
const authContainer = document.getElementById('authContainer');
const appEl = document.getElementById('app');
const welcomeEl = document.getElementById('welcome');
const tabDaily = document.getElementById('tab-daily');
const tabWeekly = document.getElementById('tab-weekly');
const tabAccount = document.getElementById('tab-account');

const navDaily = document.getElementById('nav-daily');
const navWeekly = document.getElementById('nav-weekly');
const navAccount = document.getElementById('nav-account');
const navLogout = document.getElementById('nav-logout');

const editModal = document.getElementById('editModal');
const editCategory = document.getElementById('editCategory');
const editAmount = document.getElementById('editAmount');
const editNote = document.getElementById('editNote');
const editDate = document.getElementById('editDate');
const editCancel = document.getElementById('editCancel');
const editSave = document.getElementById('editSave');

let currentUserUID = null;
let currentUserDoc = null; // snapshot data (object)
let editingEntryId = null;

/* ===== ÙˆØ§Ø¬Ù‡Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ / Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¨Ø³ÙŠØ·Ø© ===== */
function showAuth(){
  authContainer.style.display = 'block';
  appEl.style.display = 'none';
  authContainer.innerHTML = `
    <h5 class="text-center mb-3">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£Ùˆ Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</h5>
    <input id="inEmail" class="form-control mb-2" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input id="inPass" type="password" class="form-control mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <div style="display:flex; gap:8px;">
      <button id="btnLogin" class="btn btn-main flex-grow-1">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
      <button id="btnSignup" class="btn btn-outline-primary flex-grow-1">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    </div>
    <div style="margin-top:10px; text-align:center; color:var(--muted); font-size:13px;">
      Ø£Ùˆ ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¤Ù‚Øª (ØªØ¬Ø±ÙŠØ¨ÙŠ)
      <div style="margin-top:6px;">
        <button id="btnAnon" class="btn btn-outline-secondary">ØªØ¬Ø±Ø¨Ø© Ø¨Ø¯ÙˆÙ† Ø­Ø³Ø§Ø¨</button>
      </div>
    </div>
  `;
  document.getElementById('btnLogin').onclick = async ()=>{
    const email = document.getElementById('inEmail').value.trim();
    const pwd = document.getElementById('inPass').value;
    if(!email || !pwd){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
    try{ await auth.signInWithEmailAndPassword(email,pwd); }
    catch(e){ alert(e.message); }
  };
  document.getElementById('btnSignup').onclick = async ()=>{
    const email = document.getElementById('inEmail').value.trim();
    const pwd = document.getElementById('inPass').value;
    if(!email || !pwd){ alert('Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
    try{
      const cred = await auth.createUserWithEmailAndPassword(email,pwd);
      // create default doc
      await db.collection('users').doc(cred.user.uid).set({
        categories: { "Ù…Ø£ÙƒÙ„": 200, "Ù†Ù‚Ù„": 100, "ØªØ±ÙÙŠÙ‡": 50 },
        dailyExpenses: [],
        salary: 0,
        incomeSources: 0,
        loans: 0,
        lastSalaryDate: null
      });
    }catch(e){ alert(e.message); }
  };
  document.getElementById('btnAnon').onclick = async ()=>{
    try{ await auth.signInAnonymously(); }
    catch(e){ alert(e.message); }
  };
}

/* ===== Ø§Ù„ØªØ¨Ø¯ÙŠÙ„ Ø¨ÙŠÙ† Ø§Ù„ØªØ§Ø¨Ø§Øª Ø§Ù„Ø³ÙÙ„ÙŠ ===== */
function setActiveNav(btn){
  [navDaily,navWeekly,navAccount].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
navDaily.onclick = ()=>{ showTab('daily'); setActiveNav(navDaily); };
navWeekly.onclick = ()=>{ showTab('weekly'); setActiveNav(navWeekly); };
navAccount.onclick = ()=>{ showTab('account'); setActiveNav(navAccount); };
navLogout.onclick = ()=> auth.signOut();

/* ===== Ø¥Ø¸Ù‡Ø§Ø± ØªØ¨ Ù…Ø­Ø¯Ø¯ ===== */
function showTab(id){
  tabDaily.style.display = 'none';
  tabWeekly.style.display = 'none';
  tabAccount.style.display = 'none';
  if(id === 'daily') tabDaily.style.display = 'block';
  if(id === 'weekly') tabWeekly.style.display = 'block';
  if(id === 'account') tabAccount.style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ===== Ø¹Ù†Ø¯ ØªØºÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØµØ§Ø¯Ù‚Ø© ===== */
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUserUID = user.uid;
    authContainer.style.display = 'none';
    appEl.style.display = 'block';
    // load user's doc
    await fetchUserDoc();
    welcomeEl.textContent = `Ø£Ù‡Ù„Ø§Ù‹ØŒ ${user.email || user.displayName || 'Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…'}`;
    // render tabs
    renderDailyTab();
    renderWeeklyTab();
    renderAccountTab();
    showTab('daily');
    setActiveNav(navDaily);
  } else {
    currentUserUID = null;
    currentUserDoc = null;
    showAuth();
  }
});

/* ===== Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ù…Ø³ØªÙ†Ø¯ users/{uid}) ===== */
async function fetchUserDoc(){
  if(!currentUserUID) return;
  const ref = db.collection('users').doc(currentUserUID);
  const snap = await ref.get();
  if(!snap.exists){
    // if new anonymous user, create default structure
    await ref.set({ categories: {}, dailyExpenses: [], salary:0, incomeSources:0, loans:0, lastSalaryDate:null });
    currentUserDoc = (await ref.get()).data();
  } else {
    currentUserDoc = snap.data();
    // safety defaults
    currentUserDoc.categories = currentUserDoc.categories || {};
    currentUserDoc.dailyExpenses = currentUserDoc.dailyExpenses || [];
  }
}

/* ===== Ù…Ø³Ø§Ø¹Ø¯Ø§Øª ØªÙ†Ø³ÙŠÙ‚ ÙˆØ¹Ù…Ù„ÙŠØ§Øª Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµÙÙˆÙØ© ===== */
function uidForEntry(){ return Date.now().toString() + Math.random().toString(36).slice(2,7); }
function formatCurrency(n){ const v = Number(n) || 0; return Number.isInteger(v) ? v + ' Ø±.Ø¹' : v.toFixed(2) + ' Ø±.Ø¹'; }
function yyyy_mm_dd(d){ const dt = new Date(d); const y = dt.getFullYear(); const m = String(dt.getMonth()+1).padStart(2,'0'); const day = String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ===== ===== ØµÙØ­Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ (Daily) ===== ===== */
function renderDailyTab(){
  // ensure we have data
  if(!currentUserDoc) return;
  const categories = Object.keys(currentUserDoc.categories || {});
  const catOptions = categories.length ? categories.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('') : `<option value="">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ù‚Ø³Ø§Ù… Ø¨Ø¹Ø¯ - Ø§Ø°Ù‡Ø¨ Ù„ØµÙØ­Ø© Ø­Ø³Ø§Ø¨Ùƒ Ù„Ø¥Ø¶Ø§ÙØªÙ‡Ø§</option>`;

  tabDaily.innerHTML = `
    <div class="card-royal">
      <h5>ğŸ·ï¸ ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø¬Ø¯ÙŠØ¯</h5>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
        <select id="inpCategory" class="form-select" style="min-width:160px;">
          ${catOptions}
        </select>
        <input id="inpAmount" type="number" class="form-control" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
        <input id="inpDate" type="date" class="form-control" value="${new Date().toISOString().split('T')[0]}" style="max-width:180px;">
      </div>
      <textarea id="inpNote" class="form-control mt-2" placeholder="Ø³Ø¨Ø¨ / ÙÙŠÙ…Ø§ ØªÙ… ØµØ±Ù Ø§Ù„Ù…Ø¨Ù„Øº" rows="2" style="border-radius:8px"></textarea>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="btnAddExpense" class="btn btn-main flex-grow-1">Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ</button>
        <button id="btnClear" class="btn btn-outline-secondary">Ù…Ø³Ø­ Ø§Ù„Ø­Ù‚ÙˆÙ„</button>
      </div>

      <div style="margin-top:14px;">
        <h6>ğŸ“‹ Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ø­Ø¯Ø¯</h6>
        <div id="dailyList" class="expense-list"></div>
      </div>
    </div>
  `;

  // attach handlers
  document.getElementById('btnAddExpense').onclick = addExpenseHandler;
  document.getElementById('btnClear').onclick = ()=>{
    document.getElementById('inpAmount').value = '';
    document.getElementById('inpNote').value = '';
  };

  // populate today's (or selected date) list
  populateDailyList();
}

/* Ø¥Ø¶Ø§ÙØ© Ù…ØµØ±ÙˆÙ â€” ÙŠØ¶ÙŠÙ ÙƒÙƒØ§Ø¦Ù† Ø¯Ø§Ø®Ù„ currentUserDoc.dailyExpenses Ø«Ù… ÙŠØ­Ø¯Ø« Ø§Ù„Ù…Ø³ØªÙ†Ø¯ */
async function addExpenseHandler(){
  const cat = document.getElementById('inpCategory').value;
  const amount = parseFloat(document.getElementById('inpAmount').value || 0);
  const note = document.getElementById('inpNote').value.trim();
  const date = document.getElementById('inpDate').value || yyyy_mm_dd(new Date());
  if(!cat){ alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…'); return; }
  if(!(amount>0)){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±'); return; }

  const entry = {
    id: uidForEntry(),
    date,
    category: cat,
    amount,
    note,
    ts: new Date().toISOString()
  };

  // push locally
  currentUserDoc.dailyExpenses.push(entry);
  // update firestore
  await db.collection('users').doc(currentUserUID).update({ dailyExpenses: currentUserDoc.dailyExpenses });
  // refresh UI
  populateDailyList();
  // clear inputs
  document.getElementById('inpAmount').value = '';
  document.getElementById('inpNote').value = '';
}

/* Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø­Ø¯Ø¯ */
function populateDailyList(){
  const listEl = document.getElementById('dailyList');
  if(!listEl) return;
  const date = document.getElementById('inpDate').value || yyyy_mm_dd(new Date());
  // filter entries with same date
  const todays = (currentUserDoc.dailyExpenses || []).filter(e => e.date === date);
  // sort by ts desc
  todays.sort((a,b)=> new Date(b.ts) - new Date(a.ts));
  if(todays.length === 0){
    listEl.innerHTML = `<div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø±ÙŠØ®.</div>`;
    return;
  }
  listEl.innerHTML = '';
  todays.forEach(entry=>{
    const div = document.createElement('div');
    div.className = 'expense-item';
    div.innerHTML = `
      <div class="expense-left">
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="font-weight:700">${escapeHtml(entry.category)}</div>
          <div class="expense-meta">${escapeHtml(entry.note || '-')}</div>
        </div>
        <div class="expense-meta">${entry.date} â€¢ ${new Date(entry.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <div class="expense-amount">${formatCurrency(entry.amount)}</div>
        <div class="actions">
          <button class="btn btn-sm btn-outline-secondary" onclick="openEdit('${entry.id}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeEntry('${entry.id}')">ğŸ—‘ï¸ Ø­Ø°Ù</button>
        </div>
      </div>
    `;
    listEl.appendChild(div);
  });
}

/* ========== ØªØ¹Ø¯ÙŠÙ„ / Ø­Ø°Ù (Ù…Ù† Ø§Ù„ÙŠÙˆÙ…ÙŠØ© Ø£Ùˆ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©) ========== */
/* ÙØªØ­ Ù…ÙˆØ¯Ø§Ù„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ ÙˆØªØ¹Ø¨Ø¦ØªÙ‡ */
function openEdit(entryId){
  const entry = (currentUserDoc.dailyExpenses || []).find(x=>x.id === entryId);
  if(!entry){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†'); return; }
  editingEntryId = entryId;
  // fill category select
  const cats = Object.keys(currentUserDoc.categories || {});
  editCategory.innerHTML = cats.map(c=>`<option value="${escapeHtml(c)}"${c===entry.category?' selected':''}>${escapeHtml(c)}</option>`).join('');
  editAmount.value = entry.amount;
  editNote.value = entry.note || '';
  editDate.value = entry.date || yyyy_mm_dd(new Date());
  showEditModal();
}

/* Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù…ÙˆØ¯Ø§Ù„ */
function showEditModal(){ editModal.style.display = 'flex'; editModal.scrollTop = 0; }
function hideEditModal(){ editModal.style.display = 'none'; editingEntryId = null; }

/* Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ */
editSave.onclick = async ()=>{
  if(!editingEntryId){ hideEditModal(); return; }
  const entryIndex = (currentUserDoc.dailyExpenses || []).findIndex(x=>x.id === editingEntryId);
  if(entryIndex === -1){ alert('Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†'); hideEditModal(); return; }
  const cat = editCategory.value;
  const amt = parseFloat(editAmount.value || 0);
  const note = editNote.value.trim();
  const date = editDate.value || yyyy_mm_dd(new Date());
  if(!cat){ alert('Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…'); return; }
  if(!(amt>0)){ alert('Ø£Ø¯Ø®Ù„ Ù…Ø¨Ù„ØºÙ‹Ø§ ØµØ­ÙŠØ­Ù‹Ø§ Ø£ÙƒØ¨Ø± Ù…Ù† ØµÙØ±'); return; }
  // update locally
  currentUserDoc.dailyExpenses[entryIndex].category = cat;
  currentUserDoc.dailyExpenses[entryIndex].amount = amt;
  currentUserDoc.dailyExpenses[entryIndex].note = note;
  currentUserDoc.dailyExpenses[entryIndex].date = date;
  currentUserDoc.dailyExpenses[entryIndex].ts = new Date().toISOString();
  // update firestore
  await db.collection('users').doc(currentUserUID).update({ dailyExpenses: currentUserDoc.dailyExpenses });
  // refresh UI
  populateDailyList();
  renderWeeklyTab(); // refresh weekly too
  hideEditModal();
};

/* Ø¥Ù„ØºØ§Ø¡ */
editCancel.onclick = ()=> hideEditModal();

/* Ø­Ø°Ù Ù‚ÙŠØ¯ */
async function removeEntry(entryId){
  if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ')) return;
  currentUserDoc.dailyExpenses = (currentUserDoc.dailyExpenses || []).filter(x=>x.id !== entryId);
  await db.collection('users').doc(currentUserUID).update({ dailyExpenses: currentUserDoc.dailyExpenses });
  // refresh current views
  populateDailyList();
  renderWeeklyTab();
}

/* ========== ØµÙØ­Ø© Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© ========== */
function renderWeeklyTab(){
  if(!currentUserDoc) return;
  tabWeekly.innerHTML = `
    <div class="card-royal">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h5>ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h5>
        <small style="color:var(--muted)">Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…</small>
      </div>
      <div id="weeklyContent"></div>
    </div>
  `;
  buildWeeklyContent();
}

/* ÙŠØ¨Ù†ÙŠ Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹: ÙƒÙ„ ÙŠÙˆÙ… Ù…Ø¹ Ø§Ù„ØªÙØ§ØµÙŠÙ„ØŒ ÙˆØªÙ„Ø®ÙŠØµ Ø¨Ø­Ø³Ø¨ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… */
function buildWeeklyContent(){
  const weeklyContent = document.getElementById('weeklyContent');
  // days list
  const today = new Date();
  const days = [];
  for(let i=6;i>=0;i--){ const d = new Date(); d.setDate(today.getDate()-i); days.push( yyyy_mm_dd(d) ); }

  // filter entries in range
  const inRange = (currentUserDoc.dailyExpenses || []).filter(e => days.includes(e.date));
  // sort by date desc then ts desc
  inRange.sort((a,b)=>{
    if(a.date === b.date) return new Date(b.ts) - new Date(a.ts);
    return new Date(b.date) - new Date(a.date);
  });

  // group by day
  let html = '';
  if(inRange.length === 0){
    html += `<div style="padding:12px; color:var(--muted)">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ ÙÙŠ Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù….</div>`;
  } else {
    // for each day show header and its entries
    days.forEach(day=>{
      const dayEntries = inRange.filter(e=>e.date === day);
      if(dayEntries.length === 0) return;
      const dayTotal = dayEntries.reduce((s,x)=>s + Number(x.amount||0), 0);
      html += `<div style="margin-top:10px; padding:10px; border-radius:10px; background:#fff; box-shadow:var(--card-shadow);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div><strong>${friendlyDayLabel(day)}</strong><div style="font-size:13px;color:var(--muted)">${day}</div></div>
          <div style="font-weight:800; color:var(--main-blue)">${formatCurrency(dayTotal)}</div>
        </div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">`;

      dayEntries.forEach(en=>{
        html += `<div class="cat-entry">
          <div style="flex:1;">
            <div style="font-weight:700">${escapeHtml(en.category)}</div>
            <div style="font-size:13px;color:var(--muted)">${escapeHtml(en.note||'-')}</div>
            <div style="font-size:12px;color:#94a3b8;margin-top:6px">${new Date(en.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;color:var(--main-blue)">${formatCurrency(en.amount)}</div>
            <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end;">
              <button class="btn btn-sm btn-outline-secondary" onclick="openEdit('${en.id}')">âœï¸</button>
              <button class="btn btn-sm btn-outline-danger" onclick="removeEntry('${en.id}')">ğŸ—‘ï¸</button>
            </div>
          </div>
        </div>`;
      });

      html += `</div></div>`;
    });
  }

  // Category summaries
  const catTotals = {};
  (currentUserDoc.dailyExpenses || []).forEach(e=>{
    // only week
    const daysRange = days;
    if(!daysRange.includes(e.date)) return;
    if(!catTotals[e.category]) catTotals[e.category]=0;
    catTotals[e.category] += Number(e.amount||0);
  });

  // categories list includes those in allocations + any spent categories
  const allCats = new Set([ ...Object.keys(currentUserDoc.categories || {}), ...Object.keys(catTotals) ]);

  // build summaries grid
  html += `<div style="margin-top:12px;">
    <h6>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h6>
    <div class="weekly-grid">`;
  allCats.forEach(cat=>{
    const alloc = Number(currentUserDoc.categories && currentUserDoc.categories[cat] ? currentUserDoc.categories[cat] : 0);
    const spent = Number(catTotals[cat]||0);
    const remaining = alloc - spent;
    // entries list for this cat
    const entries = (currentUserDoc.dailyExpenses || []).filter(e=>e.category===cat && days.includes(e.date)).sort((a,b)=> new Date(b.date) - new Date(a.date) || new Date(b.ts)-new Date(a.ts));

    html += `<div class="weekly-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>${escapeHtml(cat)}</strong><div style="font-size:13px;color:var(--muted)">Ù…Ø®ØµØµ: ${formatCurrency(alloc)}</div></div>
        <div style="text-align:right">
          <div style="font-weight:800;color:var(--main-blue)">${formatCurrency(spent)}</div>
          <div style="font-size:13px; color:${remaining<0? 'var(--danger)' : 'var(--success)'}; margin-top:6px;">
            ${ remaining < 0 ? 'ØªØ¬Ø§ÙˆØ² Ø¨Ù€ ' + formatCurrency(Math.abs(remaining)) : 'Ø§Ù„Ù…ØªØ¨Ù‚ÙŠ ' + formatCurrency(remaining) }
          </div>
        </div>
      </div>
      <div style="margin-top:8px; font-size:13px; color:var(--muted)"><small>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØµØ±Ù Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø®Ù„Ø§Ù„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹:</small></div>`;

    if(entries.length){
      entries.forEach(en=>{
        html += `<div class="cat-entry">
          <div>
            <div style="font-weight:600">${escapeHtml(en.note||'-')}</div>
            <div style="font-size:12px;color:var(--muted)">${en.date} â€¢ ${new Date(en.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          </div>
          <div style="font-weight:800;color:var(--main-blue)">${formatCurrency(en.amount)}</div>
        </div>`;
      });
    } else {
      html += `<div style="margin-top:8px;color:var(--muted); font-size:13px">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ§Ø±ÙŠÙ Ù„Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>`;
    }

    html += `</div>`; // weekly-card
  });
  html += `</div></div>`; // close grid and section

  // overall totals
  const overallTotal = Object.values(catTotals).reduce((s,v)=>s+Number(v||0),0);
  html += `<div class="totals">
    <div>
      <div style="font-size:13px;color:#334155">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px">${formatCurrency(overallTotal)}</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:13px;color:#334155">Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯</div>
      <div style="font-weight:700; font-size:16px; margin-top:6px">${inRange.length}</div>
    </div>
  </div>`;

  weeklyContent.innerHTML = html;
}

/* friendly day label Arabic */
function friendlyDayLabel(iso){
  const d = new Date(iso);
  const daysAr = ['Ø§Ù„Ø£Ø­Ø¯','Ø§Ù„Ø§Ø«Ù†ÙŠÙ†','Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡','Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡','Ø§Ù„Ø®Ù…ÙŠØ³','Ø§Ù„Ø¬Ù…Ø¹Ø©','Ø§Ù„Ø³Ø¨Øª'];
  return `${daysAr[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}`;
}

/* ========== ØµÙØ­Ø© Ø§Ù„Ø­Ø³Ø§Ø¨ (ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ø±Ø§ØªØ¨) ========== */
function renderAccountTab(){
  if(!currentUserDoc) return;
  const categories = currentUserDoc.categories || {};
  const rows = Object.keys(categories).map(cat=>{
    return `<div class="d-flex gap-2 mb-2">
      <input class="form-control cat-name" value="${escapeHtml(cat)}" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…">
      <input class="form-control cat-alloc" type="number" value="${categories[cat] || 0}" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
    </div>`;
  }).join('');

  tabAccount.innerHTML = `
    <div class="card-royal">
      <h5>âš™ï¸ Ø­Ø³Ø§Ø¨Ùƒ ÙˆØªØ®ØµÙŠØµ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h5>
      <div style="margin-top:8px;">
        <label class="form-label">Ø§Ù„Ø±Ø§ØªØ¨</label>
        <input id="salaryInput" type="number" class="form-control mb-2" value="${currentUserDoc.salary || 0}">
        <label class="form-label">Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</label>
        <div id="catsContainer">${rows}</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="addCatBtn" class="btn btn-outline-primary">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
          <button id="saveAccountBtn" class="btn btn-main flex-grow-1">Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
        </div>
      </div>
      <div style="margin-top:12px; color:var(--muted); font-size:13px;">
        Ø¹Ø¯Ø¯ Ø§Ù„Ù‚ÙŠÙˆØ¯ Ø§Ù„Ù…Ø®Ø²Ù†Ø©: <strong>${(currentUserDoc.dailyExpenses||[]).length}</strong>
      </div>
    </div>
  `;

  document.getElementById('addCatBtn').onclick = ()=>{
    const div = document.createElement('div');
    div.className = 'd-flex gap-2 mb-2';
    div.innerHTML = `<input class="form-control cat-name" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…">
      <input class="form-control cat-alloc" type="number" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">`;
    document.getElementById('catsContainer').appendChild(div);
  };

  document.getElementById('saveAccountBtn').onclick = async ()=>{
    const salary = parseFloat(document.getElementById('salaryInput').value) || 0;
    const names = Array.from(document.getElementsByClassName('cat-name')).map(i=>i.value.trim()).filter(x=>x);
    const allocs = Array.from(document.getElementsByClassName('cat-alloc')).map(i=>parseFloat(i.value)||0);
    const categories = {};
    for(let i=0;i<names.length;i++){ categories[names[i]] = allocs[i] || 0; }
    // update firestore
    await db.collection('users').doc(currentUserUID).update({ salary, categories });
    // re-fetch and refresh UIs
    await fetchUserDoc();
    renderDailyTab();
    renderWeeklyTab();
    alert('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª!');
  };
}

/* ========== Ø±Ø¯ Ø¹Ù„Ù‰ ØªØºÙŠÙŠØ±Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ daily (Ù„ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©) ========== */
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'inpDate') populateDailyList();
});

/* ========== ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø­Ù„ÙŠØ© Ø¹Ù†Ø¯ ØªØºÙŠÙŠØ± ÙÙŠ Ø§Ù„ÙØ§ÙŠØ±Ø³ØªÙˆØ± (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) ========= */
/* Ù‡Ù†Ø§ Ù†Ø³ØªØ®Ø¯Ù… fetchUserDoc Ù…ØªÙ‰ Ù†Ø­ØªØ§Ø¬ ØªØ­Ø¯ÙŠØ« Ø¨Ø¹Ø¯ Ø¹Ù…Ù„ÙŠØ§ØªÙ†Ø§. */
/* Ù„ÙƒÙ† Ù„Ùˆ Ø£Ø±Ø¯ØªÙŠ Ù…Ø±Ø§Ù‚Ø¨Ø© real-time Ø§Ø³ØªØ®Ø¯Ù…ÙŠ onSnapshot Ø¨Ø¯Ù„ get ÙÙŠ fetchUserDoc. */

/* ========== Ø¯ÙˆØ§Ù„ Ø§Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© Ø¹Ù†Ø¯ start ========== */
(async function init(){
  // show auth or app based on auth state (handled by onAuthStateChanged)
  showAuth();
})();

</script>

</body>
</html>
