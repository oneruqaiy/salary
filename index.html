<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€” Advanced Budget Planner</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --royal-purple:#4b0082;
  --royal-gold:#d6b86a;
  --royal-silver:#c0c0c0;
  --light-purple:#a76bcf;
  --card-shadow:0 6px 18px rgba(75,0,130,0.2);
  --accent-text:#2c003e;
}
body{
  background: linear-gradient(180deg,#f2e9ff 0%,#ffffff 100%);
  color: var(--accent-text);
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  padding-bottom:40px;
}
.card-royal{
  background: linear-gradient(180deg, rgba(75,0,130,0.05), rgba(167,107,207,0.05));
  border:none;
  box-shadow: var(--card-shadow);
  border-radius:16px;
}
.category-name{ font-weight:700; font-size:0.95rem;}
.btn-gold{ background: var(--royal-gold); color:#3b2d1d; border:none;}
.btn-royal{ background: var(--royal-purple); color: var(--royal-gold); border:none;}
.btn-royal:hover{ background: var(--light-purple);}
.form-control:focus{ box-shadow:none; border-color: var(--royal-purple);}
.expense-input.over-limit{ border-color:red; background-color:#ffe6e6;}
footer{ margin-top:30px;color:#7a5a67;font-size:0.9rem;}
.note{ font-size:0.86rem; color:#8a5a6d;}
</style>
</head>
<body>
<div class="container py-4">
  <header class="mb-3">
    <h3 class="text-center mb-3">ğŸ‘‘ Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3>
    <div id="authContainer" class="text-center"></div>
  </header>

  <div id="app" style="display:none;">
    <div id="budgetContainer"></div>
    <canvas id="lineChart" height="150"></canvas>
  </div>

  <footer class="text-center mt-4">
    Ù…ØµÙ…Ù… Ù„ÙƒÙ â€” Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€¢ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø­Ø§Ø¨ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
  </footer>
</div>

<script>
// ===== Firebase config =====
const firebaseConfig = { apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw", authDomain:"budget-salary.firebaseapp.com", projectId:"budget-salary", storageBucket:"budget-salary.firebasestorage.app", messagingSenderId:"833349662009", appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8", measurementId:"G-0LS4TCBJYZ" };
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth(); const db=firebase.firestore();

// ===== DOM =====
const authContainer=document.getElementById('authContainer');
const app=document.getElementById('app');
const budgetContainer=document.getElementById('budgetContainer');

let tempEmail="", tempPassword="";

// ===== Login / Signup =====
function showLogin(){ /* Ù…Ù…Ø§Ø«Ù„ Ù„Ù„ÙƒÙˆØ¯ Ø§Ù„Ø³Ø§Ø¨Ù‚ */ }
function login(){ /* Ù…Ù…Ø§Ø«Ù„ */ }
function signupStep1(){ /* Ù…Ù…Ø§Ø«Ù„ */ }
function googleLogin(){ /* Ù…Ù…Ø§Ø«Ù„ */ }

auth.onAuthStateChanged(user=>{
  if(user){ authContainer.style.display='none'; app.style.display='block'; loadUserData(user.uid); }
  else{ authContainer.style.display='block'; app.style.display='none'; showLogin(); }
});

async function loadUserData(uid){
  const docSnap = await db.collection('users').doc(uid).get();
  if(!docSnap.exists){ budgetContainer.innerHTML="<div class='text-center'>Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>"; return; }
  renderBudget(docSnap.data(), uid);
}

// ===== Render Budget with Advanced Features =====
function renderBudget(data, uid){
  budgetContainer.innerHTML=`
  <div class="card p-3 card-royal">
    <h5 class="mb-3">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h5>
    <div id="expenseInputs"></div>
    <button id="addExpenseBtn" class="btn btn-outline-primary mb-2">Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
    <button id="endMonthBtn" class="btn btn-gold mb-2">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± â†’ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø§Ø¯Ø®Ø§Ø±</button>
    <div id="predictionsContainer" class="mb-2"></div>
    <div id="savingTipsContainer" class="mb-2 note"></div>
    <canvas id="pieChart" height="200"></canvas>
  </div>
  `;

  const expenseInputs=document.getElementById('expenseInputs');
  for(const cat in data.categories){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2";
    div.innerHTML=`<span class="category-name w-50">${cat}</span>
      <input type="number" class="form-control w-50 expense-input" placeholder="Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ" data-cat="${cat}" data-limit="${data.categories[cat]}">`;
    expenseInputs.appendChild(div);
  }

  document.getElementById('addExpenseBtn').onclick=async ()=>{
    const newExpenses={}; let overLimitCats=[];
    Array.from(document.getElementsByClassName('expense-input')).forEach(inp=>{
      const cat=inp.dataset.cat; const limit=parseFloat(inp.dataset.limit);
      const val=parseFloat(inp.value)||0; newExpenses[cat]=val;
      inp.classList.remove('over-limit');
      if(val>limit){ inp.classList.add('over-limit'); overLimitCats.push(cat);}
    });
    if(overLimitCats.length>0) alert("âš ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: "+overLimitCats.join(", "));

    data.dailyExpenses.push({date:new Date().toISOString().split('T')[0],expenses:newExpenses});
    await db.collection('users').doc(uid).update({dailyExpenses:data.dailyExpenses});
    renderChart(data); renderPredictions(data); renderSavingTips(data); renderLineChart(data);
  };

  document.getElementById('endMonthBtn').onclick=async ()=>{
    let totalSpent=0;
    for(const day of data.dailyExpenses) for(const cat in day.expenses) totalSpent+=day.expenses[cat];
    const totalBudget=Object.values(data.categories).reduce((a,b)=>a+b,0);
    const remaining=totalBudget-totalSpent;
    alert(`ØªÙ… ØªØ­ÙˆÙŠÙ„ ${remaining.toFixed(2)} Ø±ÙŠØ§Ù„ Ù„Ù„Ø§Ø¯Ø®Ø§Ø±`);
    data.categories["Ø§Ø¯Ø®Ø§Ø±"]=(data.categories["Ø§Ø¯Ø®Ø§Ø±"]||0)+remaining;
    await db.collection('users').doc(uid).update({categories:data.categories});
    renderChart(data); renderPredictions(data); renderSavingTips(data); renderLineChart(data);
  };

  renderChart(data); renderPredictions(data); renderSavingTips(data); renderLineChart(data);
}

// ===== Pie Chart with Color Indicators =====
function renderChart(data){
  const ctx=document.getElementById('pieChart').getContext('2d');
  const colors=Object.keys(data.categories).map(cat=>{
    const spent=data.dailyExpenses.reduce((sum,d)=>sum+(d.expenses[cat]||0),0);
    const limit=data.categories[cat]; const ratio=spent/limit;
    if(ratio<0.8) return "#4caf50"; // Ø£Ø®Ø¶Ø±
    else if(ratio<=1) return "#ffeb3b"; // Ø£ØµÙØ±
    else return "#f44336"; // Ø£Ø­Ù…Ø±
  });
  const chartData={ labels:Object.keys(data.categories), datasets:[{ data:Object.values(data.categories), backgroundColor:colors }]};
  if(window.myChart) window.myChart.destroy();
  window.myChart=new Chart(ctx,{type:'pie',data:chartData});
}

// ===== Predictions =====
function renderPredictions(data){
  const container=document.getElementById('predictionsContainer');
  container.innerHTML="<b>ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø±:</b><br>";
  const today=new Date().getDate(); const daysInMonth=new Date(new Date().getFullYear(),new Date().getMonth()+1,0).getDate();
  for(const cat in data.categories){
    const spent=data.dailyExpenses.reduce((sum,d)=>sum+(d.expenses[cat]||0),0);
    const remaining=data.categories[cat]-spent;
    const dailyPrediction=remaining/(daysInMonth-today);
    container.innerHTML+=`${cat}: ${dailyPrediction.toFixed(2)} Ø±ÙŠØ§Ù„ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…ØªÙˆÙ‚Ø¹<br>`;
  }
}

// ===== Saving Tips / AI Suggestions =====
function renderSavingTips(data){
  const container=document.getElementById('savingTipsContainer'); let tips=[];
  for(const cat in data.categories){
    const spent=data.dailyExpenses.reduce((sum,d)=>sum+(d.expenses[cat]||0),0);
    const limit=data.categories[cat];
    if(spent>limit) tips.push(`Ù‚Ù„Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚ ÙÙŠ ${cat} Ù„ØªÙˆÙÙŠØ± Ø£ÙƒØ«Ø±`);
    else if(spent<limit*0.5) tips.push(`ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„ÙØ§Ø¦Ø¶ Ù…Ù† ${cat} ÙÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±`);
  }
  container.innerHTML=tips.length?tips.join("<br>"):"Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµØ§Ø¦Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ø³ØªÙ…Ø±ÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸ‘";
}

// ===== Line Chart for Daily Expenses =====
function renderLineChart(data){
  const ctx=document.getElementById('lineChart').getContext('2d');
  const labels=data.dailyExpenses.map(d=>d.date);
  const datasets=Object.keys(data.categories).map(cat=>{
    const values=data.dailyExpenses.map(d=>d.expenses[cat]||0);
    return { label:cat, data:values, borderColor:'#'+Math.floor(Math.random()*16777215).toString(16), tension:0.2, fill:false};
  });
  if(window.myLineChart) window.myLineChart.destroy();
  window.myLineChart=new Chart(ctx,{type:'line',data:{labels, datasets}});
}
</script>
</body>
</html>
