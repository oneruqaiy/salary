<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>راتبي الذكي — تطبيق</title>

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --main-blue:#3b6bff;
  --light-gray:#f5f7fb;
  --card-shadow:0 8px 24px rgba(59,107,255,0.08);
  --accent-text:#122034;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background:var(--light-gray);
  color:var(--accent-text);
  -webkit-font-smoothing:antialiased;
}
#authContainer{
  max-width:420px;
  margin:90px auto;
  padding:18px;
  background:#fff;
  border-radius:14px;
  box-shadow:var(--card-shadow);
}
.btn-main{
  background:var(--main-blue); color:#fff; border:none;
  border-radius:10px; padding:10px 14px;
}
.btn-main:hover{ background:#597fff; }
.card-royal{
  background:#fff; border-radius:14px; padding:16px; box-shadow:var(--card-shadow); margin-bottom:16px;
}
input:focus, .form-control:focus{ box-shadow:none; border-color:var(--main-blue); }
.tabContent{ display:none; padding:14px 10px 80px 10px; } /* leave space for bottom nav */
.bottom-nav{
  position:fixed; bottom:0; left:0; width:100%; background:#fff; border-top:1px solid #eef2ff;
  display:flex; justify-content:space-around; padding:10px 6px; box-shadow:0 -6px 20px rgba(2,6,23,0.03); z-index:200;
  gap:6px;
}
.bottom-nav div{ flex:1; text-align:center; font-size:13px; color:#63708a; cursor:pointer; padding:6px 4px; border-radius:10px; }
.bottom-nav div.active{ color:var(--main-blue); font-weight:600; background:rgba(59,107,255,0.06);}
.app-shell{ max-width:980px; margin:0 auto; padding-bottom:100px; }

/* Daily form */
.row-expense{ display:flex; gap:10px; align-items:center; margin-bottom:10px; }
.row-expense .form-control{ border-radius:10px; padding:10px; }
.note-input{ min-height:44px; resize:vertical; }

/* Today's list */
.expense-list { margin-top:12px; display:flex; flex-direction:column; gap:10px; }
.expense-item{ display:flex; justify-content:space-between; gap:10px; align-items:center; padding:10px; border-radius:10px; background:#fbfdff; box-shadow:0 4px 14px rgba(2,6,23,0.03); }
.expense-left{ display:flex; flex-direction:column; gap:4px; }
.expense-meta{ font-size:13px; color:#667085; }
.expense-amount{ font-weight:700; color:var(--main-blue); font-size:16px; }

/* Weekly cards */
.weekly-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap:12px; margin-top:8px; }
.weekly-card{ background:#fff; border-radius:12px; padding:12px; box-shadow:var(--card-shadow); }
.days-row{ display:flex; gap:6px; flex-wrap:wrap; margin-top:8px; }
.day-pill{ background:#f6f8ff; padding:6px 8px; border-radius:8px; font-size:13px; color:#334155; min-width:48px; text-align:center; }

/* category summary */
.cat-summary{ margin-top:10px; padding-top:8px; border-top:1px dashed #eef2ff; display:flex; justify-content:space-between; align-items:center; gap:10px; }
.cat-summary small{ color:#64748b; }

/* footer totals */
.totals-card{ position:relative; margin-top:12px; padding:10px 12px; border-radius:12px; background:linear-gradient(90deg,#eef5ff,#fff); box-shadow:var(--card-shadow); display:flex; justify-content:space-between; align-items:center; }

/* responsiveness */
@media(max-width:480px){
  .row-expense{ flex-direction:column; align-items:stretch; }
  .card-royal{ padding:12px; }
  #authContainer{ margin:40px 12px; }
}
</style>
</head>
<body>

<!-- Login container -->
<div id="authContainer"></div>

<!-- App -->
<div id="app" class="app-shell" style="display:none;">
  <div id="welcomeUser" class="h5 text-center" style="margin:18px 0 6px 0"></div>

  <!-- Tabs -->
  <div id="dailyTab" class="tabContent"></div>
  <div id="weeklyTab" class="tabContent"></div>
  <div id="accountTab" class="tabContent"></div>

  <!-- Bottom navigation -->
  <div class="bottom-nav">
    <div data-tab="dailyTab" class="active">🏷️ تسجيل المصروف</div>
    <div data-tab="weeklyTab">📊 التحليلات الأسبوعية</div>
    <div data-tab="accountTab">⚙️ حسابك</div>
    <div onclick="logout()">🚪 خروج</div>
  </div>
</div>

<script>
/* ====== Firebase config (استخدمت نفس بياناتك السابقة) ====== */
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* DOM refs */
const authContainer = document.getElementById('authContainer');
const app = document.getElementById('app');
const welcomeUser = document.getElementById('welcomeUser');

/* ===== Login / Signup UI ===== */
function showLogin(){
  authContainer.innerHTML = `
    <h5 class="mb-3 text-center">تسجيل الدخول أو إنشاء حساب</h5>
    <input type="email" id="email" class="form-control mb-2" placeholder="البريد الإلكتروني" />
    <input type="password" id="password" class="form-control mb-2" placeholder="كلمة المرور" />
    <button class="btn btn-main w-100 mb-2" onclick="login()">تسجيل الدخول</button>
    <button class="btn btn-outline-primary w-100 mb-2" onclick="signupStep1()">إنشاء حساب</button>
    <button class="btn w-100" style="border-radius:10px" onclick="googleLogin()">تسجيل بـ Google</button>
  `;
}
function login(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if(!email || !password) { alert('الرجاء إدخال البريد وكلمة المرور'); return; }
  auth.signInWithEmailAndPassword(email, password).catch(err=>alert(err.message));
}
function signupStep1(){
  const email = document.getElementById('email').value.trim();
  const password = document.getElementById('password').value;
  if(!email || !password) { alert('الرجاء إدخال البريد وكلمة المرور'); return; }
  auth.createUserWithEmailAndPassword(email, password).then(cred=>{
    // default user doc
    db.collection('users').doc(cred.user.uid).set({
      categories: { "مأكل": 200, "نقل": 100, "ترفيه": 50 }, // أمثلة - المستخدم سيعدلها لاحقًا
      dailyExpenses: [],
      salary: 0,
      incomeSources: 0,
      loans: 0,
      lastSalaryDate: null
    });
  }).catch(err=>alert(err.message));
}
function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err=>alert(err.message));
}
function logout(){ auth.signOut(); }

/* ===== bottom nav behavior ===== */
document.querySelectorAll('.bottom-nav div[data-tab]').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const tab = btn.dataset.tab;
    showTab(tab);
    document.querySelectorAll('.bottom-nav div').forEach(d=>d.classList.remove('active'));
    btn.classList.add('active');
  });
});
function showTab(tabId){
  document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
  const el = document.getElementById(tabId);
  if(el) el.style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

/* ===== auth state ===== */
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display = 'none';
    app.style.display = 'block';
    welcomeUser.textContent = `أهلاً، ${user.email || user.displayName || 'المستخدم'} 👋`;
    loadUserData(user.uid);
  } else {
    authContainer.style.display = 'block';
    app.style.display = 'none';
    showLogin();
  }
});

/* ===== Load user data and render tabs ===== */
let currentUserData = null;
async function loadUserData(uid){
  const doc = await db.collection('users').doc(uid).get();
  if(!doc.exists){
    alert('خطأ: لا توجد بيانات للمستخدم.');
    return;
  }
  currentUserData = doc.data();
  // ensure structure
  currentUserData.dailyExpenses = currentUserData.dailyExpenses || [];
  currentUserData.categories = currentUserData.categories || {};
  // render tabs
  renderDailyTab(currentUserData, uid);
  renderWeeklyTab(currentUserData);
  renderAccountTab(currentUserData, uid);
  // open daily by default
  showTab('dailyTab');
  document.querySelector('.bottom-nav div[data-tab="dailyTab"]').classList.add('active');
}

/* ===== Helper: format date to YYYY-MM-DD ===== */
function yyyy_mm_dd(d){
  const dt = new Date(d);
  const year = dt.getFullYear();
  const m = (dt.getMonth()+1).toString().padStart(2,'0');
  const day = dt.getDate().toString().padStart(2,'0');
  return `${year}-${m}-${day}`;
}

/* ===== Daily Tab (تسجيل المصاريف) ===== */
function renderDailyTab(data, uid){
  const container = document.getElementById('dailyTab');
  container.style.display = 'block';
  // build category options
  const categories = Object.keys(data.categories || {});
  let catOptions = categories.length ? categories.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('') : '<option value="">لا توجد أقسام بعد</option>';

  container.innerHTML = `
    <div class="card-royal">
      <h5>🏷️ تسجيل مصروف جديد</h5>
      <div style="margin-top:8px;" class="row-expense">
        <select id="expenseCategory" class="form-control mb-1" style="min-width:160px;">
          ${catOptions}
        </select>
        <input id="expenseAmount" type="number" class="form-control mb-1" placeholder="المبلغ" />
      </div>
      <textarea id="expenseNote" class="form-control note-input mb-2" placeholder="سبب / فيما تم صرف المبلغ (مثلاً: غداء، تكسي، هدّية)"></textarea>
      <div class="d-flex gap-2">
        <button class="btn btn-main flex-grow-1" id="addExpenseBtn">إضافة مصروف</button>
        <input type="date" id="expenseDate" class="form-control" value="${new Date().toISOString().split('T')[0]}" style="max-width:160px;border-radius:10px;"/>
      </div>

      <div style="margin-top:14px;">
        <h6>قائمة مصروفات اليوم</h6>
        <div id="todayList" class="expense-list"></div>
      </div>
    </div>
  `;

  // fill today's list initially
  populateTodayList(data);

  // add handler
  document.getElementById('addExpenseBtn').onclick = async ()=>{
    const cat = document.getElementById('expenseCategory').value;
    const amount = parseFloat(document.getElementById('expenseAmount').value) || 0;
    const note = document.getElementById('expenseNote').value.trim();
    const date = document.getElementById('expenseDate').value || yyyy_mm_dd(new Date());
    if(!cat){ alert('الرجاء اختيار القسم'); return; }
    if(amount <= 0){ alert('أدخل مبلغ صحيح أكبر من 0'); return; }
    // create entry
    const entry = { date, category: cat, amount, note, ts: new Date().toISOString() };
    // push to local copy and update firestore
    currentUserData.dailyExpenses.push(entry);
    await db.collection('users').doc(uid).update({ dailyExpenses: currentUserData.dailyExpenses });
    // reset input
    document.getElementById('expenseAmount').value = '';
    document.getElementById('expenseNote').value = '';
    // refresh lists
    populateTodayList(currentUserData);
    // optional: show success
    // alert('تمت الإضافة');
  };
}

/* Populate today's expense list (for selected date) */
function populateTodayList(data){
  const listEl = document.getElementById('todayList');
  if(!listEl) return;
  const selectedDate = document.getElementById('expenseDate') ? document.getElementById('expenseDate').value : yyyy_mm_dd(new Date());
  // filter entries that match date
  const todays = (data.dailyExpenses || []).filter(e => e.date === selectedDate);
  // sort by timestamp (recent first)
  todays.sort((a,b)=> new Date(b.ts) - new Date(a.ts));
  if(todays.length === 0){
    listEl.innerHTML = `<div class="text-muted" style="padding:8px 4px">لا يوجد مصروفات لهذا التاريخ.</div>`;
    return;
  }
  listEl.innerHTML = '';
  todays.forEach(entry=>{
    const div = document.createElement('div');
    div.className = 'expense-item';
    div.innerHTML = `
      <div class="expense-left">
        <div style="display:flex; gap:8px; align-items:center;">
          <div style="font-weight:700; color:#0f1724;">${escapeHtml(entry.category)}</div>
          <div class="expense-meta">• ${escapeHtml(entry.note || '-')}</div>
        </div>
        <div class="expense-meta">${entry.date} • ${new Date(entry.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
      </div>
      <div style="text-align:right">
        <div class="expense-amount">${formatCurrency(entry.amount)}</div>
        <!-- optional: remove/edit buttons could go here -->
      </div>
    `;
    listEl.appendChild(div);
  });
}

/* ===== Weekly Tab (تفاصيل كاملة خلال آخر 7 أيام) ===== */
function renderWeeklyTab(data){
  const container = document.getElementById('weeklyTab');
  container.style.display = 'block';
  container.innerHTML = `
    <div style="display:flex; gap:10px; align-items:center; justify-content:space-between;">
      <h5>📊 التحليلات الأسبوعية</h5>
      <small class="text-muted">آخر 7 أيام</small>
    </div>

    <div id="weeklyContent" style="margin-top:10px;">
      <!-- weekly content will be injected here -->
    </div>
  `;

  const weeklyContent = document.getElementById('weeklyContent');
  const today = new Date();
  const days = [];
  for(let i=6;i>=0;i--){
    const d = new Date();
    d.setDate(today.getDate()-i);
    days.push( yyyy_mm_dd(d) );
  }

  // Filter expenses within last 7 days
  const inRange = (data.dailyExpenses || []).filter(e => days.includes(e.date));
  // sort by date desc then time desc
  inRange.sort((a,b)=>{
    if(a.date === b.date) return new Date(b.ts) - new Date(a.ts);
    return new Date(b.date) - new Date(a.date);
  });

  // Build per-category grouping and totals
  const categories = Object.keys(data.categories || {});
  const catTotals = {}; // total per category this week
  categories.forEach(c=> catTotals[c]=0);

  inRange.forEach(entry=>{
    if(!(entry.category in catTotals)) catTotals[entry.category] = 0;
    catTotals[entry.category] += entry.amount;
  });

  // Build top: full list grouped by day with full details (each entry shown)
  // We'll show a vertical list of days; under each day show entries (with duplicates displayed)
  let html = '';

  // For each day show day header and entries
  days.forEach(day=>{
    const entries = inRange.filter(e=>e.date===day);
    if(entries.length === 0) return; // skip day with no entries
    html += `<div class="card-royal" style="padding:12px 14px; margin-bottom:10px;">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>${formatFriendlyDate(day)}</strong><div style="font-size:13px;color:#64748b">اليوم: ${day}</div></div>
        <div style="font-weight:700;color:var(--main-blue)">${formatCurrency(entries.reduce((s,x)=>s+x.amount,0))}</div>
      </div>
      <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">
    `;
    // each entry
    entries.forEach(en=>{
      html += `<div style="display:flex; justify-content:space-between; align-items:center; gap:10px; padding:8px; border-radius:10px; background:#fbfdff;">
        <div style="flex:1 1 60%;">
          <div style="font-weight:600">${escapeHtml(en.category)}</div>
          <div style="font-size:13px;color:#64748b">${escapeHtml(en.note || '-')}</div>
          <div style="font-size:12px;color:#94a3b8;margin-top:6px">${new Date(en.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
        </div>
        <div style="text-align:right">
          <div style="font-weight:700;color:var(--main-blue)">${formatCurrency(en.amount)}</div>
        </div>
      </div>`;
    });

    html += `</div></div>`; // close card
  });

  // If there are no entries at all
  if(inRange.length === 0){
    html += `<div class="card-royal text-center"><div class="text-muted">لا توجد مصروفات في آخر 7 أيام.</div></div>`;
  }

  // Append per-category summaries grid
  html += `<div style="margin-top:6px;"><h6>ملخص الأقسام (خلال الأسبوع)</h6>
    <div class="weekly-grid" id="catSummaries"></div></div>`;

  // Append total card placeholder
  html += `<div id="overallTotals"></div>`;

  weeklyContent.innerHTML = html;

  // Fill category summaries
  const catSummariesEl = document.getElementById('catSummaries');
  const totalAll = Object.values(catTotals).reduce((s,x)=>s+x,0);

  // Ensure categories that had no allocation but have spending show too
  const allCats = new Set([...Object.keys(data.categories||{}), ...Object.keys(catTotals||{})]);

  allCats.forEach(cat=>{
    const alloc = data.categories && data.categories[cat] ? data.categories[cat] : 0;
    const spent = catTotals[cat] || 0;
    const remaining = alloc - spent;
    const card = document.createElement('div');
    card.className = 'weekly-card';
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>${escapeHtml(cat)}</strong><div style="font-size:13px;color:#64748b">المخصص: ${formatCurrency(alloc)}</div></div>
        <div style="text-align:right">
          <div style="font-weight:700;color:var(--main-blue)">${formatCurrency(spent)}</div>
          <div style="font-size:13px;color:${remaining<0?'#ef4444':'#16a34a'}">${remaining<0? 'تجاوز بـ '+formatCurrency(Math.abs(remaining)) : 'المتبقي '+formatCurrency(remaining)}</div>
        </div>
      </div>

      <div style="margin-top:8px; font-size:13px; color:#475569">
        <small>تفاصيل: عرض كل مرات الصرف من هذا القسم خلال الأسبوع أدناه</small>
      </div>
    `;
    // list of entries for this category
    const entriesList = (inRange.filter(e=>e.category===cat)).map(en=>{
      return `<div style="margin-top:8px;padding:8px;border-radius:8px;background:#fbfdff;display:flex;justify-content:space-between;align-items:center;">
        <div style="font-size:13px;">
          <div style="font-weight:600">${escapeHtml(en.note || '-')}</div>
          <div style="color:#64748b;font-size:12px">${en.date} • ${new Date(en.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
        </div>
        <div style="font-weight:700;color:var(--main-blue)">${formatCurrency(en.amount)}</div>
      </div>`;
    }).join('');

    const entriesWrapper = document.createElement('div');
    entriesWrapper.style.marginTop = '8px';
    entriesWrapper.innerHTML = entriesList || `<div style="margin-top:8px;color:#9aa6b2;font-size:13px">لا توجد مصروفات لهذا القسم هذا الأسبوع</div>`;
    card.appendChild(entriesWrapper);
    catSummariesEl.appendChild(card);
  });

  // Overall totals
  const overallEl = document.getElementById('overallTotals');
  overallEl.innerHTML = `
    <div class="totals-card">
      <div>
        <div style="font-size:13px;color:#334155">إجمالي المصروف خلال الأسبوع</div>
        <div style="font-weight:800; font-size:18px; margin-top:6px">${formatCurrency(totalAll)}</div>
      </div>
      <div style="text-align:right">
        <div style="font-size:13px;color:#334155">عدد القيود</div>
        <div style="font-weight:700; font-size:16px; margin-top:6px">${inRange.length}</div>
      </div>
    </div>
  `;
}

/* ===== Account Tab (تعديل الأقسام والراتب) ===== */
function renderAccountTab(data, uid){
  const container = document.getElementById('accountTab');
  container.style.display = 'block';
  // build categories list rows
  const rows = Object.keys(data.categories || {}).map(cat=>{
    const val = data.categories[cat];
    return `<div class="d-flex gap-2 mb-2">
      <input type="text" class="form-control category-name-input" value="${escapeHtml(cat)}" placeholder="اسم القسم"/>
      <input type="number" class="form-control category-alloc-input" value="${val}" placeholder="المبلغ"/>
    </div>`;
  }).join('');

  container.innerHTML = `
    <div class="card-royal">
      <h5>⚙️ حسابك وتخصيص الأقسام</h5>
      <div style="margin-top:8px;">
        <label>الراتب (اختياري)</label>
        <input id="salaryEdit" type="number" class="form-control mb-2" value="${data.salary || 0}" />
        <label>قائمة الأقسام والمخصص لكل قسم</label>
        <div id="editCategoriesContainer">${rows}</div>
        <button id="addEditCategoryBtn" class="btn btn-outline-primary mb-2 w-100">إضافة قسم جديد</button>
        <button id="saveAccountBtn" class="btn btn-main w-100">حفظ التعديلات</button>
      </div>

      <div style="margin-top:12px;">
        <h6>معلومات سريعة</h6>
        <div style="font-size:13px;color:#64748b">المصروفات المخزنة: <strong>${(data.dailyExpenses||[]).length}</strong> قيد</div>
      </div>
    </div>
  `;

  const editContainer = document.getElementById('editCategoriesContainer');
  function addEditRow(name="", alloc=""){
    const div = document.createElement('div');
    div.className = 'd-flex gap-2 mb-2';
    div.innerHTML = `<input type="text" class="form-control category-name-input" value="${escapeHtml(name)}" placeholder="اسم القسم"/>
      <input type="number" class="form-control category-alloc-input" value="${alloc || 0}" placeholder="المبلغ"/>`;
    editContainer.appendChild(div);
  }
  document.getElementById('addEditCategoryBtn').onclick = ()=> addEditRow();

  document.getElementById('saveAccountBtn').onclick = async ()=>{
    const salary = parseFloat(document.getElementById('salaryEdit').value) || 0;
    const names = Array.from(document.getElementsByClassName('category-name-input'));
    const allocs = Array.from(document.getElementsByClassName('category-alloc-input'));
    const categories = {};
    for(let i=0;i<names.length;i++){
      const n = names[i].value.trim();
      const a = parseFloat(allocs[i].value) || 0;
      if(n) categories[n]=a;
    }
    await db.collection('users').doc(auth.currentUser.uid).update({ salary, categories });
    // reload data
    await loadUserData(auth.currentUser.uid);
    alert('تم حفظ التعديلات!');
  };
}

/* ===== utilities ===== */
function formatCurrency(n){
  // format with 2 decimal or integer if whole
  const v = Number(n) || 0;
  if(Number.isInteger(v)) return v + ' ريال';
  return v.toFixed(2) + ' ريال';
}
function formatFriendlyDate(iso){
  const d = new Date(iso);
  // produce Arabic friendly like: الخميس 23/10
  const daysAr = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
  return `${daysAr[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}`;
}
function escapeHtml(s){
  if(s===null || s===undefined) return '';
  return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
}

/* update today's list when date changed */
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'expenseDate'){
    // refresh today list if present
    if(currentUserData) populateTodayList(currentUserData);
  }
});
</script>

</body>
</html>
