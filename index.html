<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>راتــب | إدارة المصاريف</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --main-blue:#3b6bff;
  --light-gray:#f5f5f5;
  --card-shadow:0 6px 18px rgba(0,0,128,0.08);
  --accent-text:#2c003e;
  --success-green:#28a745;
  --danger-red:#dc3545;
}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--light-gray);
  color: var(--accent-text);
  padding-top:10px;
}
#authContainer{
  max-width:400px;
  margin:100px auto;
  padding:20px;
  background:#fff;
  border-radius:16px;
  box-shadow:var(--card-shadow);
}
.btn-main{
  background: var(--main-blue);
  color:#fff;
  border:none;
}
.btn-main:hover{
  background:#5a82ff;
  color:#fff;
}
.card-royal{
  background:#fff;
  border:none;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:var(--card-shadow);
}
input:focus, .form-control:focus, select:focus{
  box-shadow:0 0 0 0.25rem rgba(59, 107, 255, 0.25) !important;
  border-color: var(--main-blue) !important;
}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.tabContent{display:none; padding-top:10px;}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  border-top:1px solid #ddd;
  padding:8px 0;
  box-shadow:0 -2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.bottom-nav div{
  flex:1;
  text-align:center;
  cursor:pointer;
  font-size:14px;
  color:#333;
  transition:color 0.2s;
}
.bottom-nav div i{
    display:block;
    font-size:18px;
    margin-bottom:2px;
}
.bottom-nav .active{color:var(--main-blue); font-weight:bold;}

/* Dashboard Cards */
.dashboard-grid{
    display:flex;
    gap:10px;
    margin-bottom:20px;
    flex-wrap:wrap;
    justify-content:center;
}
.dashboard-item{
    flex:1 1 30%;
    min-width:120px;
    text-align:center;
    padding:10px;
    border-radius:12px;
    color:#fff;
    font-size:14px;
    box-shadow:0 4px 12px rgba(0,0,0,0.1);
}
.dashboard-item h6{font-size:16px; margin-bottom:5px;}
.db-main{background:linear-gradient(45deg, #0d6efd, #3b6bff);}
.db-secondary{background:linear-gradient(45deg, #28a745, #15c363);}
.db-danger{background:linear-gradient(45deg, #dc3545, #e05361);}

/* Daily and Weekly List */
.daily-expense-item, .weekly-expense-item{
    display:flex;
    justify-content:space-between;
    align-items:center;
    padding:10px 15px;
    border-bottom:1px solid #eee;
    font-size:14px;
}
.daily-expense-item:last-child, .weekly-expense-item:last-child{border-bottom:none;}
.exp-details{flex-grow:1; text-align:right;}
.exp-category{font-weight:bold;}
.exp-amount{color:var(--danger-red); font-weight:bold;}

/* Weekly Tab Styling */
.weekly-day-box{padding:10px 15px; margin-bottom:10px; border-radius:12px; background:#fefefe; box-shadow:0 2px 8px rgba(0,0,0,0.05);}
.weekly-day-box h6{font-size:16px; border-bottom:1px solid #ddd; padding-bottom:5px; margin-bottom:10px; color:var(--main-blue);}
.category-status{font-size:13px; margin-top:10px; padding-top:5px; border-top:1px dashed #eee;}
.status-bar-container{background:#eee; border-radius:5px; margin-top:5px; overflow:hidden;}
.status-bar{height:8px; border-radius:5px 0 0 5px; transition:width 0.5s ease-out;}
.status-bar.green{background:var(--success-green);}
.status-bar.red{background:var(--danger-red);}

/* Accounts Tab Styles (Bank Cards) */
.accounts-grid{display:flex; gap:16px; flex-wrap:wrap; justify-content:center;}
.bank-card{
  width:280px;
  height:160px;
  border-radius:14px;
  color:white;
  padding:14px;
  position:relative;
  box-shadow:0 6px 20px rgba(0,0,0,0.12);
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.bank-card .card-top{display:flex; justify-content:space-between; align-items:start;}
.bank-card .card-balance{font-size:24px; font-weight:700;}
.bank-card .card-name{font-size:14px; opacity:0.8;}
.bank-card .card-logo{width:52px; height:32px; filter:brightness(0) invert(1); opacity:0.95;}
.bank-actions{display:flex; gap:8px; margin-top:8px;}
.small-btn{padding:4px 8px; border-radius:6px; font-size:12px; border:none; cursor:pointer; font-weight:500;}
.small-btn.primary{background:rgba(255,255,255,0.2); color:#fff; transition:background 0.2s;}
.small-btn.primary:hover{background:rgba(255,255,255,0.4);}
.small-btn.danger{background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.08); transition:background 0.2s;}
.small-btn.danger:hover{background:rgba(255,255,255,0.3);}

/* gradients */
.grad-blue{background:linear-gradient(135deg,#2b6df6,#4369ff);}
.grad-purple{background:linear-gradient(135deg,#7b61ff,#d66bff);}
.grad-gold{background:linear-gradient(135deg,#f59e0b,#f97316);}

@media(max-width:767px){
    .dashboard-item{flex:1 1 45%;}
    .bank-card{width:90%; height:150px;}
    .bottom-nav div{font-size:12px;}
}
</style>
</head>
<body>

<div id="authContainer"></div>

<div id="app" style="display:none; max-width:1000px; margin:0 auto; padding-bottom:80px;">
  <div id="welcomeUser" class="h5 mb-3 text-center" style="padding-top:10px;"></div>

  <div id="dailyTab" class="tabContent"></div>
  <div id="weeklyTab" class="tabContent"></div>
  <div id="accountsTab" class="tabContent"></div>
  <div id="accountTab" class="tabContent"></div>

  <div class="bottom-nav">
    <div data-tab="daily" class="active"><i class="fas fa-wallet"></i> المصاريف اليومية</div>
    <div data-tab="accounts"><i class="fas fa-credit-card"></i> حساباتي</div>         
    <div data-tab="weekly"><i class="fas fa-chart-bar"></i> التحليلات الأسبوعية</div>  
    <div data-tab="account"><i class="fas fa-cog"></i> حسابك</div>
    <div onclick="logout()"><i class="fas fa-sign-out-alt"></i> خروج</div>
  </div>
</div>

<script>
// =================================================================
// 1. Firebase Configuration & Init
// 
// 🔴🔴🔴 هام: قم بتغيير هذه القيم إلى قيم مشروعك الفعلي في Firebase 🔴🔴🔴
// =================================================================
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw", 
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

// DOM elements
const authContainer=document.getElementById('authContainer');
const app=document.getElementById('app');
const welcomeUser=document.getElementById('welcomeUser');

// سيتم جلب الحسابات من Firebase
let accounts = [];


// =================================================================
// 2. Auth Functions
// =================================================================
function showLogin(){
  authContainer.innerHTML=`
    <div class="card card-royal">
      <h4 class="text-center mb-4 text-primary">راتــب</h4>
      <input type="email" id="email" class="form-control mb-2" placeholder="البريد الإلكتروني">
      <input type="password" id="password" class="form-control mb-3" placeholder="كلمة المرور">
      <button class="btn btn-main w-100 mb-2" onclick="login()">تسجيل الدخول</button>
      <button class="btn btn-outline-primary w-100 mb-2" onclick="signup()">إنشاء حساب جديد</button>
      <div class="text-center my-2">أو</div>
      <button class="btn btn-outline-secondary w-100" onclick="googleLogin()"><i class="fab fa-google"></i> تسجيل بـ Google</button>
    </div>
  `;
}
function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert("خطأ في الدخول: "+err.message));
}
function signup(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  if(password.length < 6){ alert("كلمة المرور يجب أن لا تقل عن 6 أحرف"); return; }
  auth.createUserWithEmailAndPassword(email,password).then(cred=>{
    // إنشاء مستند المستخدم الأولي (تم إضافة حقل accounts)
    db.collection('users').doc(cred.user.uid).set({
      categories:{}, dailyExpenses:[], salary:0, incomeSources:0, loans:0, lastSalaryDate:null,
      accounts: [] 
    });
    alert("تم إنشاء الحساب بنجاح! الرجاء إدخال بيانات الراتب والميزانية.");
  }).catch(err=>alert("خطأ في التسجيل: "+err.message));
}
function googleLogin(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err=>alert("خطأ في Google: "+err.message));
}
function logout(){ auth.signOut(); }

// =================================================================
// 3. Navigation & Auth State
// =================================================================
document.querySelectorAll('.bottom-nav div[data-tab]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
    document.getElementById(btn.dataset.tab+'Tab').style.display='block';
    document.querySelectorAll('.bottom-nav div').forEach(d=>d.classList.remove('active'));
    btn.classList.add('active');
    
    // Refresh UI on tab switch
    const uid = auth.currentUser ? auth.currentUser.uid : null;
    if(uid){
      if(btn.dataset.tab==='accounts') loadUserData(uid, false, true); // تحديث الحسابات
      // إذا كان التاب هو Daily أو Weekly أو Account (الإعدادات)
      if(btn.dataset.tab==='daily' || btn.dataset.tab==='weekly' || btn.dataset.tab==='account') loadUserData(uid, false); 
    }
  });
});

auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display='none';
    app.style.display='block';
    welcomeUser.textContent=`👋 أهلاً، ${user.email}`;
    loadUserData(user.uid);
  } else{
    authContainer.style.display='block';
    app.style.display='none';
    showLogin();
  }
});

// Load User Data
async function loadUserData(uid, forceTabSwitch = true, forceAccountsRender = false){
  const docSnap = await db.collection('users').doc(uid).get();
  if(!docSnap.exists){ alert("خطأ: البيانات غير موجودة"); return; }
  const data=docSnap.data();

  // يتم تحديث متغير accounts من بيانات Firebase
  accounts = data.accounts || [];

  if(!data.salary || Object.keys(data.categories).length===0){
    renderInitialSetup(uid, data);
    return;
  }
  
  renderDailyTab(data, uid);
  renderWeeklyTab(data, uid);
  renderAccountTab(data, uid);
  
  if(forceAccountsRender || document.querySelector('.bottom-nav div[data-tab="accounts"]').classList.contains('active')){
     renderAccounts(data, uid);
  }

  if(forceTabSwitch){
    setTimeout(() => {
      document.querySelector('.bottom-nav div[data-tab="daily"]').click();
    }, 10);
  }
}


// =================================================================
// 4. Initial Setup
// =================================================================
function renderInitialSetup(uid, data){
  const container=document.getElementById('dailyTab');
  document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
  container.style.display='block';
  document.querySelectorAll('.bottom-nav div').forEach(d=>d.classList.remove('active'));
  document.querySelector('.bottom-nav div[data-tab="daily"]').classList.add('active');

  container.innerHTML=`
    <div class="card card-royal mx-auto" style="max-width:520px;">
      <h5 class="text-center text-primary mb-4">أهلاً بك! لنبدأ بإعداد الميزانية</h5>
      
      <h6>الخطوة 1: بيانات الراتب والدخل 💰</h6>
      <input type="number" id="salaryInput" class="form-control mb-2" placeholder="راتبك الأساسي الشهري" value="${data.salary||''}">
      <input type="number" id="incomeInput" class="form-control mb-2" placeholder="مصادر دخل أخرى (شهرية/تقريبية)" value="${data.incomeSources||''}">
      <input type="number" id="loansInput" class="form-control mb-3" placeholder="قروض / التزامات شهرية ثابتة" value="${data.loans||''}">
      
      <h6 class="mt-3">الخطوة 2: ميزانية الأقسام 🏷️</h6>
      <p class="text-muted small">وزّع باقي المبلغ على أقسام مصاريفك (مثلاً: البقالة، المواصلات، الترفيه).</p>
      <div id="userCategoriesContainer"></div>
      <button id="addCategoryBtn" class="btn btn-outline-primary btn-sm mb-2 w-100"><i class="fas fa-plus-circle"></i> إضافة قسم</button>
      <div id="totalAllocated" class="text-end fw-bold mb-3"></div>
      
      <button id="saveSetupBtn" class="btn btn-main mt-4 w-100"><i class="fas fa-save"></i> حفظ وبدء الاستخدام</button>
    </div>
  `;
  const userCategoriesContainer=document.getElementById('userCategoriesContainer');
  const totalAllocated = document.getElementById('totalAllocated');
  
  function updateAllocationSummary(){
      const salary=parseFloat(document.getElementById('salaryInput').value)||0;
      const income=parseFloat(document.getElementById('incomeInput').value)||0;
      const loans=parseFloat(document.getElementById('loansInput').value)||0;
      const netSalary = salary + income - loans;
      
      const allocInputs=document.getElementsByClassName('category-alloc-input');
      let totalAlloc=0;
      for(let i=0;i<allocInputs.length;i++){
          totalAlloc += parseFloat(allocInputs[i].value)||0;
      }
      
      const remaining = netSalary - totalAlloc;
      let cls = remaining >= 0 ? 'text-success' : 'text-danger';
      totalAllocated.innerHTML = `المبلغ المتبقي للتوزيع: <span class="${cls}">${remaining.toFixed(2)}</span> ريال`;
  }
  
  function addCategoryRow(name="",alloc=""){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2 align-items-center";
    div.innerHTML=`
      <input type="text" class="form-control category-name-input" placeholder="اسم القسم" value="${name}">
      <input type="number" class="form-control category-alloc-input" placeholder="المبلغ المخصص" value="${alloc}" oninput="updateAllocationSummary()">
      <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove(); updateAllocationSummary()"><i class="fas fa-times"></i></button>
    `;
    userCategoriesContainer.appendChild(div);
  }
  
  // Initial rows based on existing or default
  if(Object.keys(data.categories).length > 0){
      for(const cat in data.categories) addCategoryRow(cat,data.categories[cat]);
  } else {
      addCategoryRow('البقالة', 1000);
      addCategoryRow('المواصلات', 400);
      addCategoryRow('الترفيه', 300);
  }
  
  // Event listeners
  document.getElementById('addCategoryBtn').onclick=()=> addCategoryRow();
  document.getElementById('salaryInput').oninput=updateAllocationSummary;
  document.getElementById('incomeInput').oninput=updateAllocationSummary;
  document.getElementById('loansInput').oninput=updateAllocationSummary;

  updateAllocationSummary(); // Initial calculation

  document.getElementById('saveSetupBtn').onclick=async ()=>{
    const salary=parseFloat(document.getElementById('salaryInput').value)||0;
    const income=parseFloat(document.getElementById('incomeInput').value)||0;
    const loans=parseFloat(document.getElementById('loansInput').value)||0;
    const nameInputs=document.getElementsByClassName('category-name-input');
    const allocInputs=document.getElementsByClassName('category-alloc-input');
    let categoriesObj={};
    let totalAlloc=0;
    for(let i=0;i<nameInputs.length;i++){
      const name=nameInputs[i].value.trim();
      const alloc=parseFloat(allocInputs[i].value)||0;
      if(name){
        categoriesObj[name]=alloc;
        totalAlloc += alloc;
      }
    }
    
    if(Object.keys(categoriesObj).length===0){ alert("الرجاء إدخال قسم واحد على الأقل"); return; }
    
    // Check allocation consistency (optional, but good practice)
    const netSalary = salary + income - loans;
    if(totalAlloc > netSalary){
        if(!confirm(`تنبيه: المبلغ المخصص (${totalAlloc.toFixed(2)}) أكبر من صافي دخلك (${netSalary.toFixed(2)})! هل تريد الاستمرار؟`)) return;
    }

    await db.collection('users').doc(uid).update({
      salary:salary,
      incomeSources:income,
      loans:loans,
      categories:categoriesObj,
      dailyExpenses:[],
      lastSalaryDate:new Date().toISOString().split('T')[0], // Set initial salary date
      accounts: [] // ضمان وجود حقل accounts
    });
    alert("تم حفظ إعدادات الميزانية بنجاح! يمكنك الآن تسجيل مصاريفك.");
    loadUserData(uid);
  };
}

// =================================================================
// 5. Daily Tab - Main Screen
// =================================================================
function renderDailyTab(data, uid){
  const container=document.getElementById('dailyTab');
  // Calculation Summary
  const netSalary = data.salary + data.incomeSources - data.loans; // صافي الدخل
  const categoriesTotal = Object.values(data.categories).reduce((sum, val)=>sum+val, 0); 
  const totalSpent = data.dailyExpenses.reduce((sum, exp)=>sum+exp.amount, 0); // إجمالي المصاريف
  
  // الحسبة الجديدة: صافي الدخل - إجمالي المصاريف 
  const currentRemaining = netSalary - totalSpent; 

  const today = new Date().toISOString().split('T')[0];

  // build account options for select
  const accOptions = accounts.map(a=>`<option value="${a.name}">${a.name} — ${a.balance.toFixed(2)} ريال</option>`).join('');
  
  container.innerHTML=`
    <div class="dashboard-grid">
      <div class="dashboard-item db-main">
        <h6>صافي الدخل</h6>
        <span>${netSalary.toFixed(2)} ريال</span>
      </div>
      <div class="dashboard-item db-secondary">
        <h6>الميزانية المتبقية (صافي الدخل - المصاريف)</h6>
        <span>${currentRemaining.toFixed(2)} ريال</span>
      </div>
      <div class="dashboard-item db-danger">
        <h6>إجمالي المصاريف</h6>
        <span>${totalSpent.toFixed(2)} ريال</span>
      </div>
    </div>
    
    <div class="card card-royal" style="max-width:720px; margin:auto;">
      <h5 class="mb-3 text-center text-main"><i class="fas fa-edit"></i> تسجيل مصروف جديد</h5>
      <div class="mb-3 row">
        <div class="col-md-6 mb-2">
            <label class="form-label small fw-bold">التاريخ</label>
            <input type="date" id="expenseDate" class="form-control" value="${today}">
        </div>
        <div class="col-md-6 mb-2">
            <label class="form-label small fw-bold">من أي حساب سيتم السحب</label>
            <select id="expenseAccount" class="form-select">
              <option value="">-- اختر حساب (اختياري) --</option>
              ${accOptions}
            </select>
        </div>
      </div>
      <div class="mb-3">
        <label class="form-label small fw-bold">قسم المصروف</label>
        <select id="expenseCategory" class="form-select mb-2">
          ${Object.keys(data.categories).map(cat=>`<option value="${cat}">${cat} (ميزانية: ${data.categories[cat].toFixed(2)})</option>`).join('')}
        </select>
        <input type="number" id="expenseAmount" class="form-control mb-2" placeholder="المبلغ المصروف">
        <input type="text" id="expenseDesc" class="form-control mb-3" placeholder="لِماذا تم الصرف؟ (مثلاً: عشاء مطعم)">
        <button id="addExpenseBtn" class="btn btn-main w-100"><i class="fas fa-check-circle"></i> حفظ المصروف</button>
      </div>
      <h6 class="mt-4 border-top pt-3">آخر المصاريف المسجلة:</h6>
      <div id="dailyExpensesList"></div>
    </div>
  `;

  const listDiv=document.getElementById('dailyExpensesList');

  function refreshList(){
    listDiv.innerHTML='';
    // Show only the last 10 entries for brevity on the main screen
    const recentExpenses = data.dailyExpenses.slice().sort((a,b) => b.timestamp - a.timestamp).slice(0, 10);
    
    if(recentExpenses.length === 0){
        listDiv.innerHTML = '<div class="text-center text-muted p-3">لا توجد مصاريف مسجلة بعد.</div>';
    } else {
        recentExpenses.forEach((exp)=>{
          const row=document.createElement('div');
          row.className='daily-expense-item';
          row.innerHTML=`
            <div class="exp-details">
                <div class="exp-category">${exp.cat} <span class="text-muted small">(${exp.desc})</span></div>
                <div class="small text-secondary">${exp.date} ${exp.acc ? `| 💳 ${exp.acc}` : ''}</div>
            </div>
            <div class="exp-amount">${exp.amount.toFixed(2)} ريال</div>
          `;
          listDiv.appendChild(row);
        });
    }
  }

  document.getElementById('addExpenseBtn').onclick=async ()=>{
    const date=document.getElementById('expenseDate').value;
    const cat=document.getElementById('expenseCategory').value;
    const amount=parseFloat(document.getElementById('expenseAmount').value)||0;
    const desc=document.getElementById('expenseDesc').value.trim();
    const accName=document.getElementById('expenseAccount').value;
    
    if(amount<=0 || !cat || !desc){ alert("الرجاء إدخال المبلغ، القسم، والسبب بشكل صحيح"); return; }
    
    // Deduct from account if selected (and update Firebase)
    if(accName){
      const idx = accounts.findIndex(a=>a.name===accName);
      if(idx!==-1){
        if(accounts[idx].balance < amount){
             if(!confirm(`تنبيه: رصيد الحساب (${accounts[idx].balance.toFixed(2)} ريال) أقل من المبلغ المصروف. هل تريد المتابعة والسماح بالرصيد السالب؟`)) return;
        }
        accounts[idx].balance = parseFloat((accounts[idx].balance - amount).toFixed(2));
         // تحديث قائمة الحسابات في Firebase
        await db.collection('users').doc(uid).update({ accounts: accounts });
      }
    }
    
    // Add new expense and update Firebase
    data.dailyExpenses.push({date, cat, amount, desc, acc:accName, timestamp: new Date().getTime()});
    await db.collection('users').doc(uid).update({dailyExpenses:data.dailyExpenses});
    
    // Clear form and refresh UI
    document.getElementById('expenseAmount').value='';
    document.getElementById('expenseDesc').value='';
    // منع forceTabSwitch لمنع التحديث اللانهائي: 
    loadUserData(uid, false); 
  };

  refreshList();
}


// =================================================================
// 6. Weekly Tab - Analysis
// =================================================================
function renderWeeklyTab(data, uid){
  const container=document.getElementById('weeklyTab');
  container.innerHTML=`
    <h5 class="mb-3 text-center text-main"><i class="fas fa-chart-line"></i> التحليلات الأسبوعية والتحكم بالميزانية</h5>
    <div id="weeklyContainer" style="max-width:720px; margin:auto;"></div>
    <div class="card card-royal mt-4 mx-auto" style="max-width:720px;">
        <canvas id="categoryChart"></canvas>
    </div>
  `;
  const weeklyContainer=document.getElementById('weeklyContainer');
  const today=new Date();
  const days=[];
  
  // Get last 7 days (including today)
  for(let i=6;i>=0;i--){
    const d=new Date();
    d.setDate(today.getDate()-i);
    days.push(d.toISOString().split('T')[0]);
  }

  let totalWeeklySpent=0;
  
  // Calculate total spent per category for the whole budget period
  const totalSpentPerCategory = {};
  for(const cat in data.categories) totalSpentPerCategory[cat] = 0;
  data.dailyExpenses.forEach(e => {
      if(data.categories.hasOwnProperty(e.cat)) {
          totalSpentPerCategory[e.cat] += e.amount;
      }
  });


  for(const day of days){
    const dayDiv=document.createElement('div');
    dayDiv.className="weekly-day-box";
    dayDiv.innerHTML=`<h6>${day}</h6>`;
    const dayExpenses=data.dailyExpenses.filter(e=>e.date===day);
    
    if(dayExpenses.length===0){ dayDiv.innerHTML+="<div class='text-muted small'>لا توجد مصروفات مسجلة في هذا اليوم.</div>"; weeklyContainer.appendChild(dayDiv); continue; }
    
    let dayTotal = 0;
    dayExpenses.forEach((e)=>{
        const div=document.createElement('div');
        div.className="daily-expense-item";
        div.innerHTML=`
            <div class="exp-details">
                <span class="exp-category">${e.cat}</span>: ${e.desc}
                <div class="small text-secondary">💳 ${e.acc||'—'}</div>
            </div>
            <div class="exp-amount">${e.amount.toFixed(2)} ريال</div>
            <button class="btn btn-outline-danger btn-sm ms-2" title="حذف المصروف" onclick="deleteExpense('${e.date}', '${e.cat}', ${e.timestamp}, ${e.amount}, '${e.acc || ''}')"><i class="fas fa-trash-alt"></i></button>
        `;
        dayDiv.appendChild(div);
        totalWeeklySpent+=e.amount;
        dayTotal+=e.amount;
    });
    
    dayDiv.innerHTML += `<div class="text-end fw-bold pt-2 border-top mt-2">إجمالي اليوم: ${dayTotal.toFixed(2)} ريال</div>`;
    weeklyContainer.appendChild(dayDiv);
  }
  
  // Overall category summary
  let categorySummaryHTML = '<div class="card card-royal mt-3"><h6>مقارنة الميزانية المتبقية حسب القسم</h6>';
  for(const cat in data.categories){
      const allocated = data.categories[cat];
      const spent = totalSpentPerCategory[cat];
      const remaining = allocated - spent;
      const percentage = Math.min(100, (spent / allocated) * 100 || 0);
      const barClass = percentage < 75 ? 'green' : 'red';
      
      categorySummaryHTML += `
          <div class="category-status">
              <div class="d-flex justify-content-between">
                  <span>${cat}:</span>
                  <span class="fw-bold ${remaining < 0 ? 'text-danger' : 'text-success'}">${remaining.toFixed(2)} ريال متبقي</span>
              </div>
              <div class="status-bar-container">
                  <div class="status-bar ${barClass}" style="width:${percentage}%;"></div>
              </div>
              <div class="small text-muted text-end">صُرف: ${spent.toFixed(2)} / ${allocated.toFixed(2)}</div>
          </div>
      `;
  }
  categorySummaryHTML += `</div><h5 class="text-center mt-4">إجمالي الصرف في الأيام السبعة الماضية: <span class="text-danger">${totalWeeklySpent.toFixed(2)} ريال</span></h5>`;
  weeklyContainer.insertAdjacentHTML('afterbegin', categorySummaryHTML);

  // Chart setup
  const chartLabels = Object.keys(data.categories);
  const chartData = chartLabels.map(cat => totalSpentPerCategory[cat]);
  
  // Destroy old chart instance if it exists
  const oldChart = Chart.getChart("categoryChart");
  if (oldChart) { oldChart.destroy(); }

  new Chart(document.getElementById('categoryChart').getContext('2d'), {
    type: 'pie',
    data: {
      labels: chartLabels,
      datasets: [{
        data: chartData,
        backgroundColor: [ // Add more colors if needed
            '#3b6bff', '#5a82ff', '#7b61ff', '#d66bff', '#f59e0b', '#f97316', '#28a745', '#dc3545' 
        ],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: {
          position: 'top',
          rtl: true,
        },
        title: {
          display: true,
          text: 'توزيع المصاريف حسب الأقسام',
          font: { family: 'Segoe UI', size: 16 }
        }
      }
    }
  });
}

// ===== Delete Expense Function (Improved Logic) =====
async function deleteExpense(date, cat, timestamp, amount, accName) { 
  if (!confirm("هل أنت متأكد من حذف هذا المصروف؟ سيتم استرجاع المبلغ إلى الحساب المصرفي إذا كان محددًا.")) return;

  const uid = auth.currentUser.uid;
  const docRef = db.collection('users').doc(uid);
  const docSnap = await docRef.get();
  const data = docSnap.data();

  // Find the exact expense using the combination of fields and timestamp
  const realIndex = data.dailyExpenses.findIndex(
    x => x.date === date && x.cat === cat && x.timestamp === timestamp
  );

  if (realIndex !== -1) {
    
    // Refund amount to account if specified (and update Firebase)
    if(accName){
      const accIndex = accounts.findIndex(a=>a.name===accName);
      if(accIndex!==-1){
        accounts[accIndex].balance = parseFloat((accounts[accIndex].balance + amount).toFixed(2));
        // تحديث قائمة الحسابات في Firebase
        await docRef.update({ accounts: accounts });
      }
    }

    // Delete item from array and update Firebase
    data.dailyExpenses.splice(realIndex, 1);
    await docRef.update({ dailyExpenses: data.dailyExpenses });
    alert("🗑️ تم حذف المصروف بنجاح");
    
    // Refresh all UI elements, but DO NOT force tab switch
    loadUserData(uid, false); 
  } else {
    alert("❌ لم يتم العثور على المصروف لحذفه");
  }
}

// =================================================================
// 7. Accounts Tab (Bank Cards)
// =================================================================
async function renderAccounts(data, uid){ 
  const container=document.getElementById('accountsTab');
  container.style.display='block';
  
  const existing = document.getElementById('accountsInner');
  if(!existing){
    document.getElementById('accountsTab').innerHTML = `
      <h5 class="mb-3 text-center text-main"><i class="fas fa-credit-card"></i> حساباتي وبطاقاتي</h5>
      <div id="accountsInner" style="max-width:1000px; margin:auto;">
        
        <div class="text-center mb-3">
          <button class="btn btn-main" onclick="showAddAccountForm()">➕ إضافة بطاقة جديدة</button>
        </div>

        <div id="addAccountBox" class="card card-royal mx-auto" style="display:none; max-width:520px;">
          <h6>إنشاء بطاقة / حساب جديد</h6>
          <input id="newAccountName" class="form-control mb-2" placeholder="اسم الحساب (مثلاً: الحساب الرئيسي)">
          <input type="number" id="newAccountBalance" class="form-control mb-2" placeholder="الرصيد المبدئي">
          <select id="newAccountType" class="form-select mb-2">
            <option value="blue">بطاقة رئيسية (أزرق)</option>
            <option value="purple">بطاقة تسوق (بنفسجي)</option>
            <option value="gold">بطاقة احتياط (ذهبي)</option>
          </select>
          <div class="d-flex gap-2">
            <button class="btn btn-main" onclick="confirmAddAccount('${uid}')">إضافة البطاقة</button>
            <button class="btn btn-outline-secondary" onclick="cancelAddAccountForm()">إلغاء</button>
          </div>
        </div>

        <div id="addMoneyBox" class="card card-royal mx-auto" style="display:none; max-width:520px;">
          <h6>➕ تعديل الرصيد</h6>
          <p id="targetAcctLabel" class="fw-bold"></p>
          <input id="moneySourceInput" class="form-control mb-2" placeholder="المصدر / السبب (اختياري)">
          <input type="number" id="moneyAmountInput" class="form-control mb-2" placeholder="المبلغ">
          <select id="moneyActionType" class="form-select mb-2">
            <option value="add">إضافة (إيداع)</option>
            <option value="deduct">سحب (تحويل/سحب)</option>
          </select>
          <div class="d-flex gap-2">
            <button class="btn btn-main" id="confirmAddMoneyBtn">تنفيذ</button>
            <button class="btn btn-outline-secondary" onclick="cancelAddMoneyForm()">إلغاء</button>
          </div>
        </div>
        
        <div id="accountsGrid" class="accounts-grid mt-3"></div>
      </div>
    `;
  }

  // Render Grid
  const grid = document.getElementById('accountsGrid');
  grid.innerHTML = '';
  
  if(accounts.length===0){
    grid.innerHTML = `<div class="card card-royal w-100 text-center">لا توجد حسابات بعد — اضغط على "إضافة بطاقة جديدة".</div>`;
  } else {
    accounts.forEach((acc, idx)=>{
      let cls = 'grad-blue', logoType='visa';
      if(acc.style==='purple'){ cls='grad-purple'; logoType='master'; }
      if(acc.style==='gold'){ cls='grad-gold'; logoType='visa'; }
      
      const card = document.createElement('div');
      card.className = 'bank-card '+cls;
      card.innerHTML = `
        <div class="card-top">
          <div>
            <div class="card-name">${acc.name}</div>
          </div>
          <div>
             <i class="fab fa-${logoType} fa-2x"></i>
          </div>
        </div>
        <div>
          <div class="card-balance">${acc.balance.toFixed(2)} ريال</div>
        </div>
        <div class="bank-actions">
          <button class="small-btn primary" onclick="openAddMoney('${uid}', ${idx}, 'add')">➕ إيداع</button>
          <button class="small-btn primary" onclick="openAddMoney('${uid}', ${idx}, 'deduct')">➖ سحب</button>
          <button class="small-btn danger" onclick="deleteAccount('${uid}', ${idx})">🗑️ حذف</button>
        </div>
      `;
      grid.appendChild(card);
    });
  }
  updateExpenseAccountSelect();
}

async function confirmAddAccount(uid){
  const name = document.getElementById('newAccountName').value.trim();
  const bal = parseFloat(document.getElementById('newAccountBalance').value) || 0;
  const style = document.getElementById('newAccountType').value;
  if(!name) return alert("الرجاء إدخال اسم البطاقة");
  
  // تحديث قائمة accounts المحلية والـ Firebase
  accounts.push({name, balance:bal, style, createdAt: new Date().toISOString()});
  await db.collection('users').doc(uid).update({ accounts: accounts });
  
  document.getElementById('newAccountName').value='';
  document.getElementById('newAccountBalance').value='';
  document.getElementById('addAccountBox').style.display='none';
  
  loadUserData(uid, false, true); // إعادة تحميل البيانات والتأكد من عرض الحسابات
}

async function deleteAccount(uid, idx){
  if(!confirm("⚠️ تحذير: هل أنت متأكد من حذف هذه البطاقة؟")) return;
  
  // حذف من القائمة المحلية وتحديث Firebase
  accounts.splice(idx,1);
  await db.collection('users').doc(uid).update({ accounts: accounts });
  
  loadUserData(uid, false, true); // إعادة تحميل البيانات والتأكد من عرض الحسابات
}

function openAddMoney(uid, idx, action='add'){
  document.getElementById('addAccountBox').style.display='none';
  document.getElementById('addMoneyBox').style.display='block';
  document.getElementById('targetAcctLabel').textContent = `تعديل رصيد: ${accounts[idx].name} (الرصيد الحالي: ${accounts[idx].balance.toFixed(2)})`;
  
  const actionType = document.getElementById('moneyActionType');
  actionType.value = action;
  
  const btn = document.getElementById('confirmAddMoneyBtn');
  btn.onclick = async ()=>{ 
    const amt = parseFloat(document.getElementById('moneyAmountInput').value);
    const type = actionType.value;
    if(isNaN(amt) || amt<=0) return alert("أدخل مبلغًا صحيحًا وموجبًا");
    
    let newBalance = accounts[idx].balance;
    if(type === 'add'){
        newBalance += amt;
    } else { // deduct
        newBalance -= amt;
    }

    accounts[idx].balance = parseFloat(newBalance.toFixed(2));
    
    // تحديث قائمة الحسابات في Firebase
    await db.collection('users').doc(uid).update({ accounts: accounts });
    
    // Clear form and hide
    document.getElementById('moneySourceInput').value='';
    document.getElementById('moneyAmountInput').value='';
    document.getElementById('addMoneyBox').style.display='none';
    
    alert(`تم ${type==='add'?'إضافة':'سحب'} ${amt.toFixed(2)} ريال. الرصيد الجديد: ${accounts[idx].balance.toFixed(2)} ريال.`);
    loadUserData(uid, false, true); // إعادة تحميل البيانات والتأكد من عرض الحسابات
  };
}

function showAddAccountForm(){
  document.getElementById('addAccountBox').style.display='block';
  document.getElementById('addMoneyBox').style.display='none';
}
function cancelAddAccountForm(){
  document.getElementById('addAccountBox').style.display='none';
}
function cancelAddMoneyForm(){
  document.getElementById('addMoneyBox').style.display='none';
}

function updateExpenseAccountSelect(){
  const sel = document.getElementById('expenseAccount');
  if(!sel) return;
  sel.innerHTML = '<option value="">-- اختر حساب (اختياري) --</option>';
  accounts.forEach(a=>{
    const opt = document.createElement('option');
    opt.value = a.name;
    opt.textContent = `${a.name} — ${a.balance.toFixed(2)} ريال`;
    sel.appendChild(opt);
  });
}

// =================================================================
// 8. Account Tab (Settings) ⬅️ تم إضافة هذا الجزء مجدداً
// =================================================================
function renderAccountTab(data, uid){
  const container=document.getElementById('accountTab');
  container.innerHTML=`
    <div class="card card-royal mx-auto" style="max-width:520px;">
      <h5 class="text-center text-main mb-4"><i class="fas fa-cog"></i> تعديل بيانات الحساب والميزانية</h5>
      
      <h6>بيانات الدخل</h6>
      <input type="number" id="salaryEdit" class="form-control mb-2" value="${data.salary||''}" placeholder="راتبك الأساسي">
      <input type="number" id="incomeEdit" class="form-control mb-2" value="${data.incomeSources||''}" placeholder="مصادر دخل أخرى">
      <input type="number" id="loansEdit" class="form-control mb-3" value="${data.loans||''}" placeholder="قروض / التزامات شهرية">
      
      <h6>تعديل ميزانية الأقسام</h6>
      <div id="editCategoriesContainer"></div>
      <button id="addEditCategoryBtn" class="btn btn-outline-primary btn-sm mb-2 w-100"><i class="fas fa-plus-circle"></i> إضافة قسم جديد</button>
      
      <button id="saveAccountBtn" class="btn btn-main w-100 mt-4"><i class="fas fa-save"></i> حفظ التعديلات</button>
    </div>
  `;
  
  const editContainer=document.getElementById('editCategoriesContainer');
  function addEditRow(name="",alloc=""){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2 align-items-center";
    div.innerHTML=`
      <input type="text" class="form-control category-name-input" value="${name}" placeholder="اسم القسم">
      <input type="number" class="form-control category-alloc-input" value="${alloc}" placeholder="المبلغ المخصص">
      <button class="btn btn-sm btn-outline-danger" onclick="this.parentElement.remove()"><i class="fas fa-times"></i></button>
    `;
    editContainer.appendChild(div);
  }
  
  // Load existing categories
  for(const cat in data.categories) addEditRow(cat,data.categories[cat]);
  
  document.getElementById('addEditCategoryBtn').onclick=()=> addEditRow();
  
  document.getElementById('saveAccountBtn').onclick=async ()=>{
    const salary=parseFloat(document.getElementById('salaryEdit').value)||0;
    const income=parseFloat(document.getElementById('incomeEdit').value)||0;
    const loans=parseFloat(document.getElementById('loansEdit').value)||0;
    const names=document.getElementsByClassName('category-name-input');
    const allocs=document.getElementsByClassName('category-alloc-input');
    const categories={};
    
    for(let i=0;i<names.length;i++){
      const name=names[i].value.trim();
      const alloc=parseFloat(allocs[i].value)||0;
      if(name) categories[name]=alloc;
    }
    
    await db.collection('users').doc(uid).update({salary, incomeSources: income, loans, categories});
    alert("✅ تم تحديث البيانات بنجاح! سيتم إعادة تحميل الواجهة.");
    loadUserData(uid); // Re-load to refresh all tabs
  };
}
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

</body>
</html>
