<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>راتبي الذكي — تطبيق</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --main-blue:#3b6bff;
  --light-gray:#f5f5f5;
  --card-shadow:0 6px 18px rgba(0,0,128,0.1);
  --accent-text:#2c003e;
}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--light-gray);
  color: var(--accent-text);
}
#authContainer{
  max-width:400px;
  margin:100px auto;
  padding:20px;
  background:#fff;
  border-radius:16px;
  box-shadow:var(--card-shadow);
}
.btn-main{
  background: var(--main-blue);
  color:#fff;
  border:none;
}
.btn-main:hover{
  background:#5a82ff;
}
.card-royal{
  background:#fff;
  border:none;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:var(--card-shadow);
}
input:focus, .form-control:focus{
  box-shadow:none;
  border-color: var(--main-blue);
}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.tabContent{display:none; padding-top:10px;}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  border-top:1px solid #ddd;
  padding:8px 0;
  box-shadow:0 -2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.bottom-nav div{
  flex:1;
  text-align:center;
  cursor:pointer;
  font-size:14px;
  color:#333;
}
.bottom-nav .active{color:var(--main-blue); font-weight:bold;}
</style>
</head>
<body>

<div id="authContainer"></div>

<div id="app" style="display:none; max-width:900px; margin:0 auto; padding-bottom:80px;">
  <div id="welcomeUser" class="h5 mb-3 text-center"></div>

  <div id="dailyTab" class="tabContent"></div>
  <div id="weeklyTab" class="tabContent"></div>
  <div id="accountTab" class="tabContent"></div>

  <div class="bottom-nav">
    <div data-tab="dailyTab" class="active">🏷️ تسجيل المصاريف اليومية</div>
    <div data-tab="weeklyTab">📊 التحليلات الأسبوعية</div>
    <div data-tab="accountTab">⚙️ حسابك</div>
    <div onclick="logout()">🚪 خروج</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const authContainer=document.getElementById('authContainer');
const app=document.getElementById('app');
const welcomeUser=document.getElementById('welcomeUser');

// ===== Login / Signup =====
function showLogin(){
  authContainer.innerHTML=`
    <input type="email" id="email" class="form-control mb-2" placeholder="البريد الإلكتروني">
    <input type="password" id="password" class="form-control mb-2" placeholder="كلمة المرور">
    <button class="btn btn-main w-100 mb-2" onclick="login()">تسجيل الدخول</button>
    <button class="btn btn-outline-primary w-100 mb-2" onclick="signup()">إنشاء حساب</button>
  `;
}
function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert(err.message));
}
function signup(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,password).then(cred=>{
    db.collection('users').doc(cred.user.uid).set({
      categories:{}, dailyExpenses:[], salary:0
    });
  }).catch(err=>alert(err.message));
}
function logout(){auth.signOut();}

// ===== Bottom Navigation =====
document.querySelectorAll('.bottom-nav div[data-tab]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
    document.querySelectorAll('.bottom-nav div').forEach(d=>d.classList.remove('active'));
    btn.classList.add('active');
  });
});

// ===== Auth State =====
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display='none';
    app.style.display='block';
    welcomeUser.textContent=`أهلاً، ${user.email} 👋`;
    loadUserData(user.uid);
  }else{
    authContainer.style.display='block';
    app.style.display='none';
    showLogin();
  }
});

// ===== Load User Data =====
async function loadUserData(uid){
  const docSnap=await db.collection('users').doc(uid).get();
  if(!docSnap.exists)return;
  const data=docSnap.data();
  renderDailyTab(data,uid);
  renderWeeklyTab(data);
  renderAccountTab(data,uid);
  document.querySelector('.bottom-nav div[data-tab="dailyTab"]').click();
}

// ===== Daily Tab =====
function renderDailyTab(data,uid){
  const container=document.getElementById('dailyTab');
  container.innerHTML=`
  <div class="card card-royal">
    <h5>تسجيل المصاريف اليومية</h5>
    <input type="date" id="expDate" class="form-control mb-2" value="${new Date().toISOString().split('T')[0]}">
    <select id="expCat" class="form-control mb-2">
      ${Object.keys(data.categories).map(c=>`<option>${c}</option>`).join('')}
    </select>
    <input type="number" id="expAmt" class="form-control mb-2" placeholder="المبلغ">
    <input type="text" id="expDesc" class="form-control mb-2" placeholder="وصف الصرف (مثلاً: مطعم)">
    <button class="btn btn-main w-100 mb-3" id="saveExpBtn">حفظ المصروف</button>
    <div id="expensesList"></div>
  </div>`;
  document.getElementById('saveExpBtn').onclick=async()=>{
    const date=document.getElementById('expDate').value;
    const cat=document.getElementById('expCat').value;
    const amt=parseFloat(document.getElementById('expAmt').value)||0;
    const desc=document.getElementById('expDesc').value;
    if(!amt)return alert("أدخل المبلغ");
    const newE={id:Date.now(),date,cat,amt,desc};
    const updated=[...(data.dailyExpenses||[]),newE];
    await db.collection('users').doc(uid).update({dailyExpenses:updated});
    loadUserData(uid);
  };
  renderExpensesList(data.dailyExpenses,data,uid);
}

// === قائمة المصروفات (مع تعديل وحذف)
function renderExpensesList(expenses,data,uid){
  const list=document.getElementById('expensesList');
  if(!expenses||expenses.length===0){list.innerHTML="<p>لا توجد مصاريف بعد</p>";return;}
  let total=0;
  list.innerHTML=expenses.map(e=>{
    total+=e.amt;
    return `
      <div class="d-flex justify-content-between align-items-center border-bottom py-2">
        <div>
          <strong>${e.cat}</strong> - ${e.amt} ريال<br>
          <small>${e.date}</small> | ${e.desc||'-'}
        </div>
        <div>
          <button class="btn btn-sm btn-outline-primary" onclick="editExpense(${e.id},'${uid}')">✏️</button>
          <button class="btn btn-sm btn-outline-danger" onclick="deleteExpense(${e.id},'${uid}')">🗑️</button>
        </div>
      </div>
    `;
  }).join('');
  const rem=Object.values(data.categories).reduce((a,b)=>a+b,0)-total;
  list.innerHTML+=`<div class="mt-3"><strong>الإجمالي:</strong> ${total} ريال<br><strong>المتبقي:</strong> ${rem} ريال</div>`;
}

// === تعديل مصروف
async function editExpense(id,uid){
  const ref=db.collection('users').doc(uid);
  const doc=await ref.get();
  const data=doc.data();
  const exp=data.dailyExpenses.find(e=>e.id===id);
  const newAmt=prompt("المبلغ الجديد:",exp.amt);
  if(newAmt===null)return;
  const newDesc=prompt("الوصف الجديد:",exp.desc);
  exp.amt=parseFloat(newAmt)||exp.amt;
  exp.desc=newDesc;
  await ref.update({dailyExpenses:data.dailyExpenses});
  loadUserData(uid);
}

// === حذف مصروف
async function deleteExpense(id,uid){
  if(!confirm("هل تريد حذف هذا المصروف؟"))return;
  const ref=db.collection('users').doc(uid);
  const doc=await ref.get();
  const data=doc.data();
  const updated=data.dailyExpenses.filter(e=>e.id!==id);
  await ref.update({dailyExpenses:updated});
  loadUserData(uid);
}

// ===== Weekly Tab =====
function renderWeeklyTab(data){
  const c=document.getElementById('weeklyTab');
  c.innerHTML=`<h5 class="mb-3">التحليلات الأسبوعية</h5>`;
  if(!data.dailyExpenses||data.dailyExpenses.length===0){c.innerHTML+="<p>لا توجد بيانات</p>";return;}
  const now=new Date();
  const weekAgo=new Date(now.getTime()-7*24*60*60*1000);
  const week=data.dailyExpenses.filter(e=>new Date(e.date)>=weekAgo);
  const group={};
  let total=0;
  week.forEach(e=>{
    if(!group[e.cat])group[e.cat]=[];
    group[e.cat].push(e);
  });
  for(const cat in group){
    let sum=0;
    const rows=group[cat].map(e=>{
      sum+=e.amt; total+=e.amt;
      const remain=data.categories[cat]-sum;
      return `<tr><td>${e.date}</td><td>${e.desc||'-'}</td><td>${e.amt}</td><td>${remain}</td></tr>`;
    }).join('');
    c.innerHTML+=`
      <div class="card card-royal">
        <h6>${cat}</h6>
        <table class="table table-sm">
          <thead><tr><th>التاريخ</th><th>الوصف</th><th>المبلغ</th><th>المتبقي</th></tr></thead>
          <tbody>${rows}</tbody>
          <tfoot><tr><td colspan="4"><strong>إجمالي القسم:</strong> ${sum} ريال</td></tr></tfoot>
        </table>
      </div>`;
  }
  c.innerHTML+=`<div class="alert alert-info mt-3"><strong>إجمالي مصاريف الأسبوع:</strong> ${total} ريال</div>`;
}

// ===== Account Tab =====
function renderAccountTab(data,uid){
  const c=document.getElementById('accountTab');
  c.innerHTML=`
  <div class="card card-royal">
    <h5>تعديل بياناتك</h5>
    <input type="number" id="salaryEdit" class="form-control mb-2" value="${data.salary}" placeholder="الراتب">
    <div id="cats"></div>
    <button class="btn btn-outline-primary mb-2 w-100" id="addCat">إضافة قسم</button>
    <button class="btn btn-main w-100" id="saveAcc">حفظ</button>
  </div>`;
  const catsDiv=document.getElementById('cats');
  function addRow(n="",v=""){
    const d=document.createElement('div');
    d.className="d-flex gap-2 mb-2";
    d.innerHTML=`<input type="text" class="form-control cname" value="${n}" placeholder="القسم"><input type="number" class="form-control cval" value="${v}" placeholder="المبلغ">`;
    catsDiv.appendChild(d);
  }
  for(const c in data.categories)addRow(c,data.categories[c]);
  document.getElementById('addCat').onclick=()=>addRow();
  document.getElementById('saveAcc').onclick=async()=>{
    const salary=parseFloat(document.getElementById('salaryEdit').value)||0;
    const names=document.querySelectorAll('.cname');
    const vals=document.querySelectorAll('.cval');
    const cats={};
    for(let i=0;i<names.length;i++){
      const n=names[i].value.trim();
      const v=parseFloat(vals[i].value)||0;
      if(n)cats[n]=v;
    }
    await db.collection('users').doc(uid).update({salary,categories:cats});
    alert("تم الحفظ بنجاح");
    loadUserData(uid);
  };
}
</script>
</body>
</html>
