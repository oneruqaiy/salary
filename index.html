<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>راتبي الذكي — تطبيق</title>

<!-- Bootstrap RTL CSS for nicer inputs (no JS dependency) -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

<!-- Chart.js (موجود لكن لم أترك رسماً افتراضياً، يمكن إضافته لاحقاً) -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --main-blue:#3b6bff;
  --light-bg:#f5f7fb;
  --card-shadow:0 8px 24px rgba(59,107,255,0.08);
  --muted:#64748b;
  --danger:#ef4444;
  --success:#16a34a;
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background:var(--light-bg);
  color:#0f1724;
  -webkit-font-smoothing:antialiased;
}
.container-app{
  max-width:980px;
  margin:0 auto;
  padding:14px;
  padding-bottom:120px; /* space for bottom nav */
}

/* Auth card */
#authContainer{
  max-width:420px;
  margin:70px auto;
  padding:18px;
  background:#fff;
  border-radius:14px;
  box-shadow:var(--card-shadow);
}

/* Cards */
.card-royal{
  background:#fff;
  border-radius:12px;
  padding:14px;
  box-shadow:var(--card-shadow);
  margin-bottom:12px;
}

/* Inputs/buttons */
.form-control, .form-select { border-radius:10px; }
.btn-main{ background:var(--main-blue); color:#fff; border:none; border-radius:10px; }
.btn-main:hover{ background:#597fff; }

/* bottom nav */
.bottom-nav{
  position:fixed; left:0; right:0; bottom:12px; z-index:220;
  display:flex; gap:8px; justify-content:space-around;
  padding:8px; margin:0 12px;
}
.bottom-nav button{
  flex:1;
  border-radius:12px;
  border:1px solid rgba(15,23,36,0.06);
  background:#fff;
  padding:10px 6px;
  font-weight:600;
  color:#334155;
  box-shadow:0 6px 18px rgba(2,6,23,0.04);
}
.bottom-nav button.active{ color:var(--main-blue); box-shadow:0 10px 30px rgba(59,107,255,0.08); }

/* Daily list */
.expense-list{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
.expense-item{ display:flex; justify-content:space-between; gap:10px; padding:10px; border-radius:10px; background:#fbfdff; box-shadow:0 6px 14px rgba(2,6,23,0.03); align-items:center; }
.expense-left{ display:flex; flex-direction:column; gap:6px; }
.expense-meta{ color:var(--muted); font-size:13px; }
.expense-amount{ color:var(--main-blue); font-weight:800; font-size:15px; }

/* small actions */
.actions { display:flex; gap:8px; align-items:center; }

/* weekly layout */
.weekly-grid{ display:grid; gap:12px; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); margin-top:10px; }
.weekly-card{ background:#fff; border-radius:12px; padding:12px; box-shadow:var(--card-shadow); }
.cat-entry{ display:flex; justify-content:space-between; gap:10px; padding:8px; border-radius:8px; background:#fbfdff; margin-top:8px; align-items:center; }

/* totals */
.totals{ margin-top:12px; padding:12px; border-radius:12px; background:linear-gradient(90deg,#eef5ff,#fff); box-shadow:var(--card-shadow); display:flex; justify-content:space-between; align-items:center; }

/* responsive */
@media(max-width:520px){
  .container-app{ padding:10px; }
  .bottom-nav{ bottom:8px; gap:6px; margin:0 8px; }
}
</style>
</head>
<body>

<!-- Auth container (login/signup) -->
<div id="authContainer" style="display:none"></div>

<!-- App -->
<div id="app" class="container-app" style="display:none;">
  <div id="welcome" class="mb-2" style="text-align:center; font-weight:700;"></div>

  <!-- Tabs content placeholders -->
  <div id="tab-daily" style="display:none;"></div>
  <div id="tab-weekly" style="display:none;"></div>
  <div id="tab-account" style="display:none;"></div>

  <!-- Bottom navigation -->
  <div class="bottom-nav">
    <button id="nav-daily" class="active">🏷️ تسجيل المصروف</button>
    <button id="nav-weekly">📊 التحليلات الأسبوعية</button>
    <button id="nav-account">⚙️ حسابك</button>
    <button id="nav-logout">🚪 خروج</button>
  </div>
</div>

<!-- Edit modal (custom light modal) -->
<div id="editModal" style="display:none; position:fixed; inset:0; z-index:999; background:rgba(2,6,23,0.45); align-items:center; justify-content:center;">
  <div style="width:94%; max-width:520px; background:#fff; border-radius:12px; padding:14px;">
    <h6>تعديل المصروف</h6>
    <div style="margin-top:8px;">
      <label class="form-label">القسم</label>
      <select id="editCategory" class="form-select"></select>
      <label class="form-label mt-2">المبلغ</label>
      <input id="editAmount" type="number" class="form-control" />
      <label class="form-label mt-2">الوصف</label>
      <input id="editNote" class="form-control" />
      <label class="form-label mt-2">التاريخ</label>
      <input id="editDate" type="date" class="form-control" />
    </div>
    <div style="display:flex; gap:8px; margin-top:12px; justify-content:flex-end;">
      <button id="editCancel" class="btn btn-outline-secondary">إلغاء</button>
      <button id="editSave" class="btn btn-main">حفظ التعديل</button>
    </div>
  </div>
</div>

<script>
/* ========== إعداد Firebase ========== */
/* ضعي إعدادات مشروعك هنا — القيم الحالية مأخوذة من كودك السابق */
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ===== عناصر DOM ===== */
const authContainer = document.getElementById('authContainer');
const appEl = document.getElementById('app');
const welcomeEl = document.getElementById('welcome');
const tabDaily = document.getElementById('tab-daily');
const tabWeekly = document.getElementById('tab-weekly');
const tabAccount = document.getElementById('tab-account');

const navDaily = document.getElementById('nav-daily');
const navWeekly = document.getElementById('nav-weekly');
const navAccount = document.getElementById('nav-account');
const navLogout = document.getElementById('nav-logout');

const editModal = document.getElementById('editModal');
const editCategory = document.getElementById('editCategory');
const editAmount = document.getElementById('editAmount');
const editNote = document.getElementById('editNote');
const editDate = document.getElementById('editDate');
const editCancel = document.getElementById('editCancel');
const editSave = document.getElementById('editSave');

let currentUserUID = null;
let currentUserDoc = null; // snapshot data (object)
let editingEntryId = null;

/* ===== واجهة تسجيل الدخول / إنشاء حساب بسيطة ===== */
function showAuth(){
  authContainer.style.display = 'block';
  appEl.style.display = 'none';
  authContainer.innerHTML = `
    <h5 class="text-center mb-3">تسجيل الدخول أو إنشاء حساب</h5>
    <input id="inEmail" class="form-control mb-2" placeholder="البريد الإلكتروني">
    <input id="inPass" type="password" class="form-control mb-2" placeholder="كلمة المرور">
    <div style="display:flex; gap:8px;">
      <button id="btnLogin" class="btn btn-main flex-grow-1">تسجيل الدخول</button>
      <button id="btnSignup" class="btn btn-outline-primary flex-grow-1">إنشاء حساب</button>
    </div>
    <div style="margin-top:10px; text-align:center; color:var(--muted); font-size:13px;">
      أو تسجيل دخول مؤقت (تجريبي)
      <div style="margin-top:6px;">
        <button id="btnAnon" class="btn btn-outline-secondary">تجربة بدون حساب</button>
      </div>
    </div>
  `;
  document.getElementById('btnLogin').onclick = async ()=>{
    const email = document.getElementById('inEmail').value.trim();
    const pwd = document.getElementById('inPass').value;
    if(!email || !pwd){ alert('أدخل البريد وكلمة المرور'); return; }
    try{ await auth.signInWithEmailAndPassword(email,pwd); }
    catch(e){ alert(e.message); }
  };
  document.getElementById('btnSignup').onclick = async ()=>{
    const email = document.getElementById('inEmail').value.trim();
    const pwd = document.getElementById('inPass').value;
    if(!email || !pwd){ alert('أدخل البريد وكلمة المرور'); return; }
    try{
      const cred = await auth.createUserWithEmailAndPassword(email,pwd);
      // create default doc
      await db.collection('users').doc(cred.user.uid).set({
        categories: { "مأكل": 200, "نقل": 100, "ترفيه": 50 },
        dailyExpenses: [],
        salary: 0,
        incomeSources: 0,
        loans: 0,
        lastSalaryDate: null
      });
    }catch(e){ alert(e.message); }
  };
  document.getElementById('btnAnon').onclick = async ()=>{
    try{ await auth.signInAnonymously(); }
    catch(e){ alert(e.message); }
  };
}

/* ===== التبديل بين التابات السفلي ===== */
function setActiveNav(btn){
  [navDaily,navWeekly,navAccount].forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
}
navDaily.onclick = ()=>{ showTab('daily'); setActiveNav(navDaily); };
navWeekly.onclick = ()=>{ showTab('weekly'); setActiveNav(navWeekly); };
navAccount.onclick = ()=>{ showTab('account'); setActiveNav(navAccount); };
navLogout.onclick = ()=> auth.signOut();

/* ===== إظهار تب محدد ===== */
function showTab(id){
  tabDaily.style.display = 'none';
  tabWeekly.style.display = 'none';
  tabAccount.style.display = 'none';
  if(id === 'daily') tabDaily.style.display = 'block';
  if(id === 'weekly') tabWeekly.style.display = 'block';
  if(id === 'account') tabAccount.style.display = 'block';
  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* ===== عند تغير حالة المصادقة ===== */
auth.onAuthStateChanged(async user=>{
  if(user){
    currentUserUID = user.uid;
    authContainer.style.display = 'none';
    appEl.style.display = 'block';
    // load user's doc
    await fetchUserDoc();
    welcomeEl.textContent = `أهلاً، ${user.email || user.displayName || 'المستخدم'}`;
    // render tabs
    renderDailyTab();
    renderWeeklyTab();
    renderAccountTab();
    showTab('daily');
    setActiveNav(navDaily);
  } else {
    currentUserUID = null;
    currentUserDoc = null;
    showAuth();
  }
});

/* ===== جلب بيانات المستخدم (مستند users/{uid}) ===== */
async function fetchUserDoc(){
  if(!currentUserUID) return;
  const ref = db.collection('users').doc(currentUserUID);
  const snap = await ref.get();
  if(!snap.exists){
    // if new anonymous user, create default structure
    await ref.set({ categories: {}, dailyExpenses: [], salary:0, incomeSources:0, loans:0, lastSalaryDate:null });
    currentUserDoc = (await ref.get()).data();
  } else {
    currentUserDoc = snap.data();
    // safety defaults
    currentUserDoc.categories = currentUserDoc.categories || {};
    currentUserDoc.dailyExpenses = currentUserDoc.dailyExpenses || [];
  }
}

/* ===== مساعدات تنسيق وعمليات على المصفوفة ===== */
function uidForEntry(){ return Date.now().toString() + Math.random().toString(36).slice(2,7); }
function formatCurrency(n){ const v = Number(n) || 0; return Number.isInteger(v) ? v + ' ر.ع' : v.toFixed(2) + ' ر.ع'; }
function yyyy_mm_dd(d){ const dt = new Date(d); const y = dt.getFullYear(); const m = String(dt.getMonth()+1).padStart(2,'0'); const day = String(dt.getDate()).padStart(2,'0'); return `${y}-${m}-${day}`; }
function escapeHtml(s){ if(s==null) return ''; return String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;'); }

/* ===== ===== صفحة تسجيل المصاريف (Daily) ===== ===== */
function renderDailyTab(){
  // ensure we have data
  if(!currentUserDoc) return;
  const categories = Object.keys(currentUserDoc.categories || {});
  const catOptions = categories.length ? categories.map(c=>`<option value="${escapeHtml(c)}">${escapeHtml(c)}</option>`).join('') : `<option value="">لا توجد أقسام بعد - اذهب لصفحة حسابك لإضافتها</option>`;

  tabDaily.innerHTML = `
    <div class="card-royal">
      <h5>🏷️ تسجيل مصروف جديد</h5>
      <div style="display:flex; gap:8px; margin-top:8px; flex-wrap:wrap;">
        <select id="inpCategory" class="form-select" style="min-width:160px;">
          ${catOptions}
        </select>
        <input id="inpAmount" type="number" class="form-control" placeholder="المبلغ">
        <input id="inpDate" type="date" class="form-control" value="${new Date().toISOString().split('T')[0]}" style="max-width:180px;">
      </div>
      <textarea id="inpNote" class="form-control mt-2" placeholder="سبب / فيما تم صرف المبلغ" rows="2" style="border-radius:8px"></textarea>
      <div style="display:flex; gap:8px; margin-top:10px;">
        <button id="btnAddExpense" class="btn btn-main flex-grow-1">إضافة مصروف</button>
        <button id="btnClear" class="btn btn-outline-secondary">مسح الحقول</button>
      </div>

      <div style="margin-top:14px;">
        <h6>📋 مصاريف التاريخ المحدد</h6>
        <div id="dailyList" class="expense-list"></div>
      </div>
    </div>
  `;

  // attach handlers
  document.getElementById('btnAddExpense').onclick = addExpenseHandler;
  document.getElementById('btnClear').onclick = ()=>{
    document.getElementById('inpAmount').value = '';
    document.getElementById('inpNote').value = '';
  };

  // populate today's (or selected date) list
  populateDailyList();
}

/* إضافة مصروف — يضيف ككائن داخل currentUserDoc.dailyExpenses ثم يحدث المستند */
async function addExpenseHandler(){
  const cat = document.getElementById('inpCategory').value;
  const amount = parseFloat(document.getElementById('inpAmount').value || 0);
  const note = document.getElementById('inpNote').value.trim();
  const date = document.getElementById('inpDate').value || yyyy_mm_dd(new Date());
  if(!cat){ alert('اختر القسم'); return; }
  if(!(amount>0)){ alert('أدخل مبلغًا صحيحًا أكبر من صفر'); return; }

  const entry = {
    id: uidForEntry(),
    date,
    category: cat,
    amount,
    note,
    ts: new Date().toISOString()
  };

  // push locally
  currentUserDoc.dailyExpenses.push(entry);
  // update firestore
  await db.collection('users').doc(currentUserUID).update({ dailyExpenses: currentUserDoc.dailyExpenses });
  // refresh UI
  populateDailyList();
  // clear inputs
  document.getElementById('inpAmount').value = '';
  document.getElementById('inpNote').value = '';
}

/* عرض قائمة المصروفات لليوم المحدد */
function populateDailyList(){
  const listEl = document.getElementById('dailyList');
  if(!listEl) return;
  const date = document.getElementById('inpDate').value || yyyy_mm_dd(new Date());
  // filter entries with same date
  const todays = (currentUserDoc.dailyExpenses || []).filter(e => e.date === date);
  // sort by ts desc
  todays.sort((a,b)=> new Date(b.ts) - new Date(a.ts));
  if(todays.length === 0){
    listEl.innerHTML = `<div class="text-muted">لا توجد مصروفات على هذا التاريخ.</div>`;
    return;
  }
  listEl.innerHTML = '';
  todays.forEach(entry=>{
    const div = document.createElement('div');
    div.className = 'expense-item';
    div.innerHTML = `
      <div class="expense-left">
        <div style="display:flex; gap:10px; align-items:center;">
          <div style="font-weight:700">${escapeHtml(entry.category)}</div>
          <div class="expense-meta">${escapeHtml(entry.note || '-')}</div>
        </div>
        <div class="expense-meta">${entry.date} • ${new Date(entry.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
      </div>
      <div style="display:flex; flex-direction:column; gap:8px; align-items:flex-end;">
        <div class="expense-amount">${formatCurrency(entry.amount)}</div>
        <div class="actions">
          <button class="btn btn-sm btn-outline-secondary" onclick="openEdit('${entry.id}')">✏️ تعديل</button>
          <button class="btn btn-sm btn-outline-danger" onclick="removeEntry('${entry.id}')">🗑️ حذف</button>
        </div>
      </div>
    `;
    listEl.appendChild(div);
  });
}

/* ========== تعديل / حذف (من اليومية أو الأسبوعية) ========== */
/* فتح مودال التعديل وتعبئته */
function openEdit(entryId){
  const entry = (currentUserDoc.dailyExpenses || []).find(x=>x.id === entryId);
  if(!entry){ alert('لم يتم العثور على البيان'); return; }
  editingEntryId = entryId;
  // fill category select
  const cats = Object.keys(currentUserDoc.categories || {});
  editCategory.innerHTML = cats.map(c=>`<option value="${escapeHtml(c)}"${c===entry.category?' selected':''}>${escapeHtml(c)}</option>`).join('');
  editAmount.value = entry.amount;
  editNote.value = entry.note || '';
  editDate.value = entry.date || yyyy_mm_dd(new Date());
  showEditModal();
}

/* إظهار/إخفاء المودال */
function showEditModal(){ editModal.style.display = 'flex'; editModal.scrollTop = 0; }
function hideEditModal(){ editModal.style.display = 'none'; editingEntryId = null; }

/* حفظ التعديل */
editSave.onclick = async ()=>{
  if(!editingEntryId){ hideEditModal(); return; }
  const entryIndex = (currentUserDoc.dailyExpenses || []).findIndex(x=>x.id === editingEntryId);
  if(entryIndex === -1){ alert('لم يتم العثور على البيان'); hideEditModal(); return; }
  const cat = editCategory.value;
  const amt = parseFloat(editAmount.value || 0);
  const note = editNote.value.trim();
  const date = editDate.value || yyyy_mm_dd(new Date());
  if(!cat){ alert('اختر القسم'); return; }
  if(!(amt>0)){ alert('أدخل مبلغًا صحيحًا أكبر من صفر'); return; }
  // update locally
  currentUserDoc.dailyExpenses[entryIndex].category = cat;
  currentUserDoc.dailyExpenses[entryIndex].amount = amt;
  currentUserDoc.dailyExpenses[entryIndex].note = note;
  currentUserDoc.dailyExpenses[entryIndex].date = date;
  currentUserDoc.dailyExpenses[entryIndex].ts = new Date().toISOString();
  // update firestore
  await db.collection('users').doc(currentUserUID).update({ dailyExpenses: currentUserDoc.dailyExpenses });
  // refresh UI
  populateDailyList();
  renderWeeklyTab(); // refresh weekly too
  hideEditModal();
};

/* إلغاء */
editCancel.onclick = ()=> hideEditModal();

/* حذف قيد */
async function removeEntry(entryId){
  if(!confirm('هل تريد حذف هذا المصروف نهائيًا؟')) return;
  currentUserDoc.dailyExpenses = (currentUserDoc.dailyExpenses || []).filter(x=>x.id !== entryId);
  await db.collection('users').doc(currentUserUID).update({ dailyExpenses: currentUserDoc.dailyExpenses });
  // refresh current views
  populateDailyList();
  renderWeeklyTab();
}

/* ========== صفحة التحليلات الأسبوعية ========== */
function renderWeeklyTab(){
  if(!currentUserDoc) return;
  tabWeekly.innerHTML = `
    <div class="card-royal">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <h5>📊 التحليلات الأسبوعية</h5>
        <small style="color:var(--muted)">آخر 7 أيام</small>
      </div>
      <div id="weeklyContent"></div>
    </div>
  `;
  buildWeeklyContent();
}

/* يبني محتوى الأسبوع: كل يوم مع التفاصيل، وتلخيص بحسب الأقسام */
function buildWeeklyContent(){
  const weeklyContent = document.getElementById('weeklyContent');
  // days list
  const today = new Date();
  const days = [];
  for(let i=6;i>=0;i--){ const d = new Date(); d.setDate(today.getDate()-i); days.push( yyyy_mm_dd(d) ); }

  // filter entries in range
  const inRange = (currentUserDoc.dailyExpenses || []).filter(e => days.includes(e.date));
  // sort by date desc then ts desc
  inRange.sort((a,b)=>{
    if(a.date === b.date) return new Date(b.ts) - new Date(a.ts);
    return new Date(b.date) - new Date(a.date);
  });

  // group by day
  let html = '';
  if(inRange.length === 0){
    html += `<div style="padding:12px; color:var(--muted)">لا توجد مصاريف في آخر 7 أيام.</div>`;
  } else {
    // for each day show header and its entries
    days.forEach(day=>{
      const dayEntries = inRange.filter(e=>e.date === day);
      if(dayEntries.length === 0) return;
      const dayTotal = dayEntries.reduce((s,x)=>s + Number(x.amount||0), 0);
      html += `<div style="margin-top:10px; padding:10px; border-radius:10px; background:#fff; box-shadow:var(--card-shadow);">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div><strong>${friendlyDayLabel(day)}</strong><div style="font-size:13px;color:var(--muted)">${day}</div></div>
          <div style="font-weight:800; color:var(--main-blue)">${formatCurrency(dayTotal)}</div>
        </div>
        <div style="margin-top:10px; display:flex; flex-direction:column; gap:8px;">`;

      dayEntries.forEach(en=>{
        html += `<div class="cat-entry">
          <div style="flex:1;">
            <div style="font-weight:700">${escapeHtml(en.category)}</div>
            <div style="font-size:13px;color:var(--muted)">${escapeHtml(en.note||'-')}</div>
            <div style="font-size:12px;color:#94a3b8;margin-top:6px">${new Date(en.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          </div>
          <div style="text-align:right">
            <div style="font-weight:800;color:var(--main-blue)">${formatCurrency(en.amount)}</div>
            <div style="margin-top:6px; display:flex; gap:6px; justify-content:flex-end;">
              <button class="btn btn-sm btn-outline-secondary" onclick="openEdit('${en.id}')">✏️</button>
              <button class="btn btn-sm btn-outline-danger" onclick="removeEntry('${en.id}')">🗑️</button>
            </div>
          </div>
        </div>`;
      });

      html += `</div></div>`;
    });
  }

  // Category summaries
  const catTotals = {};
  (currentUserDoc.dailyExpenses || []).forEach(e=>{
    // only week
    const daysRange = days;
    if(!daysRange.includes(e.date)) return;
    if(!catTotals[e.category]) catTotals[e.category]=0;
    catTotals[e.category] += Number(e.amount||0);
  });

  // categories list includes those in allocations + any spent categories
  const allCats = new Set([ ...Object.keys(currentUserDoc.categories || {}), ...Object.keys(catTotals) ]);

  // build summaries grid
  html += `<div style="margin-top:12px;">
    <h6>ملخص الأقسام هذا الأسبوع</h6>
    <div class="weekly-grid">`;
  allCats.forEach(cat=>{
    const alloc = Number(currentUserDoc.categories && currentUserDoc.categories[cat] ? currentUserDoc.categories[cat] : 0);
    const spent = Number(catTotals[cat]||0);
    const remaining = alloc - spent;
    // entries list for this cat
    const entries = (currentUserDoc.dailyExpenses || []).filter(e=>e.category===cat && days.includes(e.date)).sort((a,b)=> new Date(b.date) - new Date(a.date) || new Date(b.ts)-new Date(a.ts));

    html += `<div class="weekly-card">
      <div style="display:flex; justify-content:space-between; align-items:center;">
        <div><strong>${escapeHtml(cat)}</strong><div style="font-size:13px;color:var(--muted)">مخصص: ${formatCurrency(alloc)}</div></div>
        <div style="text-align:right">
          <div style="font-weight:800;color:var(--main-blue)">${formatCurrency(spent)}</div>
          <div style="font-size:13px; color:${remaining<0? 'var(--danger)' : 'var(--success)'}; margin-top:6px;">
            ${ remaining < 0 ? 'تجاوز بـ ' + formatCurrency(Math.abs(remaining)) : 'المتبقي ' + formatCurrency(remaining) }
          </div>
        </div>
      </div>
      <div style="margin-top:8px; font-size:13px; color:var(--muted)"><small>تفاصيل الصرف من هذا القسم خلال الأسبوع:</small></div>`;

    if(entries.length){
      entries.forEach(en=>{
        html += `<div class="cat-entry">
          <div>
            <div style="font-weight:600">${escapeHtml(en.note||'-')}</div>
            <div style="font-size:12px;color:var(--muted)">${en.date} • ${new Date(en.ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
          </div>
          <div style="font-weight:800;color:var(--main-blue)">${formatCurrency(en.amount)}</div>
        </div>`;
      });
    } else {
      html += `<div style="margin-top:8px;color:var(--muted); font-size:13px">لا توجد مصاريف لهذا القسم هذا الأسبوع</div>`;
    }

    html += `</div>`; // weekly-card
  });
  html += `</div></div>`; // close grid and section

  // overall totals
  const overallTotal = Object.values(catTotals).reduce((s,v)=>s+Number(v||0),0);
  html += `<div class="totals">
    <div>
      <div style="font-size:13px;color:#334155">إجمالي المصروف هذا الأسبوع</div>
      <div style="font-weight:800; font-size:18px; margin-top:6px">${formatCurrency(overallTotal)}</div>
    </div>
    <div style="text-align:right">
      <div style="font-size:13px;color:#334155">عدد القيود</div>
      <div style="font-weight:700; font-size:16px; margin-top:6px">${inRange.length}</div>
    </div>
  </div>`;

  weeklyContent.innerHTML = html;
}

/* friendly day label Arabic */
function friendlyDayLabel(iso){
  const d = new Date(iso);
  const daysAr = ['الأحد','الاثنين','الثلاثاء','الأربعاء','الخميس','الجمعة','السبت'];
  return `${daysAr[d.getDay()]} ${d.getDate()}/${d.getMonth()+1}`;
}

/* ========== صفحة الحساب (تعديل الأقسام والراتب) ========== */
function renderAccountTab(){
  if(!currentUserDoc) return;
  const categories = currentUserDoc.categories || {};
  const rows = Object.keys(categories).map(cat=>{
    return `<div class="d-flex gap-2 mb-2">
      <input class="form-control cat-name" value="${escapeHtml(cat)}" placeholder="اسم القسم">
      <input class="form-control cat-alloc" type="number" value="${categories[cat] || 0}" placeholder="المبلغ">
    </div>`;
  }).join('');

  tabAccount.innerHTML = `
    <div class="card-royal">
      <h5>⚙️ حسابك وتخصيص الأقسام</h5>
      <div style="margin-top:8px;">
        <label class="form-label">الراتب</label>
        <input id="salaryInput" type="number" class="form-control mb-2" value="${currentUserDoc.salary || 0}">
        <label class="form-label">قائمة الأقسام</label>
        <div id="catsContainer">${rows}</div>
        <div style="display:flex; gap:8px; margin-top:8px;">
          <button id="addCatBtn" class="btn btn-outline-primary">إضافة قسم</button>
          <button id="saveAccountBtn" class="btn btn-main flex-grow-1">حفظ الإعدادات</button>
        </div>
      </div>
      <div style="margin-top:12px; color:var(--muted); font-size:13px;">
        عدد القيود المخزنة: <strong>${(currentUserDoc.dailyExpenses||[]).length}</strong>
      </div>
    </div>
  `;

  document.getElementById('addCatBtn').onclick = ()=>{
    const div = document.createElement('div');
    div.className = 'd-flex gap-2 mb-2';
    div.innerHTML = `<input class="form-control cat-name" placeholder="اسم القسم">
      <input class="form-control cat-alloc" type="number" placeholder="المبلغ">`;
    document.getElementById('catsContainer').appendChild(div);
  };

  document.getElementById('saveAccountBtn').onclick = async ()=>{
    const salary = parseFloat(document.getElementById('salaryInput').value) || 0;
    const names = Array.from(document.getElementsByClassName('cat-name')).map(i=>i.value.trim()).filter(x=>x);
    const allocs = Array.from(document.getElementsByClassName('cat-alloc')).map(i=>parseFloat(i.value)||0);
    const categories = {};
    for(let i=0;i<names.length;i++){ categories[names[i]] = allocs[i] || 0; }
    // update firestore
    await db.collection('users').doc(currentUserUID).update({ salary, categories });
    // re-fetch and refresh UIs
    await fetchUserDoc();
    renderDailyTab();
    renderWeeklyTab();
    alert('تم حفظ الإعدادات!');
  };
}

/* ========== رد على تغييرات التاريخ في daily (لتحديث القائمة) ========== */
document.addEventListener('change', (e)=>{
  if(e.target && e.target.id === 'inpDate') populateDailyList();
});

/* ========== تحديث البيانات المحلية عند تغيير في الفايرستور (اختياري) ========= */
/* هنا نستخدم fetchUserDoc متى نحتاج تحديث بعد عملياتنا. */
/* لكن لو أردتي مراقبة real-time استخدمي onSnapshot بدل get في fetchUserDoc. */

/* ========== دوال المساعدة عند start ========== */
(async function init(){
  // show auth or app based on auth state (handled by onAuthStateChanged)
  showAuth();
})();

</script>

</body>
</html>
