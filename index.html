<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø±Ø§ØªÙ€Ù€Ø¨</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --main-blue:#3b6bff;
  --light-gray:#f5f5f5;
  --card-shadow:0 6px 18px rgba(0,0,128,0.08);
  --accent-text:#2c003e;
}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--light-gray);
  color: var(--accent-text);
}
#authContainer{
  max-width:400px;
  margin:100px auto;
  padding:20px;
  background:#fff;
  border-radius:16px;
  box-shadow:var(--card-shadow);
}
.btn-main{
  background: var(--main-blue);
  color:#fff;
  border:none;
}
.btn-main:hover{
  background:#5a82ff;
}
.card-royal{
  background:#fff;
  border:none;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:var(--card-shadow);
}
input:focus, .form-control:focus, select:focus{
  box-shadow:none;
  border-color: var(--main-blue);
}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.tabContent{display:none; padding-top:10px;}
.cards-grid{display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap;}
.card-grid-item{
  flex:1 1 45%;
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin:5px;
  text-align:center;
  cursor:pointer;
  box-shadow:var(--card-shadow);
  transition:0.2s;
}
.card-grid-item:hover{transform:translateY(-3px); box-shadow:0 10px 20px rgba(0,0,128,0.12);}
.category-name{font-weight:bold; line-height:38px;}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  border-top:1px solid #ddd;
  padding:8px 0;
  box-shadow:0 -2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.bottom-nav div{
  flex:1;
  text-align:center;
  cursor:pointer;
  font-size:14px;
  color:#333;
}
.bottom-nav .active{color:var(--main-blue); font-weight:bold;}
@media(min-width:768px){
  .cards-grid{flex-wrap:nowrap;}
  .card-grid-item{flex:1; margin:10px;}
}

/* Ø­Ø³Ø§Ø¨Ø§ØªÙŠ â€” Ø¨Ø·Ø§Ù‚Ø§Øª Ø¨Ù†ÙƒÙŠØ© */
.accounts-grid{display:flex; gap:16px; flex-wrap:wrap;}
.bank-card{
  width:280px;
  height:160px;
  border-radius:14px;
  color:white;
  padding:14px;
  position:relative;
  box-shadow:0 6px 20px rgba(0,0,0,0.12);
  display:flex;
  flex-direction:column;
  justify-content:space-between;
}
.bank-card .card-top{display:flex; justify-content:space-between; align-items:start;}
.bank-card .card-balance{font-size:20px; font-weight:700;}
.bank-card .card-name{font-size:14px;}
.bank-card .card-logo{width:52px; height:32px; opacity:0.95;}
.bank-actions{display:flex; gap:8px; margin-top:8px;}
.small-btn{padding:6px 8px; border-radius:8px; font-size:13px; border:none; cursor:pointer;}
.small-btn.primary{background:rgba(255,255,255,0.12); color:#fff;}
.small-btn.danger{background:rgba(255,255,255,0.12); color:#fff; border:1px solid rgba(255,255,255,0.08);}

/* gradients */
.grad-blue{background:linear-gradient(135deg,#2b6df6,#4369ff);}
.grad-purple{background:linear-gradient(135deg,#7b61ff,#d66bff);}
.grad-gold{background:linear-gradient(135deg,#f59e0b,#f97316);}

/* responsive */
@media(max-width:540px){
  .bank-card{width:92%; height:150px;}
}
.expense-entry{
  display:flex;
  gap:5px;
  margin-bottom:5px;
}
.expense-entry input{
  flex:1;
}
.expense-actions{
  display:flex;
  gap:5px;
  margin-top:5px;
}
.expense-actions button{flex:1;}
</style>
</head>
<body>

<div id="authContainer"></div>

<div id="app" style="display:none; max-width:1000px; margin:0 auto; padding-bottom:120px;">
  <div id="welcomeUser" class="h5 mb-3 text-center"></div>

  <div id="dailyTab" class="tabContent"></div>
  <div id="weeklyTab" class="tabContent"></div>
  <div id="accountsTab" class="tabContent"></div>
  <div id="accountTab" class="tabContent"></div>

  <div class="bottom-nav">
    <div data-tab="daily" class="active">ğŸ·ï¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
    <div data-tab="weekly">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</div>
    <div data-tab="accounts">ğŸ’³ Ø­Ø³Ø§Ø¨Ø§ØªÙŠ</div>
    <div data-tab="account">âš™ï¸ Ø­Ø³Ø§Ø¨Ùƒ</div>
    <div onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const authContainer=document.getElementById('authContainer');
const app=document.getElementById('app');
const welcomeUser=document.getElementById('welcomeUser');

// ACCOUNTS stored in localStorage under key 'cvm_accounts'
let accounts = JSON.parse(localStorage.getItem('cvm_accounts')) || [];

/* ===== Category â†’ Account mapping ===== */
function loadCategoryMapping() {
  return JSON.parse(localStorage.getItem('cvm_cat_mapping') || '{}');
}
function saveCategoryMapping(mapping) {
  localStorage.setItem('cvm_cat_mapping', JSON.stringify(mapping));
}

/* ===== Login / Signup ===== */
function showLogin(){
  authContainer.innerHTML=`
    <input type="email" id="email" class="form-control mb-2" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="password" class="form-control mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="btn btn-main w-100 mb-2" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button class="btn btn-outline-primary w-100 mb-2" onclick="signupStep1()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <button class="btn btn-outline-secondary w-100" onclick="googleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¨Ù€ Google</button>
  `;
}
function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert(err.message));
}
function signupStep1(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,password).then(cred=>{
    db.collection('users').doc(cred.user.uid).set({
      categories:{}, dailyExpenses:[], salary:0, incomeSources:0, loans:0, lastSalaryDate:null
    });
  }).catch(err=>alert(err.message));
}
function googleLogin(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}
function logout(){ auth.signOut(); }

/* ===== Bottom Navigation ===== */
document.querySelectorAll('.bottom-nav div[data-tab]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
    document.getElementById(btn.dataset.tab+'Tab').style.display='block';
    document.querySelectorAll('.bottom-nav div').forEach(d=>d.classList.remove('active'));
    btn.classList.add('active');
    if(btn.dataset.tab==='accounts') renderAccounts();
  });
});

/* ===== Load User Data ===== */
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display='none';
    app.style.display='block';
    welcomeUser.textContent=`Ø£Ù‡Ù„Ø§Ù‹ØŒ ${user.email} ğŸ‘‹`;
    loadUserData(user.uid);
  } else{
    authContainer.style.display='block';
    app.style.display='none';
    showLogin();
  }
});

async function loadUserData(uid){
  const docSnap = await db.collection('users').doc(uid).get();
  if(!docSnap.exists){ alert("Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return; }
  const data=docSnap.data();
  if(!data.salary || Object.keys(data.categories).length===0){
    renderInitialSetup(uid, data);
    return;
  }
  renderDailyTab(data, uid);
  renderWeeklyTab(data, uid);
  renderAccountTab(data, uid);
  renderAccounts();
  document.querySelector('.bottom-nav div[data-tab="daily"]').click();
}

/* ===== Initial Setup ===== */
function renderInitialSetup(uid, data){
  const container=document.getElementById('dailyTab');
  container.style.display='block';
  container.innerHTML=`
    <div class="card card-royal mx-auto" style="max-width:520px;">
      <h5>Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ø¯Ø®Ù„</h5>
      <input type="number" id="salaryInput" class="form-control mb-2" placeholder="Ø±Ø§ØªØ¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ" value="${data.salary||''}">
      <input type="number" id="incomeInput" class="form-control mb-2" placeholder="Ù…ØµØ§Ø¯Ø± Ø¯Ø®Ù„ Ø£Ø®Ø±Ù‰" value="${data.incomeSources||''}">
      <input type="number" id="loansInput" class="form-control mb-2" placeholder="Ø£ÙŠ Ù‚Ø±ÙˆØ¶ Ø£Ùˆ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª" value="${data.loans||''}">
      <h5 class="mt-3">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº</h5>
      <div id="userCategoriesContainer"></div>
      <button id="addCategoryBtn" class="btn btn-outline-primary mb-2 w-100">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
      <button id="saveSetupBtn" class="btn btn-main mt-2 w-100">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
  `;
  const userCategoriesContainer=document.getElementById('userCategoriesContainer');
  function addCategoryRow(name="",alloc=""){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2";
    div.innerHTML=`<input type="text" class="form-control category-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…" value="${name}">
      <input type="number" class="form-control category-alloc-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" value="${alloc}">`;
    userCategoriesContainer.appendChild(div);
  }
  for(let i=0;i<3;i++) addCategoryRow();
  document.getElementById('addCategoryBtn').onclick=()=> addCategoryRow();
  document.getElementById('saveSetupBtn').onclick=async ()=>{
    const salary=parseFloat(document.getElementById('salaryInput').value)||0;
    const income=parseFloat(document.getElementById('incomeInput').value)||0;
    const loans=parseFloat(document.getElementById('loansInput').value)||0;
    const nameInputs=document.getElementsByClassName('category-name-input');
    const allocInputs=document.getElementsByClassName('category-alloc-input');
    let categoriesObj={};
    for(let i=0;i<nameInputs.length;i++){
      const name=nameInputs[i].value.trim();
      const alloc=parseFloat(allocInputs[i].value)||0;
      if(name) categoriesObj[name]=alloc;
    }
    await db.collection('users').doc(uid).update({
      salary:salary,
      incomeSources:income,
      loans:loans,
      categories:categoriesObj
    });
    alert("ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª âœ…");
    loadUserData(uid);
  }
}

/* ===== Daily Tab ===== */
function renderDailyTab(data,uid){
  const container=document.getElementById('dailyTab');
  container.innerHTML="";
  const grid=document.createElement('div');
  grid.className="cards-grid";
  for(const cat in data.categories){
    const card=document.createElement('div');
    card.className="card-grid-item";
    card.textContent=`${cat}: ${data.categories[cat]} Ø±ÙŠØ§Ù„`;
    card.onclick=()=>{ addExpense(cat,data,uid); }
    grid.appendChild(card);
  }
  container.appendChild(grid);
}

/* ===== Add Expense ===== */
function addExpense(cat,data,uid){
  const amount=prompt(`Ø£Ø¯Ø®Ù„ Ù‚ÙŠÙ…Ø© Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„Ù‚Ø³Ù… "${cat}"`);
  if(!amount) return;
  const amt=parseFloat(amount);
  if(isNaN(amt) || amt<=0){ alert("Ø§Ù„Ù‚ÙŠÙ…Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©"); return; }
  const date=new Date().toISOString();
  const expenseObj={cat:cat, amount:amt, date:date};
  // Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù‚Ø³Ù…
  let accName=prompt("Ø§Ø¯Ø®Ù„ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø£Ùˆ Ø§ØªØ±ÙƒÙ‡ ÙØ§Ø±Øº Ù„Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù‚Ø³Ù…")||"";
  if(!accName){
    const mapping=loadCategoryMapping();
    if(mapping && mapping[cat]) accName=mapping[cat];
  }
  if(accName){
    const idx=accounts.findIndex(a=>a.name===accName);
    if(idx!==-1){
      accounts[idx].balance=parseFloat((accounts[idx].balance-amt).toFixed(2));
      localStorage.setItem('cvm_accounts',JSON.stringify(accounts));
    }
  }
  db.collection('users').doc(uid).update({
    dailyExpenses:firebase.firestore.FieldValue.arrayUnion(expenseObj)
  }).then(()=> alert("ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙ âœ…"));
}

/* ===== Weekly Tab (ØªØ­Ù„ÙŠÙ„Ø§Øª) ===== */
function renderWeeklyTab(data,uid){
  const container=document.getElementById('weeklyTab');
  container.innerHTML="<p>Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ© Ù‡Ù†Ø§</p>";
}

/* ===== Accounts Tab (Ø¨Ø·Ø§Ù‚Ø§ØªÙƒ Ø§Ù„Ø¨Ù†ÙƒÙŠØ©) ===== */
function renderAccounts(){
  const container=document.getElementById('accountsTab');
  container.innerHTML="<h5>Ø­Ø³Ø§Ø¨Ø§ØªÙƒ Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</h5>";
  const grid=document.createElement('div'); grid.className="accounts-grid";
  accounts.forEach((acc,idx)=>{
    const card=document.createElement('div'); card.className='bank-card grad-blue';
    card.innerHTML=`
      <div class="card-top">
        <div class="card-balance">${acc.balance.toFixed(2)} Ø±ÙŠØ§Ù„</div>
        <div class="card-logo">ğŸ¦</div>
      </div>
      <div class="card-name">${acc.name}</div>
      <div class="bank-actions">
        <button class="small-btn primary" onclick="addMoney(${idx})">ğŸ’° Ø¥Ø¶Ø§ÙØ©</button>
        <button class="small-btn danger" onclick="removeAccount(${idx})">ğŸ—‘ï¸ Ø­Ø°Ù</button>
      </div>
    `;
    grid.appendChild(card);
  });
  container.appendChild(grid);
  const addBtn=document.createElement('button');
  addBtn.className="btn btn-main mt-2 w-100";
  addBtn.textContent="Ø¥Ø¶Ø§ÙØ© Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯";
  addBtn.onclick=()=>{ 
    const name=prompt("Ø§Ø³Ù… Ø§Ù„Ø­Ø³Ø§Ø¨"); 
    const bal=parseFloat(prompt("Ø§Ù„Ø±ØµÙŠØ¯ Ø§Ù„Ø§Ø¨ØªØ¯Ø§Ø¦ÙŠ"))||0;
    accounts.push({name:name,balance:bal});
    localStorage.setItem('cvm_accounts',JSON.stringify(accounts));
    renderAccounts();
  }
  container.appendChild(addBtn);
}
function addMoney(idx){
  const val=parseFloat(prompt("Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…Ø¨Ù„Øº"))||0;
  accounts[idx].balance+=val;
  localStorage.setItem('cvm_accounts',JSON.stringify(accounts));
  renderAccounts();
}
function removeAccount(idx){
  if(confirm("Ù‡Ù„ ØªØ±ÙŠØ¯ Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ")){
    accounts.splice(idx,1);
    localStorage.setItem('cvm_accounts',JSON.stringify(accounts));
    renderAccounts();
  }
}

/* ===== Account Tab (Ø±Ø¨Ø· Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª) ===== */
function renderAccountTab(data,uid){
  const container=document.getElementById('accountTab');
  container.innerHTML=`
    <h5>Ø±Ø¨Ø· Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø¨Ø§Ù„Ø­Ø³Ø§Ø¨Ø§Øª Ø§Ù„Ø¨Ù†ÙƒÙŠØ©</h5>
    <div id="editCategoriesContainer"></div>
  `;
  renderCategoryAccountMappingUI(data);
}

/* ===== Category â†” Account Mapping UI ===== */
function renderCategoryAccountMappingUI(data){
  const container=document.getElementById('editCategoriesContainer');
  if(!container) return;
  container.innerHTML="";
  const mapping=loadCategoryMapping();
  for(const cat of Object.keys(data.categories || {})){
    const row=document.createElement('div');
    row.className="d-flex gap-2 mb-2 align-items-center";
    const span=document.createElement('div'); span.style.flex='1'; span.textContent=cat;
    const sel=document.createElement('select'); sel.className='form-select'; sel.style.flex='1';
    const optNone=document.createElement('option'); optNone.value=''; optNone.textContent='-- Ø§Ø®ØªØ± Ø­Ø³Ø§Ø¨ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ) --';
    sel.appendChild(optNone);
    accounts.forEach(acc=>{
      const o=document.createElement('option');
      o.value=acc.name; o.textContent=`${acc.name} â€” ${acc.balance.toFixed(2)} Ø±ÙŠØ§Ù„`;
      sel.appendChild(o);
    });
    if(mapping[cat]) sel.value=mapping[cat];
    sel.onchange=()=>{ 
      const m=loadCategoryMapping();
      if(sel.value) m[cat]=sel.value; else delete m[cat];
      saveCategoryMapping(m);
    }
    row.appendChild(span); row.appendChild(sel); container.appendChild(row);
  }
}
</script>
</body>
</html>
