<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€” Budget Planner</title>

<!-- Bootstrap 5 -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
:root{
  --royal-purple:#4b0082;
  --royal-gold:#d6b86a;
  --royal-silver:#c0c0c0;
  --light-purple:#a76bcf;
  --card-shadow:0 6px 18px rgba(75,0,130,0.2);
  --accent-text:#2c003e;
}
body{
  background: linear-gradient(180deg,#f2e9ff 0%,#ffffff 100%);
  color: var(--accent-text);
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  padding-bottom:40px;
}
.card-royal{
  background: linear-gradient(180deg, rgba(75,0,130,0.05), rgba(167,107,207,0.05));
  border:none;
  box-shadow: var(--card-shadow);
  border-radius:16px;
}
.stat-card{
  border-radius:14px;
  padding:18px;
}
.category-name{
  font-weight:700;
  font-size:0.95rem;
}
.small-muted{
  color:#7a5a67;
  font-size:0.88rem;
}
.btn-gold{
  background: var(--royal-gold);
  color:#3b2d1d;
  border:none;
}
.btn-royal{
  background: var(--royal-purple);
  color: var(--royal-gold);
  border:none;
}
.btn-royal:hover{
  background: var(--light-purple);
}
.form-control:focus{
  box-shadow:none;
  border-color: var(--royal-purple);
}
.expense-input.over-limit{
  border-color:red;
  background-color:#ffe6e6;
}
footer{
  margin-top:30px;
  color:#7a5a67;
  font-size:0.9rem;
}
.note{
  font-size:0.86rem;
  color:#8a5a6d;
}
</style>
</head>
<body>
<div class="container py-4">
  <header class="mb-3">
    <h3 class="text-center mb-3">ğŸ‘‘ Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3>
    <div id="authContainer" class="text-center"></div>
  </header>

  <div id="app" style="display:none;">
    <div id="budgetContainer"></div>
  </div>

  <footer class="text-center mt-4">
    Ù…ØµÙ…Ù… Ù„ÙƒÙ â€” Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€¢ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø­Ø§Ø¨ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
  </footer>
</div>

<script>
// ===== Firebase config =====
const firebaseConfig = {
  apiKey: "AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain: "budget-salary.firebaseapp.com",
  projectId: "budget-salary",
  storageBucket: "budget-salary.firebasestorage.app",
  messagingSenderId: "833349662009",
  appId: "1:833349662009:web:2fb64df1fe71a801a0a4e8",
  measurementId: "G-0LS4TCBJYZ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// ===== DOM elements =====
const authContainer = document.getElementById('authContainer');
const app = document.getElementById('app');
const budgetContainer = document.getElementById('budgetContainer');

let tempEmail="", tempPassword="";

// ===== Login / Signup =====
function showLogin(){
  authContainer.innerHTML = `
  <div class="card p-3 card-royal mx-auto" style="max-width:400px;">
    <h5 class="mb-3 text-center">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h5>
    <input type="email" id="email" class="form-control mb-2" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="password" class="form-control mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button id="loginBtn" class="btn btn-gold w-100 mb-2">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button id="signupBtn" class="btn btn-outline-primary w-100 mb-2">ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
    <button id="googleBtn" class="btn btn-outline-danger w-100">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù€ Google</button>
  </div>
  `;
  document.getElementById('loginBtn').onclick = login;
  document.getElementById('signupBtn').onclick = signupStep1;
  document.getElementById('googleBtn').onclick = googleLogin;
}

function login(){
  const email = document.getElementById('email').value;
  const password = document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(e=>alert(e.message));
}

function signupStep1(){
  tempEmail = document.getElementById('email').value;
  tempPassword = document.getElementById('password').value;
  if(!tempEmail || !tempPassword){alert("Ø§Ø¯Ø®Ù„ÙŠ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"); return;}
  
  authContainer.innerHTML = `
  <div class="card p-3 card-royal mx-auto" style="max-width:500px;">
    <h5 class="mb-3 text-center">Ø§Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h5>
    <input type="number" id="salary" class="form-control mb-2" placeholder="Ø§Ø¯Ø®Ù„ÙŠ Ø±Ø§ØªØ¨Ùƒ Ø§Ù„Ø´Ù‡Ø±ÙŠ">
    <input type="number" id="installments" class="form-control mb-2" placeholder="Ù…Ø¨Ù„Øº Ø§Ù„Ø§Ù‚Ø³Ø§Ø· Ø§Ù„Ø´Ù‡Ø±ÙŠØ© (Ø¥Ù† ÙˆØ¬Ø¯)">
    <div id="categoriesContainer"></div>
    <button id="addCategoryBtn" class="btn btn-outline-primary w-100 mb-2">Ø§Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
    <button id="finishSignupBtn" class="btn btn-gold w-100">Ø§Ù†Ù‡Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„</button>
  </div>
  `;

  const categoriesContainer = document.getElementById('categoriesContainer');
  document.getElementById('addCategoryBtn').onclick = ()=>{
    const div = document.createElement('div');
    div.className = "d-flex gap-2 mb-2";
    div.innerHTML = `
      <input type="text" class="form-control category-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…">
      <input type="number" class="form-control category-amount-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº Ø§Ù„Ø´Ù‡Ø±ÙŠ">
    `;
    categoriesContainer.appendChild(div);
  };

  document.getElementById('finishSignupBtn').onclick = async ()=>{
    const salary = parseFloat(document.getElementById('salary').value)||0;
    const installments = parseFloat(document.getElementById('installments').value)||0;
    const categoryNames = Array.from(document.getElementsByClassName('category-name-input')).map(i=>i.value.trim()).filter(i=>i);
    const categoryAmounts = Array.from(document.getElementsByClassName('category-amount-input')).map(i=>parseFloat(i.value)||0);
    if(categoryNames.length===0){alert("Ø£Ø¶ÙŠÙÙŠ Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return;}
    const categories = {};
    for(let i=0;i<categoryNames.length;i++){ categories[categoryNames[i]] = categoryAmounts[i]; }

    auth.createUserWithEmailAndPassword(tempEmail,tempPassword)
    .then(async userCredential=>{
        const uid = userCredential.user.uid;
        await db.collection('users').doc(uid).set({
            salary,
            installments,
            categories,
            dailyExpenses: []
        });
        loadUserData(uid);
    }).catch(e=>alert(e.message));
  };
}

function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(e=>alert(e.message));
}

// ===== Auth state =====
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display='none';
    app.style.display='block';
    loadUserData(user.uid);
  }else{
    authContainer.style.display='block';
    app.style.display='none';
    showLogin();
  }
});

// ===== Load User Data =====
async function loadUserData(uid){
  const docRef = db.collection('users').doc(uid);
  const docSnap = await docRef.get();
  if(!docSnap.exists){
    budgetContainer.innerHTML = `<div class="text-center">Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©</div>`;
    return;
  }
  const data = docSnap.data();
  renderBudget(data, uid);
}

// ===== Render Budget =====
function renderBudget(data, uid){
  budgetContainer.innerHTML = `
  <div class="card p-3 card-royal">
    <h5 class="mb-3">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h5>
    <div class="mb-3">
      <input type="date" id="expenseDate" class="form-control mb-2" value="${new Date().toISOString().split('T')[0]}">
      <div id="expenseInputs"></div>
      <button id="addExpenseBtn" class="btn btn-outline-primary mb-2">Ø§Ø¶Ø§ÙØ© Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª</button>
      <button id="endMonthBtn" class="btn btn-gold mb-2">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± â†’ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø§Ø¯Ø®Ø§Ø±</button>
      <button id="resetBtn" class="btn btn-outline-danger mb-2">Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨</button>
    </div>

    <div id="predictionsContainer" class="mb-3"></div>
    <div id="savingTipsContainer" class="mb-3 note"></div>

    <canvas id="pieChart" height="200"></canvas>
  </div>
  `;

  const expenseInputs = document.getElementById('expenseInputs');
  for(const cat in data.categories){
    const div = document.createElement('div');
    div.className = "d-flex gap-2 mb-2";
    div.innerHTML = `
      <span class="category-name w-50">${cat}</span>
      <input type="number" class="form-control w-50 expense-input" placeholder="Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ" data-cat="${cat}" data-limit="${data.categories[cat]}">
    `;
    expenseInputs.appendChild(div);
  }

  document.getElementById('addExpenseBtn').onclick = async ()=>{
    const date = document.getElementById('expenseDate').value;
    const newExpenses = {};
    let overLimitCats = [];
    Array.from(document.getElementsByClassName('expense-input')).forEach(inp=>{
      const cat = inp.dataset.cat;
      const limit = parseFloat(inp.dataset.limit);
      const val = parseFloat(inp.value)||0;
      newExpenses[cat] = val;
      if(val > limit){
        inp.classList.add('over-limit');
        overLimitCats.push(cat);
      } else {
        inp.classList.remove('over-limit');
      }
    });
    if(overLimitCats.length>0){
      alert("ØªÙ†Ø¨ÙŠÙ‡! Ù„Ù‚Ø¯ ØªØ¬Ø§ÙˆØ²Øª Ø§Ù„Ø­Ø¯ ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… Ø§Ù„ØªØ§Ù„ÙŠØ©: " + overLimitCats.join(", "));
    }

    data.dailyExpenses.push({date, expenses:newExpenses});
    await db.collection('users').doc(uid).update({dailyExpenses:data.dailyExpenses});
    renderChart(data);
    renderPredictions(data);
    renderSavingTips(data);
  };

  document.getElementById('endMonthBtn').onclick = async ()=>{
    let totalSpent = 0;
    for(const day of data.dailyExpenses) for(const cat in day.expenses) totalSpent+=day.expenses[cat];
    let totalBudget = Object.values(data.categories).reduce((a,b)=>a+b,0);
    let remaining = totalBudget - totalSpent;
    alert(`ØªÙ… ØªØ­ÙˆÙŠÙ„ ${remaining.toFixed(2)} Ø±ÙŠØ§Ù„ Ù„Ù„Ø§Ø¯Ø®Ø§Ø±`);
    data.categories["Ø§Ø¯Ø®Ø§Ø±"] = (data.categories["Ø§Ø¯Ø®Ø§Ø±"]||0) + remaining;
    await db.collection('users').doc(uid).update({categories:data.categories});
    renderChart(data);
    renderPredictions(data);
    renderSavingTips(data);
  };

  document.getElementById('resetBtn').onclick = async ()=>{
    if(!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯Ø© Ù…Ù† Ø¥Ø¹Ø§Ø¯Ø© Ø¶Ø¨Ø· Ø§Ù„Ø­Ø³Ø§Ø¨ØŸ Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!")) return;
    await db.collection('users').doc(uid).delete();
    alert("ØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª! Ø³ÙŠØªÙ… Ø¥Ø¹Ø§Ø¯Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ© Ù…Ù† Ø§Ù„Ø¨Ø¯Ø§ÙŠØ©.");
    signupStep1();
  };

  renderChart(data);
  renderPredictions(data);
  renderSavingTips(data);
}

// ===== Chart =====
function renderChart(data){
  const ctx = document.getElementById('pieChart').getContext('2d');
  const chartData = {
    labels: Object.keys(data.categories),
    datasets:[{
      data: Object.values(data.categories),
      backgroundColor: ["#a76bcf","#4b0082","#d6b86a","#f3b1c6","#d67a9f","#ffc0cb","#c0c0c0"]
    }]
  };
  if(window.myChart) window.myChart.destroy();
  window.myChart = new Chart(ctx,{type:'pie',data:chartData});
}

// ===== ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¥Ù†ÙØ§Ù‚ =====
function renderPredictions(data){
  const container = document.getElementById('predictionsContainer');
  container.innerHTML = `<h6>ğŸ“Š ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø±</h6>`;
  const today = new Date();
  const daysInMonth = new Date(today.getFullYear(), today.getMonth()+1,0).getDate();
  const spentDays = new Set(data.dailyExpenses.map(d=>d.date));
  const remainingDays = daysInMonth - spentDays.size || 1;

  for(const cat in data.categories){
    const totalSpent = data.dailyExpenses.reduce((sum, day)=>{
      return sum + (day.expenses[cat] || 0);
    },0);
    const avgDaily = totalSpent / (spentDays.size||1);
    const predicted = avgDaily * remainingDays + totalSpent;
    const over = predicted > data.categories[cat] ? "âš ï¸ ØªØ¬Ø§ÙˆØ² Ù…Ø­ØªÙ…Ù„" : "âœ… Ø¶Ù…Ù† Ø§Ù„Ø­Ø¯";
    container.innerHTML += `<div>${cat}: Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ Ù„Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø± ${predicted.toFixed(2)} Ø±ÙŠØ§Ù„ â€” ${over}</div>`;
  }
}

// ===== Ù†ØµØ§Ø¦Ø­ Ø§Ø¯Ø®Ø§Ø± Ø°ÙƒÙŠØ© =====
function renderSavingTips(data){
  const container = document.getElementById('savingTipsContainer');
  container.innerHTML = `<h6>ğŸ’¡ Ù†ØµØ§Ø¦Ø­ Ø§Ø¯Ø®Ø§Ø± Ø°ÙƒÙŠØ©</h6>`;
  let tips = [];
  for(const cat in data.categories){
    const totalSpent = data.dailyExpenses.reduce((sum, day)=>{
      return sum + (day.expenses[cat] || 0);
    },0);
    if(totalSpent > data.categories[cat]*0.8){
      tips.push(`Ù‚Ù„Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚ ÙÙŠ ${cat} Ù„ØªÙˆÙÙŠØ± Ø£ÙƒØ«Ø±`);
    } else if(totalSpent < data.categories[cat]*0.5){
      tips.push(`ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ø³ØªØ«Ù…Ø§Ø± Ø§Ù„ÙØ§Ø¦Ø¶ Ù…Ù† ${cat} ÙÙŠ Ø§Ù„Ø§Ø¯Ø®Ø§Ø±`);
    }
  }
  container.innerHTML += tips.length ? tips.join("<br>") : "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµØ§Ø¦Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ØŒ Ø§Ø³ØªÙ…Ø±ÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ø§Ø¡ ğŸ‘";
}
</script>
</body>
</html>
