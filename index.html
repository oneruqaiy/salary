<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€” Budget Planner</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --bg:#f5f6fa;           /* Ø®Ù„ÙÙŠØ© Ø§Ù„ØµÙØ­Ø© */
      --card-bg:#ffffff;      /* Ø®Ù„ÙÙŠØ© Ø§Ù„ÙƒØ§Ø±Ø¯ */
      --title-blue:#1e3a8a;   /* Ø¹Ù†Ø§ÙˆÙŠÙ† */
      --btn-blue:#2563eb;     /* Ø£Ø²Ø±Ø§Ø± */
      --muted:#6b7280;        /* Ù†Øµ Ø«Ø§Ù†ÙˆÙŠ */
      --border:#e6edf8;       /* Ø­Ø¯ÙˆØ¯ Ù†Ø§Ø¹Ù…Ø© */
      --shadow: 0 6px 18px rgba(30,58,138,0.06);
    }
    body{
      background:var(--bg);
      color:#1f2937;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      padding-bottom:40px;
    }
    h3,h5 { color:var(--title-blue); }
    .card-soft{
      background:var(--card-bg);
      border:1px solid var(--border);
      border-radius:12px;
      box-shadow:var(--shadow);
    }
    .btn-primary{
      background:var(--btn-blue);
      border:none;
    }
    .btn-primary:hover{ background:#1e40af; }
    .btn-outline-primary{
      color:var(--btn-blue);
      border-color:var(--btn-blue);
    }
    .btn-outline-primary:hover{
      background:var(--btn-blue); color:#fff;
    }
    .form-control:focus{
      border-color:var(--btn-blue);
      box-shadow:0 0 0 0.15rem rgba(37,99,235,0.12);
    }
    .category-name{ font-weight:700; font-size:0.95rem; }
    .note{ color:var(--muted); font-size:0.9rem; }
    .small-muted{ color:var(--muted); font-size:0.86rem; }
    canvas{ background:#fff; border-radius:10px; padding:6px; box-shadow:var(--shadow); }
    .expense-input.over-limit{ border-color:#ff4d4f; background:#fff1f0; }
    @media (max-width:767px){
      .category-name{ font-size:0.88rem; }
      canvas{ height:160px !important; }
    }
  </style>
</head>
<body>
<div class="container py-4">
  <header class="mb-4 text-center">
    <h3 class="fw-bold mb-2">ğŸ‘‘ Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ</h3>
    <div id="authContainer" class="d-flex justify-content-center"></div>
  </header>

  <main id="app" style="display:none;">
    <div id="setupContainer" class="mb-3"></div>
    <div id="budgetContainer" class="mb-3"></div>

    <!-- small line chart under budget -->
    <div class="mb-4">
      <canvas id="lineChart" height="120"></canvas>
    </div>
  </main>

  <footer class="text-center mt-4 note">
    Ù…ØµÙ…Ù… Ù„ÙƒÙ â€” Ø±Ø§ØªØ¨ÙŠ Ø§Ù„Ø°ÙƒÙŠ â€¢ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù…Ø­ÙÙˆØ¸Ø© Ø³Ø­Ø§Ø¨ÙŠÙ‹Ø§ Ù„ÙƒÙ„ Ù…Ø³ØªØ®Ø¯Ù…
  </footer>
</div>

<script>
/* ================== Firebase config ================== */
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
  measurementId:"G-0LS4TCBJYZ"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

/* ================== DOM refs ================== */
const authContainer = document.getElementById('authContainer');
const app = document.getElementById('app');
const setupContainer = document.getElementById('setupContainer');
const budgetContainer = document.getElementById('budgetContainer');

let windowPieChart = null;
let windowLineChart = null;

/* ================== Auth UI (keeps same logic) ================== */
function showLogin(){
  authContainer.innerHTML = `
    <div class="card card-soft p-3" style="max-width:420px; width:100%;">
      <div class="mb-2">
        <input id="emailInput" type="email" class="form-control" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
      </div>
      <div class="mb-3">
        <input id="passwordInput" type="password" class="form-control" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
      </div>
      <div class="d-grid gap-2">
        <button class="btn btn-primary" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
        <button class="btn btn-outline-primary" onclick="signupStep1()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø¬Ø¯ÙŠØ¯</button>
        <button class="btn btn-outline-dark" onclick="googleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¨Ù€ Google</button>
      </div>
    </div>
  `;
}

function login(){
  const email = document.getElementById('emailInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  if(!email || !password){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
  auth.signInWithEmailAndPassword(email, password).catch(e => alert(e.message));
}

function signupStep1(){
  const email = document.getElementById('emailInput').value.trim();
  const password = document.getElementById('passwordInput').value;
  if(!email || !password){ alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±'); return; }
  auth.createUserWithEmailAndPassword(email,password)
    .then(async cred=>{
      // create safe initial doc (merge true so nothing lost)
      await db.collection('users').doc(cred.user.uid).set({
        salary:0,
        incomeSources:0,
        loans:0,
        categories:{},
        dailyExpenses:[]
      }, { merge:true });
      // user will be routed by onAuthStateChanged
    })
    .catch(e=>alert(e.message));
}

function googleLogin(){
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(e=>alert(e.message));
}

/* ================== Auth state change ================== */
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display = 'none';
    app.style.display = 'block';
    loadUserData(user.uid).catch(err=>{
      console.error(err);
      budgetContainer.innerHTML = "<div class='text-center text-danger'>Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>";
    });
  } else {
    authContainer.style.display = 'flex';
    app.style.display = 'none';
    showLogin();
  }
});

/* ================== Load user data & decide initial setup ================== */
async function loadUserData(uid){
  const docRef = db.collection('users').doc(uid);
  const doc = await docRef.get();
  if(!doc.exists){
    budgetContainer.innerHTML = "<div class='text-center'>Ø®Ø·Ø£: Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….</div>";
    return;
  }
  const data = doc.data() || {};
  // normalize
  data.salary = data.salary || 0;
  data.incomeSources = data.incomeSources || 0;
  data.loans = data.loans || 0;
  data.categories = data.categories || {};
  data.dailyExpenses = Array.isArray(data.dailyExpenses) ? data.dailyExpenses : [];

  // If salary or categories missing / empty -> show initial setup
  const noCategories = !data.categories || Object.keys(data.categories).length === 0;
  const noSalary = !data.salary || data.salary === 0;

  if(noSalary || noCategories){
    renderInitialSetup(uid, data);
    return;
  }

  // else render budget view
  renderBudget(data, uid);
}

/* ================== Initial Setup UI (Salary -> income -> loans -> categories) ================== */
function renderInitialSetup(uid, data){
  setupContainer.innerHTML = `
    <div class="card card-soft p-4 mx-auto" style="max-width:620px;">
      <h5 class="mb-3">Ø§Ù„Ø®Ø·ÙˆØ© 1 â€” Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</h5>

      <div class="row g-2">
        <div class="col-md-4">
          <label class="small-muted">Ø§Ù„Ø±Ø§ØªØ¨ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ</label>
          <input id="salaryInput" type="number" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 700" value="${data.salary||''}">
        </div>
        <div class="col-md-4">
          <label class="small-muted">Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
          <input id="incomeInput" type="number" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 200" value="${data.incomeSources||''}">
        </div>
        <div class="col-md-4">
          <label class="small-muted">Ù‚Ø±ÙˆØ¶/Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</label>
          <input id="loansInput" type="number" class="form-control" placeholder="Ù…Ø«Ø§Ù„: 100" value="${data.loans||''}">
        </div>
      </div>

      <hr class="my-3">

      <h5 class="mb-2">Ø§Ù„Ø®Ø·ÙˆØ© 2 â€” Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº</h5>
      <div id="userCategoriesContainer" class="mb-2"></div>

      <div class="d-flex gap-2 mb-2">
        <button id="addCategoryBtn" class="btn btn-outline-primary flex-grow-1">â• Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
        <button id="clearCategoriesBtn" class="btn btn-outline-secondary">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„</button>
      </div>

      <div class="d-grid">
        <button id="saveSetupBtn" class="btn btn-primary">ğŸ’¾ Ø­ÙØ¸ ÙˆØ§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ÙˆØ­Ø©</button>
      </div>
      <div class="small-muted mt-2">ÙŠÙ…ÙƒÙ†Ùƒ Ø¥Ø¶Ø§ÙØ© Ø£ÙŠ Ø¹Ø¯Ø¯ Ù…Ù† Ø§Ù„Ø£Ù‚Ø³Ø§Ù…ØŒ ÙˆØ¨Ø¹Ø¯ Ø§Ù„Ø­ÙØ¸ Ø³ØªÙØ³ØªØ®Ø¯Ù… Ù‡Ø°Ù‡ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙˆÙ‚Ø¹Ø§Øª ÙˆØ§Ù„Ø´Ø§Ø±ØªØ§Øª.</div>
    </div>
  `;

  const container = document.getElementById('userCategoriesContainer');

  function addCategoryRow(name = '', alloc = ''){
    const row = document.createElement('div');
    row.className = 'd-flex gap-2 mb-2';
    row.innerHTML = `
      <input type="text" class="form-control category-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù… (Ù…Ø«Ø§Ù„: Ø£ÙƒÙ„)" value="${escapeHtml(name)}">
      <input type="number" class="form-control category-alloc-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" value="${alloc}">
      <button class="btn btn-outline-danger btn-sm remove-row">âœ–</button>
    `;
    // remove handler
    row.querySelector('.remove-row').addEventListener('click', ()=> row.remove());
    container.appendChild(row);
  }

  // helper to escape any inserted values (avoid broken attributes)
  function escapeHtml(text){
    if(!text) return '';
    return text.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  }

  // prefill with three rows or existing categories
  const existing = data.categories && Object.keys(data.categories).length>0 ? Object.entries(data.categories) : [['Ø§Ø¯Ø®Ø§Ø±','0'],['Ø¨ØªØ±ÙˆÙ„','0'],['Ø§ÙƒÙ„','0']];
  container.innerHTML = '';
  for(const [k,v] of existing) addCategoryRow(k, v);

  document.getElementById('addCategoryBtn').onclick = ()=> addCategoryRow();
  document.getElementById('clearCategoriesBtn').onclick = ()=> { container.innerHTML=''; };

  document.getElementById('saveSetupBtn').onclick = async ()=>{
    const salary = parseFloat(document.getElementById('salaryInput').value) || 0;
    const income = parseFloat(document.getElementById('incomeInput').value) || 0;
    const loans = parseFloat(document.getElementById('loansInput').value) || 0;

    // collect categories
    const nameInputs = container.getElementsByClassName('category-name-input');
    const allocInputs = container.getElementsByClassName('category-alloc-input');
    const categoriesObj = {};
    for(let i=0;i<nameInputs.length;i++){
      const name = nameInputs[i].value.trim();
      const alloc = parseFloat(allocInputs[i].value) || 0;
      if(name) categoriesObj[name] = +alloc;
    }
    if(Object.keys(categoriesObj).length === 0){
      alert('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„ Ù…Ø¹ Ù…Ø¨Ù„Øº Ù…Ø®ØµØµ.');
      return;
    }

    try{
      // use set with merge:true to avoid wiping other fields
      await db.collection('users').doc(uid).set({
        salary: +salary,
        incomeSources: +income,
        loans: +loans,
        categories: categoriesObj,
        dailyExpenses: []
      }, { merge:true });

      // fetch updated doc and render budget immediately
      const updatedDoc = await db.collection('users').doc(uid).get();
      const updatedData = updatedDoc.data();
      // normalize arrays/objects
      updatedData.salary = updatedData.salary || 0;
      updatedData.incomeSources = updatedData.incomeSources || 0;
      updatedData.loans = updatedData.loans || 0;
      updatedData.categories = updatedData.categories || {};
      updatedData.dailyExpenses = Array.isArray(updatedData.dailyExpenses) ? updatedData.dailyExpenses : [];
      renderBudget(updatedData, uid);
    } catch(err){
      console.error(err);
      alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø¹Ù†Ø¯ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. Ø¬Ø±Ø¨ÙŠ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
  };
}

/* ================== Budget View ================== */
function renderBudget(data, uid){
  // hide setup panel
  setupContainer.innerHTML = '';

  // top card with salary / income / loans and small controls
  budgetContainer.innerHTML = `
    <div class="card card-soft p-3">
      <div class="d-flex flex-column flex-md-row justify-content-between gap-3 align-items-start">
        <div>
          <h5 class="mb-1">Ù„ÙˆØ­Ø© Ø§Ù„Ù…ÙŠØ²Ø§Ù†ÙŠØ©</h5>
          <div class="small-muted">Ù†Ø¸Ø±Ø© Ø³Ø±ÙŠØ¹Ø© Ø¹Ù„Ù‰ Ø¯Ø®Ù„Ùƒ ÙˆØ§Ù„ØªØ²Ø§Ù…Ø§ØªÙƒ</div>
        </div>
        <div class="text-md-end">
          <div class="small-muted">Ø§Ù„Ø±Ø§ØªØ¨</div>
          <div class="fw-bold">${numberFormat(data.salary)} Ø±.Ø¹</div>
        </div>
        <div class="text-md-end">
          <div class="small-muted">Ø¯Ø®Ù„ Ø¥Ø¶Ø§ÙÙŠ</div>
          <div class="fw-bold">${numberFormat(data.incomeSources)} Ø±.Ø¹</div>
        </div>
        <div class="text-md-end">
          <div class="small-muted">Ù‚Ø±ÙˆØ¶/Ø§Ù„ØªØ²Ø§Ù…Ø§Øª</div>
          <div class="fw-bold text-danger">${numberFormat(data.loans)} Ø±.Ø¹</div>
        </div>
      </div>

      <hr>

      <div id="expenseInputs" class="mb-3"></div>

      <div class="d-flex gap-2 flex-column flex-sm-row mb-3">
        <button id="addExpenseBtn" class="btn btn-outline-primary flex-grow-1">ØªØ³Ø¬ÙŠÙ„ Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…</button>
        <button id="endMonthBtn" class="btn btn-primary flex-grow-1">Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø´Ù‡Ø± â†’ ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨Ø§Ù‚ÙŠ Ù„Ù„Ø§Ø¯Ø®Ø§Ø±</button>
      </div>

      <div id="predictionsContainer" class="mb-2"></div>
      <div id="savingTipsContainer" class="mb-2 note"></div>

      <div class="mt-3">
        <canvas id="pieChart" height="160"></canvas>
      </div>
    </div>
  `;

  // helper
  function numberFormat(v){ return (Math.round((+v)*100)/100).toLocaleString('en-US'); }

  // fill expense inputs
  const expenseInputs = document.getElementById('expenseInputs');
  expenseInputs.innerHTML = '';
  for(const cat of Object.keys(data.categories)){
    const div = document.createElement('div');
    div.className = 'd-flex gap-2 mb-2';
    div.innerHTML = `
      <div class="flex-grow-1">
        <div class="category-name">${escapeHtml(cat)}</div>
        <div class="small-muted">Ø§Ù„Ù…Ø®ØµØµ: ${numberFormat(data.categories[cat])} Ø±.Ø¹</div>
      </div>
      <div style="width:180px;">
        <input type="number" class="form-control expense-input" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ" data-cat="${escapeHtml(cat)}" data-limit="${data.categories[cat]}">
      </div>
    `;
    expenseInputs.appendChild(div);
  }

  // add expense button behavior
  document.getElementById('addExpenseBtn').onclick = async ()=>{
    const newExpenses = {};
    const overLimit = [];
    const inputs = expenseInputs.getElementsByClassName('expense-input');
    for(let i=0;i<inputs.length;i++){
      const inp = inputs[i];
      const cat = inp.dataset.cat;
      const limit = parseFloat(inp.dataset.limit) || 0;
      const val = parseFloat(inp.value) || 0;
      newExpenses[cat] = val;
      inp.classList.remove('over-limit');
      if(limit && val > limit) { inp.classList.add('over-limit'); overLimit.push(cat); }
    }
    if(overLimit.length>0){
      alert('âš ï¸ ØªØ¬Ø§ÙˆØ² Ø§Ù„Ø­Ø¯ ÙÙŠ Ø§Ù„Ø£Ù‚Ø³Ø§Ù…: ' + overLimit.join(', '));
    }
    // push new day
    data.dailyExpenses = data.dailyExpenses || [];
    data.dailyExpenses.push({ date: new Date().toISOString().split('T')[0], expenses: newExpenses });
    try{
      await db.collection('users').doc(uid).set({ dailyExpenses: data.dailyExpenses }, { merge:true });
      renderChart(data);
      renderPredictions(data);
      renderSavingTips(data);
      renderLineChart(data);
      // clear inputs after save
      for(let i=0;i<inputs.length;i++) inputs[i].value = '';
    } catch(err){
      console.error(err);
      alert('Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª.');
    }
  };

  // end month behavior
  document.getElementById('endMonthBtn').onclick = async ()=>{
    if(!confirm('Ù‡Ù„ ØªØ±ÙŠØ¯ÙŠÙ† Ù†Ù‚Ù„ Ø¨Ù‚Ø§ÙŠØ§ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ© (Ø¥Ù† ÙˆÙØ¬Ø¯Øª) Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ø±Ø§ØªØŸ')) return;
    // compute totals
    let totalSpent = 0;
    for(const day of (data.dailyExpenses||[])){
      for(const cat in day.expenses) totalSpent += (day.expenses[cat] || 0);
    }
    const totalBudget = Object.values(data.categories).reduce((a,b)=>a+b,0);
    const remaining = totalBudget - totalSpent;
    if(remaining <= 0){
      alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ø¨Ø§Ù„Øº ÙØ§Ø¦Ø¶Ø© Ù„Ù†Ù‚Ù„Ù‡Ø§.');
      return;
    }
    // add remaining to 'Ø§Ø¯Ø®Ø§Ø±' category (create if missing)
    data.categories['Ø§Ø¯Ø®Ø§Ø±'] = (data.categories['Ø§Ø¯Ø®Ø§Ø±'] || 0) + remaining;
    try{
      await db.collection('users').doc(uid).set({ categories: data.categories }, { merge:true });
      alert(`ØªÙ… Ù†Ù‚Ù„ ${remaining.toFixed(2)} Ø±.Ø¹ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ø±Ø§Øª.`);
      renderChart(data);
      renderPredictions(data);
      renderSavingTips(data);
      renderLineChart(data);
    } catch(err){
      console.error(err);
      alert('Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø¯Ø®Ø±Ø§Øª.');
    }
  };

  // initial charts and widgets
  renderChart(data);
  renderPredictions(data);
  renderSavingTips(data);
  renderLineChart(data);

  // helper to escape
  function escapeHtml(t){ return (t+'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
}

/* ================== Charts, Predictions, Tips ================== */
function renderChart(data){
  const ctx = document.getElementById('pieChart').getContext('2d');
  const labels = Object.keys(data.categories || {});
  const values = labels.map(k => Number(data.categories[k]||0));
  // color logic: use soft-blues + gray palette, but keep red/yellow/green indication for over-limit in legend color mapping
  const baseColors = ['#1e3a8a','#2563eb','#4f46e5','#60a5fa','#9fb8ff','#cfe3ff','#e8f0ff','#7c93d9'];
  const colors = labels.map((lab,i) => baseColors[i % baseColors.length] || '#cfe3ff');

  if(windowPieChart) windowPieChart.destroy();
  windowPieChart = new Chart(ctx, {
    type: 'pie',
    data: { labels, datasets: [{ data: values, backgroundColor: colors }] },
    options: { plugins:{ legend:{ position:'bottom', labels:{ boxWidth:12 } } }, responsive:true, maintainAspectRatio:false }
  });
}

function renderPredictions(data){
  const container = document.getElementById('predictionsContainer');
  container.innerHTML = "<b>ğŸ“Š ØªÙˆÙ‚Ø¹Ø§Øª Ø§Ù„Ø¥Ù†ÙØ§Ù‚ Ù„Ø¨Ù‚ÙŠØ© Ø§Ù„Ø´Ù‡Ø±:</b><br>";
  const today = new Date().getDate();
  const daysInMonth = new Date(new Date().getFullYear(), new Date().getMonth()+1, 0).getDate();
  const remainingDays = Math.max(1, daysInMonth - today);
  for(const cat in data.categories){
    const spent = (data.dailyExpenses||[]).reduce((s,d)=> s + (d.expenses[cat]||0), 0);
    const remaining = (data.categories[cat] || 0) - spent;
    const dailyPrediction = remainingDays>0 ? (remaining/remainingDays) : 0;
    container.innerHTML += `${escapeHtml(cat)}: ${dailyPrediction.toFixed(2)} Ø±.Ø¹ ÙŠÙˆÙ…ÙŠØ§Ù‹ Ù…ØªÙˆÙ‚Ø¹<br>`;
  }
}

function renderSavingTips(data){
  const container = document.getElementById('savingTipsContainer');
  const tips = [];
  for(const cat in data.categories){
    const spent = (data.dailyExpenses||[]).reduce((s,d)=> s + (d.expenses[cat]||0), 0);
    const limit = data.categories[cat] || 0;
    if(limit && spent > limit) tips.push(`ğŸš¨ Ù‚Ù„Ù„ÙŠ Ø§Ù„Ø¥Ù†ÙØ§Ù‚ ÙÙŠ ${escapeHtml(cat)} (${spent.toFixed(2)} > ${limit.toFixed(2)})`);
    else if(limit && spent < limit*0.5) tips.push(`ğŸ’¡ ØªØ³ØªØ·ÙŠØ¹ÙŠÙ† ØªØ­ÙˆÙŠÙ„ ÙØ§Ø¦Ø¶ ${escapeHtml(cat)} Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø¯Ø®Ø±Ø§Øª`);
  }
  container.innerHTML = tips.length ? tips.join('<br>') : "ğŸŒ¿ Ù„Ø§ ØªÙˆØ¬Ø¯ Ù†ØµØ§Ø¦Ø­ Ø­Ø§Ù„ÙŠØ§Ù‹ â€” Ø§Ø³ØªÙ…Ø±ÙŠ Ø¹Ù„Ù‰ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø¯Ø§Ø¡!";
}

/* simple daily totals line chart (small) */
function renderLineChart(data){
  const ctx = document.getElementById('lineChart').getContext('2d');
  const labels = (data.dailyExpenses||[]).map(d => d.date);
  // aggregate totals per day
  const totals = (data.dailyExpenses||[]).map(d => {
    return Object.values(d.expenses || {}).reduce((a,b)=>a+(b||0),0);
  });
  if(windowLineChart) windowLineChart.destroy();
  windowLineChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'Ù…Ø¬Ù…ÙˆØ¹ Ø§Ù„Ù…ØµØ±ÙˆÙ Ø§Ù„ÙŠÙˆÙ…ÙŠ',
        data: totals,
        tension: 0.3,
        fill: true,
        backgroundColor: 'rgba(37,99,235,0.12)',
        borderColor: '#2563eb',
        pointRadius: 3
      }]
    },
    options: {
      plugins:{ legend:{ display:false } },
      scales:{ y:{ beginAtZero:true } },
      responsive:true,
      maintainAspectRatio:false
    }
  });
}

/* ================== Utils ================== */
// small helper used earlier
function escapeHtml(t){ return (t+'').replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
</script>
</body>
</html>
