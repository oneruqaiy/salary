<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø±Ø§ØªÙ€Ù€Ø¨</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --main-blue:#3b6bff;
  --light-gray:#f5f5f5;
  --card-shadow:0 6px 18px rgba(0,0,128,0.1);
  --accent-text:#2c003e;
}
body{
  margin:0;
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  background: var(--light-gray);
  color: var(--accent-text);
}
#authContainer{
  max-width:400px;
  margin:100px auto;
  padding:20px;
  background:#fff;
  border-radius:16px;
  box-shadow:var(--card-shadow);
}
.btn-main{
  background: var(--main-blue);
  color:#fff;
  border:none;
}
.btn-main:hover{
  background:#5a82ff;
}
.card-royal{
  background:#fff;
  border:none;
  border-radius:16px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:var(--card-shadow);
}
input:focus, .form-control:focus{
  box-shadow:none;
  border-color: var(--main-blue);
}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
.tabContent{display:none; padding-top:10px;}
.cards-grid{display:flex; justify-content:space-between; margin-bottom:20px; flex-wrap:wrap;}
.card-grid-item{
  flex:1 1 45%;
  background:#fff;
  border-radius:16px;
  padding:20px;
  margin:5px;
  text-align:center;
  cursor:pointer;
  box-shadow:var(--card-shadow);
  transition:0.2s;
}
.card-grid-item:hover{transform:translateY(-3px); box-shadow:0 10px 20px rgba(0,0,128,0.15);}
.category-name{font-weight:bold; line-height:38px;}
.bottom-nav{
  position:fixed;
  bottom:0;
  left:0;
  width:100%;
  background:#fff;
  display:flex;
  justify-content:space-around;
  border-top:1px solid #ddd;
  padding:8px 0;
  box-shadow:0 -2px 10px rgba(0,0,0,0.05);
  z-index:100;
}
.bottom-nav div{
  flex:1;
  text-align:center;
  cursor:pointer;
  font-size:14px;
  color:#333;
}
.bottom-nav .active{color:var(--main-blue); font-weight:bold;}
@media(min-width:768px){
  .cards-grid{flex-wrap:nowrap;}
  .card-grid-item{flex:1; margin:10px;}
}
.expense-entry{
  display:flex;
  gap:5px;
  margin-bottom:5px;
}
.expense-entry input{
  flex:1;
}
.expense-actions{
  display:flex;
  gap:5px;
  margin-top:5px;
}
.expense-actions button{flex:1;}
</style>
</head>
<body>

<div id="authContainer"></div>

<div id="app" style="display:none; max-width:900px; margin:0 auto; padding-bottom:80px;">
  <div id="welcomeUser" class="h5 mb-3 text-center"></div>

  <div id="dailyTab" class="tabContent"></div>
  <div id="weeklyTab" class="tabContent"></div>
  <div id="accountTab" class="tabContent"></div>

  <div class="bottom-nav">
    <div data-tab="dailyTab" class="active">ğŸ·ï¸ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</div>
    <div data-tab="weeklyTab">ğŸ“Š Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</div>
    <div data-tab="accountTab">âš™ï¸ Ø­Ø³Ø§Ø¨Ùƒ</div>
    <div onclick="logout()">ğŸšª Ø®Ø±ÙˆØ¬</div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const authContainer=document.getElementById('authContainer');
const app=document.getElementById('app');
const welcomeUser=document.getElementById('welcomeUser');

// ===== Login / Signup =====
function showLogin(){
  authContainer.innerHTML=`
    <input type="email" id="email" class="form-control mb-2" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ">
    <input type="password" id="password" class="form-control mb-2" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±">
    <button class="btn btn-main w-100 mb-2" onclick="login()">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button>
    <button class="btn btn-outline-primary w-100 mb-2" onclick="signupStep1()">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</button>
    <button class="btn btn-outline-secondary w-100" onclick="googleLogin()">ØªØ³Ø¬ÙŠÙ„ Ø¨Ù€ Google</button>
  `;
}
function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert(err.message));
}
function signupStep1(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,password).then(cred=>{
    db.collection('users').doc(cred.user.uid).set({
      categories:{}, dailyExpenses:[], salary:0, incomeSources:0, loans:0, lastSalaryDate:null
    });
  }).catch(err=>alert(err.message));
}
function googleLogin(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}
function logout(){ auth.signOut(); }

// ===== Bottom Navigation =====
document.querySelectorAll('.bottom-nav div[data-tab]').forEach(btn=>{
  btn.addEventListener('click',()=>{
    document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
    document.getElementById(btn.dataset.tab).style.display='block';
    document.querySelectorAll('.bottom-nav div').forEach(d=>d.classList.remove('active'));
    btn.classList.add('active');
  });
});

// ===== Load User Data =====
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display='none';
    app.style.display='block';
    welcomeUser.textContent=`Ø£Ù‡Ù„Ø§Ù‹ØŒ ${user.email} ğŸ‘‹`;
    loadUserData(user.uid);
  } else{
    authContainer.style.display='block';
    app.style.display='none';
    showLogin();
  }
});

// ===== Load & Render Data =====
async function loadUserData(uid){
  const docSnap = await db.collection('users').doc(uid).get();
  if(!docSnap.exists){ alert("Ø®Ø·Ø£: Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©"); return; }
  const data=docSnap.data();

  if(!data.salary || Object.keys(data.categories).length===0){
    renderInitialSetup(uid, data);
    return;
  }
  renderDailyTab(data, uid);
  renderWeeklyTab(data, uid);
  renderAccountTab(data, uid);
  document.querySelector('.bottom-nav div[data-tab="dailyTab"]').click();
}

// ===== Initial Setup =====
function renderInitialSetup(uid, data){
  const container=document.getElementById('dailyTab');
  container.style.display='block';
  container.innerHTML=`
    <div class="card card-royal mx-auto" style="max-width:500px;">
      <h5>Ø§Ù„Ø®Ø·ÙˆØ© 1: Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø§ØªØ¨ ÙˆØ§Ù„Ø¯Ø®Ù„</h5>
      <input type="number" id="salaryInput" class="form-control mb-2" placeholder="Ø±Ø§ØªØ¨Ùƒ Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ" value="${data.salary||''}">
      <input type="number" id="incomeInput" class="form-control mb-2" placeholder="Ù…ØµØ§Ø¯Ø± Ø¯Ø®Ù„ Ø£Ø®Ø±Ù‰" value="${data.incomeSources||''}">
      <input type="number" id="loansInput" class="form-control mb-2" placeholder="Ø£ÙŠ Ù‚Ø±ÙˆØ¶ Ø£Ùˆ Ø§Ù„ØªØ²Ø§Ù…Ø§Øª" value="${data.loans||''}">
      <h5 class="mt-3">Ø§Ù„Ø®Ø·ÙˆØ© 2: Ø§Ù„Ø£Ù‚Ø³Ø§Ù… ÙˆØ§Ù„Ù…Ø¨Ø§Ù„Øº</h5>
      <div id="userCategoriesContainer"></div>
      <button id="addCategoryBtn" class="btn btn-outline-primary mb-2 w-100">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
      <button id="saveSetupBtn" class="btn btn-main mt-2 w-100">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>
  `;
  const userCategoriesContainer=document.getElementById('userCategoriesContainer');
  function addCategoryRow(name="",alloc=""){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2";
    div.innerHTML=`<input type="text" class="form-control category-name-input" placeholder="Ø§Ø³Ù… Ø§Ù„Ù‚Ø³Ù…" value="${name}">
      <input type="number" class="form-control category-alloc-input" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº" value="${alloc}">`;
    userCategoriesContainer.appendChild(div);
  }
  for(let i=0;i<3;i++) addCategoryRow();
  document.getElementById('addCategoryBtn').onclick=()=> addCategoryRow();
  document.getElementById('saveSetupBtn').onclick=async ()=>{
    const salary=parseFloat(document.getElementById('salaryInput').value)||0;
    const income=parseFloat(document.getElementById('incomeInput').value)||0;
    const loans=parseFloat(document.getElementById('loansInput').value)||0;
    const nameInputs=document.getElementsByClassName('category-name-input');
    const allocInputs=document.getElementsByClassName('category-alloc-input');
    let categoriesObj={};
    for(let i=0;i<nameInputs.length;i++){
      const name=nameInputs[i].value.trim();
      const alloc=parseFloat(allocInputs[i].value)||0;
      if(name) categoriesObj[name]=alloc;
    }
    if(Object.keys(categoriesObj).length===0){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ù‚Ø³Ù… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„"); return; }
    await db.collection('users').doc(uid).update({
      salary:salary,
      incomeSources:income,
      loans:loans,
      categories:categoriesObj,
      dailyExpenses:[],
      lastSalaryDate:null
    });
    loadUserData(uid);
  };
}

// ===== Daily Tab =====
function renderDailyTab(data, uid){
  const container=document.getElementById('dailyTab');
  container.style.display='block';
  container.innerHTML=`
    <h5 class="mb-3 text-center">ğŸ·ï¸ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„ÙŠÙˆÙ…ÙŠØ©</h5>
    <label>Ø§Ø®ØªØ± Ø§Ù„ØªØ§Ø±ÙŠØ®:</label>
    <input type="date" id="expenseDate" class="form-control mb-3" value="${new Date().toISOString().split('T')[0]}">
    <div class="mb-3">
      <label>Ø§Ø®ØªØ± Ø§Ù„Ù‚Ø³Ù…:</label>
      <select id="expenseCategory" class="form-select mb-2">
        ${Object.keys(data.categories).map(cat=>`<option value="${cat}">${cat}</option>`).join('')}
      </select>
      <input type="number" id="expenseAmount" class="form-control mb-2" placeholder="Ø§Ù„Ù…Ø¨Ù„Øº">
      <input type="text" id="expenseDesc" class="form-control mb-2" placeholder="Ù„ÙÙ…Ø§Ø°Ø§ ØªÙ… Ø§Ù„ØµØ±ÙØŸ">
      <button id="addExpenseBtn" class="btn btn-main w-100">Ø­ÙØ¸ Ø§Ù„Ù…ØµØ±ÙˆÙ</button>
    </div>
    <h6 class="mt-3">Ø§Ù„Ù…ØµØ§Ø±ÙŠÙ Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:</h6>
    <div id="dailyExpensesList"></div>
  `;

  const listDiv=document.getElementById('dailyExpensesList');

  function refreshList(){
    listDiv.innerHTML='';
    data.dailyExpenses.forEach((exp)=>{
      const row=document.createElement('div');
      row.className='card card-royal mb-2';
      row.innerHTML=`<strong>${exp.date}</strong> - ${exp.cat}: ${exp.amount} Ø±ÙŠØ§Ù„ (Ø³Ø¨Ø¨: ${exp.desc})`;
      listDiv.appendChild(row);
    });
  }

  document.getElementById('addExpenseBtn').onclick=async ()=>{
    const date=document.getElementById('expenseDate').value;
    const cat=document.getElementById('expenseCategory').value;
    const amount=parseFloat(document.getElementById('expenseAmount').value)||0;
    const desc=document.getElementById('expenseDesc').value.trim();
    if(amount<=0 || !desc){ alert("Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ù…Ø¨Ù„Øº ÙˆØ§Ù„Ø³Ø¨Ø¨"); return; }
    data.dailyExpenses.push({date,cat,amount,desc});
    await db.collection('users').doc(uid).update({dailyExpenses:data.dailyExpenses});
    document.getElementById('expenseAmount').value='';
    document.getElementById('expenseDesc').value='';
    refreshList();
  };

  refreshList();
}

// ===== Weekly Tab =====
function renderWeeklyTab(data){
  const container=document.getElementById('weeklyTab');
  container.style.display='block';
  container.innerHTML=`
    <h5 class="mb-3">Ø§Ù„ØªØ­Ù„ÙŠÙ„Ø§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©</h5>
    <div id="weeklyContainer"></div>
    <div class="mt-3"><strong>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØµØ±ÙˆÙØ§Øª Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠØ©: </strong><span id="totalWeekly">0</span> Ø±ÙŠØ§Ù„</div>
  `;
  const weeklyContainer=document.getElementById('weeklyContainer');
  const today=new Date();
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date();
    d.setDate(today.getDate()-i);
    days.push(d.toISOString().split('T')[0]);
  }

  let totalAll=0;
  for(const day of days){
    const dayDiv=document.createElement('div');
    dayDiv.className="card card-royal mb-2";
    dayDiv.innerHTML=`<h6>${day}</h6>`;
    const dayExpenses=data.dailyExpenses.filter(e=>e.date===day);
    if(dayExpenses.length===0){ dayDiv.innerHTML+="<div>Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…ØµØ±ÙˆÙØ§Øª</div>"; weeklyContainer.appendChild(dayDiv); continue; }
    dayExpenses.forEach((e,i)=>{
      const spent=data.dailyExpenses.filter(x=>x.cat===e.cat).reduce((sum,x)=>sum+x.amount,0);
      const categoryTotal=data.categories[e.cat];
      const remaining=categoryTotal-spent;
      totalAll+=e.amount;
      const div=document.createElement('div');
      div.className="expense-entry";
      div.innerHTML=`
        <div style="flex:2">${e.cat} â€” ${e.desc}</div>
        <div style="flex:1">${e.amount} Ø±ÙŠØ§Ù„</div>
        <div style="flex:1">Ø¨Ø§Ù‚ÙŠ: ${remaining} Ø±ÙŠØ§Ù„</div>
        <div class="expense-actions">
          <button class="btn btn-outline-danger btn-sm" onclick="deleteExpense('${e.date}','${e.cat}',${i})">Ø­Ø°Ù</button>
        </div>
      `;
      dayDiv.appendChild(div);
    });
    weeklyContainer.appendChild(dayDiv);
  }
  document.getElementById('totalWeekly').textContent=totalAll.toFixed(2);
}

// ===== Delete Only =====
async function deleteExpense(date, cat, index) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…ØµØ±ÙˆÙØŸ")) return;

  const uid = auth.currentUser.uid;
  const docSnap = await db.collection('users').doc(uid).get();
  const data = docSnap.data();

  // Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ±ÙˆÙ ÙÙŠ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
  const expensesInCatDate = data.dailyExpenses.filter(x => x.date === date && x.cat === cat);
  const expenseToDelete = expensesInCatDate[index];

  if (!expenseToDelete) {
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ");
    return;
  }

  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ø¯Ø§Ø®Ù„ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ø£ØµÙ„ÙŠØ©
  const realIndex = data.dailyExpenses.findIndex(
    x =>
      x.date === expenseToDelete.date &&
      x.cat === expenseToDelete.cat &&
      x.amount === expenseToDelete.amount &&
      x.desc === expenseToDelete.desc
  );

  if (realIndex !== -1) {
    // Ø­Ø°Ù Ø§Ù„Ø¹Ù†ØµØ± Ù…Ù† Ø§Ù„Ù…ØµÙÙˆÙØ©
    data.dailyExpenses.splice(realIndex, 1);
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase
    await db.collection('users').doc(uid).update({ dailyExpenses: data.dailyExpenses });
    alert("ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…ØµØ±ÙˆÙ Ø¨Ù†Ø¬Ø§Ø­");
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    loadUserData(uid);
  } else {
    alert("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…ØµØ±ÙˆÙ Ù„Ø­Ø°ÙÙ‡");
  }
}



// ===== Account Tab =====
function renderAccountTab(data, uid){
  const container=document.getElementById('accountTab');
  container.style.display='block';
  container.innerHTML=`
    <div class="card card-royal">
      <h5>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ</h5>
      <input type="number" id="salaryEdit" class="form-control mb-2" value="${data.salary}" placeholder="Ø±Ø§ØªØ¨Ùƒ">
      <input type="number" id="loansEdit" class="form-control mb-2" value="${data.loans}" placeholder="Ù‚Ø±ÙˆØ¶Ùƒ">
      <h6>Ø§Ù„Ø£Ù‚Ø³Ø§Ù…</h6>
      <div id="editCategoriesContainer"></div>
      <button id="addEditCategoryBtn" class="btn btn-outline-primary mb-2 w-100">Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù…</button>
      <button id="saveAccountBtn" class="btn btn-main w-100">Ø­ÙØ¸ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„Ø§Øª</button>
    </div>
  `;
  const editContainer=document.getElementById('editCategoriesContainer');
  function addEditRow(name="",alloc=""){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2";
    div.innerHTML=`<input type="text" class="form-control category-name-input" value="${name}">
      <input type="number" class="form-control category-alloc-input" value="${alloc}">`;
    editContainer.appendChild(div);
  }
  for(const cat in data.categories) addEditRow(cat,data.categories[cat]);
  document.getElementById('addEditCategoryBtn').onclick=()=> addEditRow();
  document.getElementById('saveAccountBtn').onclick=async ()=>{
    const salary=parseFloat(document.getElementById('salaryEdit').value)||0;
    const loans=parseFloat(document.getElementById('loansEdit').value)||0;
    const names=document.getElementsByClassName('category-name-input');
    const allocs=document.getElementsByClassName('category-alloc-input');
    const categories={};
    for(let i=0;i<names.length;i++){
      const name=names[i].value.trim();
      const alloc=parseFloat(allocs[i].value)||0;
      if(name) categories[name]=alloc;
    }
    await db.collection('users').doc(uid).update({salary,loans,categories});
    alert("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª!");
    loadUserData(uid);
  };
}
</script>

</body>
</html>








