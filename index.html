<!doctype html>
<html lang="ar" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>راتبي الذكي — Dashboard</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
:root{
  --main-blue:#3b6bff;
  --light-gray:#f5f5f5;
  --card-shadow:0 6px 18px rgba(0,0,128,0.1);
  --accent-text:#2c003e;
}
body{
  background: var(--light-gray);
  color: var(--accent-text);
  font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  margin:0;
}
.sidebar{
  width:220px; background:#ffffff; position:fixed; top:0; bottom:0; left:0;
  border-right:1px solid #ddd; padding-top:20px; transition:0.3s;
}
.sidebar a{ display:block; padding:12px 20px; color:#333; text-decoration:none; margin-bottom:2px; border-radius:6px;}
.sidebar a:hover, .sidebar a.active{ background:var(--main-blue); color:#fff;}
.content{margin-left:220px; padding:20px;}
.card-royal{ background:#fff; border:none; box-shadow:var(--card-shadow); border-radius:12px; padding:15px; margin-bottom:20px;}
.btn-main{ background:var(--main-blue); color:#fff; border:none;}
.btn-main:hover{ background:#5a82ff;}
.form-control:focus{ box-shadow:none; border-color:var(--main-blue);}
input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0;}
@media(max-width:768px){.sidebar{left:-220px;} .sidebar.show{left:0;} .content{margin-left:0;}}
</style>
</head>
<body>

<div class="sidebar" id="sidebar">
  <a href="#" class="active" data-tab="daily">🏷️ المصاريف اليومية</a>
  <a href="#" data-tab="weekly">📊 التحليلات الأسبوعية</a>
  <a href="#" data-tab="predictions">🔮 التوقعات</a>
  <a href="#" data-tab="account">⚙️ حسابك</a>
  <a href="#" onclick="logout()">🚪 تسجيل الخروج</a>
</div>

<div class="content">
  <button class="btn btn-main mb-3 d-md-none" onclick="toggleSidebar()">☰ القائمة</button>
  <div id="authContainer"></div>
  <div id="app" style="display:none;">
    <div id="dailyTab" class="tabContent"></div>
    <div id="weeklyTab" class="tabContent" style="display:none;"></div>
    <div id="predictionsTab" class="tabContent" style="display:none;"></div>
    <div id="accountTab" class="tabContent" style="display:none;"></div>
  </div>
</div>

<script>
const firebaseConfig = {
  apiKey:"AIzaSyB-1kkLnKv51PmEmwOIk3gqsigTJOU3Cgw",
  authDomain:"budget-salary.firebaseapp.com",
  projectId:"budget-salary",
  storageBucket:"budget-salary.firebasestorage.app",
  messagingSenderId:"833349662009",
  appId:"1:833349662009:web:2fb64df1fe71a801a0a4e8",
};
firebase.initializeApp(firebaseConfig);
const auth=firebase.auth();
const db=firebase.firestore();

const authContainer=document.getElementById('authContainer');
const app=document.getElementById('app');

function toggleSidebar(){
  document.getElementById('sidebar').classList.toggle('show');
}

// ===== Login / Signup =====
function showLogin(){
  authContainer.innerHTML=`
    <input type="email" id="email" class="form-control mb-2" placeholder="البريد الإلكتروني">
    <input type="password" id="password" class="form-control mb-2" placeholder="كلمة المرور">
    <button class="btn btn-main w-100 mb-2" onclick="login()">تسجيل الدخول</button>
    <button class="btn btn-outline-primary w-100 mb-2" onclick="signupStep1()">إنشاء حساب</button>
    <button class="btn btn-outline-secondary w-100" onclick="googleLogin()">تسجيل بـ Google</button>
  `;
}

function login(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.signInWithEmailAndPassword(email,password).catch(err=>alert(err.message));
}

function signupStep1(){
  const email=document.getElementById('email').value;
  const password=document.getElementById('password').value;
  auth.createUserWithEmailAndPassword(email,password).then(cred=>{
    db.collection('users').doc(cred.user.uid).set({
      categories:{}, dailyExpenses:[], salary:0, incomeSources:0, loans:0, lastSalaryDate:null
    });
  }).catch(err=>alert(err.message));
}

function googleLogin(){
  const provider=new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider);
}

function logout(){ auth.signOut(); }

// ===== Tab Navigation =====
document.querySelectorAll('.sidebar a[data-tab]').forEach(a=>{
  a.addEventListener('click', e=>{
    e.preventDefault();
    document.querySelectorAll('.sidebar a').forEach(x=>x.classList.remove('active'));
    a.classList.add('active');
    const tab=a.dataset.tab;
    document.querySelectorAll('.tabContent').forEach(tc=>tc.style.display='none');
    document.getElementById(tab+'Tab').style.display='block';
  });
});

// ===== Load User Data =====
auth.onAuthStateChanged(user=>{
  if(user){
    authContainer.style.display='none';
    app.style.display='block';
    loadUserData(user.uid);
  } else{
    authContainer.style.display='block';
    app.style.display='none';
    showLogin();
  }
});

async function loadUserData(uid){
  const docSnap = await db.collection('users').doc(uid).get();
  if(!docSnap.exists){ alert("خطأ: البيانات غير موجودة"); return; }
  const data=docSnap.data();

  // إذا لم يدخل بياناته الأولية
  if(!data.salary || Object.keys(data.categories).length===0){
    renderInitialSetup(uid, data);
    return;
  }

  renderDailyTab(data, uid);
  renderWeeklyTab(data);
  renderPredictionsTab(data);
  renderAccountTab(data, uid);
}

// ===== Initial Setup =====
function renderInitialSetup(uid, data){
  const container=document.getElementById('dailyTab');
  container.innerHTML=`
    <div class="card card-royal mx-auto" style="max-width:500px;">
      <h5>الخطوة 1: بيانات الراتب والدخل</h5>
      <input type="number" id="salaryInput" class="form-control mb-2" placeholder="راتبك الأساسي" value="${data.salary||''}">
      <input type="number" id="incomeInput" class="form-control mb-2" placeholder="مصادر دخل أخرى (اختياري)" value="${data.incomeSources||''}">
      <input type="number" id="loansInput" class="form-control mb-2" placeholder="أي قروض أو التزامات" value="${data.loans||''}">
      <h5 class="mt-3">الخطوة 2: الأقسام والمبالغ</h5>
      <div id="userCategoriesContainer"></div>
      <button id="addCategoryBtn" class="btn btn-outline-primary mb-2 w-100">إضافة قسم</button>
      <button id="saveSetupBtn" class="btn btn-main mt-2 w-100">حفظ البيانات</button>
    </div>
  `;
  const userCategoriesContainer=document.getElementById('userCategoriesContainer');
  function addCategoryRow(name="",alloc=""){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2";
    div.innerHTML=`<input type="text" class="form-control category-name-input" placeholder="اسم القسم" value="${name}">
      <input type="number" class="form-control category-alloc-input" placeholder="المبلغ" value="${alloc}">`;
    userCategoriesContainer.appendChild(div);
  }
  for(let i=0;i<3;i++) addCategoryRow();
  document.getElementById('addCategoryBtn').onclick=()=> addCategoryRow();
  document.getElementById('saveSetupBtn').onclick=async ()=>{
    const salary=parseFloat(document.getElementById('salaryInput').value)||0;
    const income=parseFloat(document.getElementById('incomeInput').value)||0;
    const loans=parseFloat(document.getElementById('loansInput').value)||0;
    const nameInputs=document.getElementsByClassName('category-name-input');
    const allocInputs=document.getElementsByClassName('category-alloc-input');
    let categoriesObj={};
    for(let i=0;i<nameInputs.length;i++){
      const name=nameInputs[i].value.trim();
      const alloc=parseFloat(allocInputs[i].value)||0;
      if(name) categoriesObj[name]=alloc;
    }
    if(Object.keys(categoriesObj).length===0){ alert("الرجاء إدخال قسم واحد على الأقل"); return; }
    await db.collection('users').doc(uid).update({
      salary:salary,
      incomeSources:income,
      loans:loans,
      categories:categoriesObj,
      dailyExpenses:[],
      lastSalaryDate:null
    });
    loadUserData(uid);
  };
}

// ===== Tabs =====
function renderDailyTab(data, uid){
  const container=document.getElementById('dailyTab');
  container.innerHTML=`
    <div class="card card-royal">
      <h5>المصاريف اليومية</h5>
      <label>اختر التاريخ:</label>
      <input type="date" id="expenseDate" class="form-control mb-2" value="${new Date().toISOString().split('T')[0]}">
      <div id="expenseInputs"></div>
      <button id="addExpenseBtn" class="btn btn-outline-primary mb-2">حفظ المصروفات</button>
      <button id="newCycleBtn" class="btn btn-main mb-2">ابدئي دورة راتب جديدة</button>
    </div>
  `;
  const expenseInputs=document.getElementById('expenseInputs');
  for(const cat in data.categories){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2";
    div.innerHTML=`<span class="category-name w-50">${cat}</span>
      <input type="number" class="form-control w-50 expense-input" placeholder="المصروف" data-cat="${cat}" data-limit="${data.categories[cat]}">`;
    expenseInputs.appendChild(div);
  }
  document.getElementById('addExpenseBtn').onclick=async ()=>{
    const date=document.getElementById('expenseDate').value;
    const newExpenses={};
    Array.from(document.getElementsByClassName('expense-input')).forEach(inp=>{
      const cat=inp.dataset.cat;
      const val=parseFloat(inp.value)||0;
      newExpenses[cat]=val;
    });
    data.dailyExpenses.push({date,expenses:newExpenses});
    await db.collection('users').doc(uid).update({dailyExpenses:data.dailyExpenses});
    alert("تم حفظ المصروفات!");
  };
  document.getElementById('newCycleBtn').onclick=async ()=>{
    if(confirm("هل تريد بدء دورة راتب جديدة؟ سيتم حذف المصروفات السابقة.")){
      await db.collection('users').doc(uid).update({dailyExpenses:[], lastSalaryDate:new Date().toISOString().split('T')[0]});
      loadUserData(uid);
    }
  };
}

// ===== Weekly Tab =====
function renderWeeklyTab(data){
  const container=document.getElementById('weeklyTab');
  container.innerHTML=`
    <div class="card card-royal">
      <h5>التحليلات الأسبوعية</h5>
      <div id="weeklyTable"></div>
    </div>
  `;
  const table=document.createElement('table');
  table.className="table table-bordered";
  let html=`<tr><th>القسم</th>`;
  // الأيام من آخر 7 أيام
  const days=[];
  for(let i=6;i>=0;i--){
    const d=new Date();
    d.setDate(d.getDate()-i);
    days.push(d.toISOString().split('T')[0]);
    html+=`<th>${d.getDate()}/${d.getMonth()+1}</th>`;
  }
  html+=`</tr>`;
  for(const cat in data.categories){
    html+=`<tr><td>${cat}</td>`;
    for(const day of days){
      const dayData=data.dailyExpenses.find(d=>d.date===day);
      html+=`<td>${dayData?dayData.expenses[cat]||0:0}</td>`;
    }
    html+=`</tr>`;
  }
  table.innerHTML=html;
  document.getElementById('weeklyTable').appendChild(table);
}

// ===== Predictions Tab =====
function renderPredictionsTab(data){
  const container=document.getElementById('predictionsTab');
  container.innerHTML=`
    <div class="card card-royal">
      <h5>التوقعات لبقية الشهر</h5>
      <div id="predictionsContainer"></div>
    </div>
  `;
  const pc=document.getElementById('predictionsContainer');
  const today=new Date().getDate();
  const daysInMonth=new Date(new Date().getFullYear(),new Date().getMonth()+1,0).getDate();
  for(const cat in data.categories){
    const spent=data.dailyExpenses.reduce((sum,d)=>sum+(d.expenses[cat]||0),0);
    const remaining=data.categories[cat]-spent;
    const dailyPrediction=remaining/(daysInMonth-today);
    pc.innerHTML+=`<div>${cat}: ${dailyPrediction.toFixed(2)} ريال يومياً متوقع</div>`;
  }
}

// ===== Account Tab =====
function renderAccountTab(data, uid){
  const container=document.getElementById('accountTab');
  container.innerHTML=`
    <div class="card card-royal">
      <h5>تعديل بياناتك</h5>
      <input type="number" id="salaryEdit" class="form-control mb-2" value="${data.salary}" placeholder="راتبك">
      <input type="number" id="loansEdit" class="form-control mb-2" value="${data.loans}" placeholder="قروضك">
      <h6>الأقسام</h6>
      <div id="editCategoriesContainer"></div>
      <button id="addEditCategoryBtn" class="btn btn-outline-primary mb-2 w-100">إضافة قسم</button>
      <button id="saveAccountBtn" class="btn btn-main w-100">حفظ التعديلات</button>
    </div>
  `;
  const editContainer=document.getElementById('editCategoriesContainer');
  function addEditRow(name="",alloc=""){
    const div=document.createElement('div');
    div.className="d-flex gap-2 mb-2";
    div.innerHTML=`<input type="text" class="form-control category-name-input" value="${name}">
      <input type="number" class="form-control category-alloc-input" value="${alloc}">`;
    editContainer.appendChild(div);
  }
  for(const cat in data.categories) addEditRow(cat,data.categories[cat]);
  document.getElementById('addEditCategoryBtn').onclick=()=> addEditRow();
  document.getElementById('saveAccountBtn').onclick=async ()=>{
    const salary=parseFloat(document.getElementById('salaryEdit').value)||0;
    const loans=parseFloat(document.getElementById('loansEdit').value)||0;
    const names=document.getElementsByClassName('category-name-input');
    const allocs=document.getElementsByClassName('category-alloc-input');
    const categories={};
    for(let i=0;i<names.length;i++){
      const name=names[i].value.trim();
      const alloc=parseFloat(allocs[i].value)||0;
      if(name) categories[name]=alloc;
    }
    await db.collection('users').doc(uid).update({salary,loans,categories});
    alert("تم تحديث البيانات!");
    loadUserData(uid);
  };
}
</script>
</body>
</html>
