<!doctype html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>راتبي الذكي — Budget Planner</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Chart.js -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

  <style>
    :root{
      --royal-blue:#1a237e;
      --light-blue:#3f51b5;
      --card-shadow:0 6px 18px rgba(26,35,126,0.15);
      --text-main:#1a237e;
    }
    body{font-family:"Segoe UI",sans-serif;background:#f5f5f5;color:var(--text-main);}
    .rounded-card{border-radius:12px;box-shadow:var(--card-shadow);}
    .btn-primary{background:var(--royal-blue);border:none;}
    .btn-primary:hover{background:var(--light-blue);}
    .stat-card{border-radius:12px;padding:12px;background:white;}
    .category-name{font-weight:700;font-size:0.95rem;}
    .small-muted{color:#666;font-size:0.85rem;}
    canvas{max-height:200px;}
    .text-success{color:#2e7d32!important;}
    .text-warning{color:#f9a825!important;}
    .text-danger{color:#c62828!important;}
  </style>
</head>
<body>

<div class="container py-4">

  <!-- ===== شاشة تسجيل الدخول / اختيار الأقسام ===== -->
  <div id="loginScreen" class="mb-4">
    <div class="card p-4 rounded-card text-center">
      <h4 class="mb-3">مرحبًا في راتبي الذكي</h4>
      <div class="mb-3">
        <label class="form-label">اسمك:</label>
        <input type="text" id="userName" class="form-control" placeholder="أدخلي اسمك">
      </div>
      <div class="mb-3">
        <label class="form-label">اختاري الأقسام التي تريدين تتبعها:</label>
        <div id="categoryCheckboxes" class="d-flex flex-wrap gap-2"></div>
      </div>
      <button id="startBtn" class="btn btn-primary w-50">ابدأي</button>
    </div>
  </div>

  <!-- ===== الصفحة الرئيسية ===== -->
  <div id="mainScreen" style="display:none;">
    <header class="d-flex justify-content-between align-items-center mb-3">
      <h4>راتبي الذكي</h4>
      <div class="text-end">
        <div class="mb-1">مرحبًا، <span id="displayUser"></span></div>
        <button id="logoutBtn" class="btn btn-outline-secondary btn-sm">تسجيل الخروج</button>
      </div>
    </header>

    <!-- الراتب وبطاقات الأقسام -->
    <div class="row g-3 mb-3">
      <div class="col-md-12">
        <div class="card p-3 rounded-card mb-3">
          <div class="d-flex justify-content-between align-items-center">
            <div>
              <div class="small-muted">الراتب الحالي</div>
              <div class="fs-5 fw-bold" id="salaryDisplay">0 ر.ع</div>
            </div>
            <div class="text-end">
              <div class="small-muted">المتبقي الكلي</div>
              <div class="fs-5 fw-bold text-success" id="totalRemaining">0 ر.ع</div>
            </div>
          </div>
          <div class="mt-3" id="cardsRow" class="row g-2"></div>
        </div>
      </div>
    </div>

    <!-- إضافة مصروف -->
    <div class="row g-3 mb-3">
      <div class="col-lg-6">
        <div class="card p-3 rounded-card">
          <h6 class="mb-3">أضيفي مصروف</h6>
          <form id="expenseForm" class="row gx-2 gy-2 align-items-end">
            <div class="col-6">
              <label class="form-label small-muted">الفئة</label>
              <select id="expCategory" class="form-select"></select>
            </div>
            <div class="col-6">
              <label class="form-label small-muted">المبلغ (ر.ع)</label>
              <input id="expAmount" type="number" class="form-control" min="0" step="0.1" required>
            </div>
            <div class="col-6">
              <label class="form-label small-muted">اليوم</label>
              <input id="expDay" type="number" class="form-control" min="1" max="31" value="1" required>
            </div>
            <div class="col-6">
              <label class="form-label small-muted">ملاحظة</label>
              <input id="expNote" type="text" class="form-control" placeholder="مثلاً: غداء">
            </div>
            <div class="col-12">
              <button class="btn btn-primary w-100" type="submit">أضف المصروف</button>
            </div>
          </form>
        </div>
      </div>

      <!-- الشارتات -->
      <div class="col-lg-6">
        <div class="card p-3 rounded-card mb-3">
          <h6>توزيع الأقسام</h6>
          <canvas id="pieChart"></canvas>
        </div>
        <div class="card p-3 rounded-card mb-3">
          <h6>تراكم المدخرات</h6>
          <canvas id="savingsChart"></canvas>
        </div>
        <div class="card p-3 rounded-card">
          <h6>مصروفات كل يوم</h6>
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- سجل المعاملات -->
    <div class="card p-3 rounded-card mb-3">
      <h6 class="mb-2">سجل المعاملات</h6>
      <div style="max-height:250px; overflow:auto;">
        <table class="table table-sm">
          <thead>
            <tr><th>الفئة</th><th>المبلغ</th><th>اليوم</th><th>ملاحظة</th><th></th></tr>
          </thead>
          <tbody id="txTable"></tbody>
        </table>
      </div>
    </div>

    <!-- النسخ الاحتياطي / الاستيراد -->
    <div class="mb-4 d-flex gap-2">
      <button id="exportBtn" class="btn btn-outline-secondary">Backup</button>
      <input id="importFile" type="file" accept="application/json" style="display:none">
      <button id="importBtn" class="btn btn-outline-secondary">استيراد</button>
    </div>
  </div>
</div>

<script>
let CATEGORIES=[
  {id:'savings', name:'ادخار', alloc:1000, type:'savings'},
  {id:'petrol', name:'بترول', alloc:300, type:'daily'},
  {id:'investment', name:'استثمار', alloc:500, type:'investment'},
  {id:'insurance', name:'تأمين وتجديد السيارة', alloc:400, type:'fixed'},
  {id:'emergency', name:'طواري', alloc:200, type:'daily'},
  {id:'zakat', name:'زكاة', alloc:150, type:'fixed'},
  {id:'entertainment', name:'ترفيه', alloc:250, type:'daily'},
  {id:'food', name:'اكل', alloc:600, type:'daily'}
];

const STORAGE_KEY='ruq_budget_v2';
let store={user:'',categories:[],transactions:[]};
let pieChart,savingsChart,dailyChart;

const loginScreen=document.getElementById('loginScreen');
const mainScreen=document.getElementById('mainScreen');
const startBtn=document.getElementById('startBtn');
const userName=document.getElementById('userName');
const categoryCheckboxes=document.getElementById('categoryCheckboxes');
const displayUser=document.getElementById('displayUser');
const expCategory=document.getElementById('expCategory');
const expDay=document.getElementById('expDay');
const expForm=document.getElementById('expenseForm');
const expAmount=document.getElementById('expAmount');
const expNote=document.getElementById('expNote');
const cardsRow=document.getElementById('cardsRow');
const txTable=document.getElementById('txTable');
const salaryDisplay=document.getElementById('salaryDisplay');
const totalRemainingEl=document.getElementById('totalRemaining');
const exportBtn=document.getElementById('exportBtn');
const importBtn=document.getElementById('importBtn');
const importFile=document.getElementById('importFile');
const logoutBtn=document.getElementById('logoutBtn');

function renderLogin(){
  categoryCheckboxes.innerHTML = CATEGORIES.map(c=>`<div class="form-check">
      <input class="form-check-input" type="checkbox" value="${c.id}" id="chk_${c.id}">
      <label class="form-check-label" for="chk_${c.id}">${c.name}</label>
    </div>`).join('');
}

startBtn.addEventListener('click',()=>{
  const name=userName.value.trim();
  if(!name){alert('أدخلي اسمك');return;}
  const selected=[];
  CATEGORIES.forEach(c=>{
    const chk=document.getElementById('chk_'+c.id);
    if(chk.checked) selected.push({...c});
  });
  if(selected.length===0){alert('اختاري على الأقل قسم واحد');return;}
  store.user=name;
  store.categories=selected;
  store.transactions=[];
  saveStore();
  displayUser.textContent=name;
  loginScreen.style.display='none';
  mainScreen.style.display='block';
  renderCards();
  renderTransactions();
  renderCharts();
  populateCategorySelect();
});

logoutBtn.addEventListener('click',()=>{
  if(!confirm('هل تريد تسجيل الخروج؟')) return;
  localStorage.removeItem(STORAGE_KEY);
  location.reload();
});

function saveStore(){localStorage.setItem(STORAGE_KEY,JSON.stringify(store));}
function loadStore(){const raw=localStorage.getItem(STORAGE_KEY);return raw?JSON.parse(raw):null;}
window.addEventListener('load',()=>{
  const saved=loadStore();
  if(saved && saved.user){
    store=saved;
    loginScreen.style.display='none';
    mainScreen.style.display='block';
    displayUser.textContent=store.user;
    renderCards();
    renderTransactions();
    renderCharts();
    populateCategorySelect();
  } else renderLogin();
});

function renderCards(){
  cardsRow.innerHTML='';
  store.categories.forEach(c=>{
    const spent=store.transactions.filter(t=>t.category===c.id).reduce((a,b)=>a+b.amount,0);
    const remaining=c.alloc-spent;
    let color='text-success';
    if(remaining<=c.alloc*0.2 && remaining>0) color='text-warning';
    if(remaining<=0) color='text-danger';
    const card=document.createElement('div');
    card.className='col-md-3 mb-2';
    card.innerHTML=`<div class="stat-card">
      <div class="d-flex justify-content-between">
        <div class="category-name">${c.name}</div>
        <div class="${color} fw-bold">${remaining.toFixed(2)} ر.ع</div>
      </div>
      <div class="small-muted">المخصص: ${c.alloc} ر.ع | مصروف: ${spent.toFixed(2)} ر.ع</div>
    </div>`;
    cardsRow.appendChild(card);
  });
  updateTotalRemaining();
}
function updateTotalRemaining(){
  const total=store.categories.reduce((sum,c)=>{
    const spent=store.transactions.filter(t=>t.category===c.id).reduce((a,b)=>a+b.amount,0);
    return sum+(c.alloc-spent);
  },0);
  totalRemainingEl.textContent=total.toFixed(2)+' ر.ع';
}

function populateCategorySelect(){
  expCategory.innerHTML=store.categories.map(c=>`<option value="${c.id}">${c.name}</option>`).join('');
}

expForm.addEventListener('submit',e=>{
  e.preventDefault();
  const cat=expCategory.value;
  const amt=parseFloat(expAmount.value);
  const day=parseInt(expDay.value,10);
  const note=expNote.value;
  if(isNaN(amt)||amt<=0){alert('أدخلي مبلغ صالح');return;}
  if(isNaN(day)||day<1||day>31){alert('أدخلي يوم صالح');return;}
  store.transactions.push({category:cat,amount:amt,note:note||'',day:day});
  saveStore();
  expForm.reset();
  renderCards();
  renderTransactions();
  renderCharts();
});

function renderTransactions(){
  txTable.innerHTML='';
  if(store.transactions.length===0){txTable.innerHTML='<tr><td colspan="5" class="text-center small-muted">لا توجد معاملات</td></tr>';return;}
  store.transactions.slice().reverse().forEach((t,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${categoryName(t.category)}</td><td>${t.amount.toFixed(2)} ر.ع</td><td>${t.day}</td><td>${t.note}</td><td><button class="btn btn-sm btn-outline-danger delTx" data-idx="${store.transactions.length-1-idx}">حذف</button></td>`;
    txTable.appendChild(tr);
  });
}
txTable.addEventListener('click',e=>{
  if(e.target.classList.contains('delTx')){
    const idx=parseInt(e.target.dataset.idx,10);
    if(!confirm('هل تريد حذف المعاملة؟')) return;
    store.transactions.splice(idx,1);
    saveStore();
    renderCards();
    renderTransactions();
    renderCharts();
  }
});
function categoryName(id){const c=store.categories.find(x=>x.id===id);return c?c.name:id;}

function renderCharts(){
  const pieCtx=document.getElementById('pieChart').getContext('2d');
  if(pieChart) pieChart.destroy();
  pieChart=new Chart(pieCtx,{type:'pie',data:{labels:store.categories.map(c=>c.name),datasets:[{data:store.categories.map(c=>c.alloc - store.transactions.filter(t=>t.category===c.id).reduce((a,b)=>a+b.amount,0)),backgroundColor:['#1a237e','#3949ab','#5c6bc0','#7986cb','#9fa8da','#c5cae9','#e8eaf6','#283593','#303f9f']}]},options:{plugins:{legend:{position:'bottom',labels:{boxWidth:12}}}}});

  const savCtx=document.getElementById('savingsChart').getContext('2d');
  if(savingsChart) savingsChart.destroy();
  const saved=store.transactions.filter(t=>t.category==='savings').reduce((a,b)=>a+b.amount,0);
  savingsChart=new Chart(savCtx,{type:'bar',data:{labels:['مدخرات'],datasets:[{label:'المبلغ',data:[saved],backgroundColor:'#1a237e'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true}}}});

  const dailyCtx=document.getElementById('dailyChart').getContext('2d');
  if(dailyChart) dailyChart.destroy();
  const days=[...Array(31).keys()].map(i=>i+1);
  const dailyTotals=days.map(d=>store.transactions.filter(t=>t.day===d).reduce((a,b)=>a+b.amount,0));
  dailyChart=new Chart(dailyCtx,{type:'bar',data:{labels:days,datasets:[{label:'مصروف اليوم',data:dailyTotals,backgroundColor:'#3f51b5'}]},options:{plugins:{legend:{display:false}},scales:{y:{beginAtZero:true
